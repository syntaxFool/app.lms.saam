# Role Management Architecture

## 3 Roles with Enforced Limits

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      USER ROLE HIERARCHY                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    SUPERUSER (1 max)
         â–²
         â”‚ Full System Access
         â”‚ â€¢ Create/delete all users
         â”‚ â€¢ Manage settings & config
         â”‚ â€¢ View all leads & reports
         â”‚ â€¢ Audit logs access
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                               â”‚
   ADMIN (5 max)                    â”‚
    â–²                               â”‚
    â”‚ Lead Management + Reports     â”‚
    â”‚ â€¢ Create/manage leads         â”‚ (Includes superuser abilities)
    â”‚ â€¢ Manage team members         â”‚
    â”‚ â€¢ View performance reports    â”‚
    â”‚ â€¢ Configure settings          â”‚
    â”‚                               â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                 â”‚
  AGENT (10 max)    USERS (unlimited)
    â”‚
    â”œâ”€ Lead Management only
    â”‚  â€¢ Assigned leads only
    â”‚  â€¢ Create/update tasks
    â”‚  â€¢ Log activities
    â”‚  â€¢ Limited reports
    â”‚
    â””â”€ Cannot:
       â€¢ Add/remove users
       â€¢ View other agents' leads
       â€¢ Access system settings
       â€¢ Delete leads
```

## Data Flow: User Creation with Role Limits

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER CREATES NEW USER (ADMIN ONLY)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  User Form UI   â”‚
    â”‚ Select Role     â”‚
    â”‚ + Details       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Frontend Validation      â”‚
    â”‚ canAddRole(role, users)  â”‚
    â”‚ âœ“ Loads all users        â”‚
    â”‚ âœ“ Counts by role         â”‚
    â”‚ âœ“ Compares to LIMITS     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
      â”‚ Allowed?    â”‚
      â””â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚     â”‚
        YES   NO
         â”‚     â”‚
         â–¼     â–¼
      Submit Error Message
       POST   "Max 5 admins"
        â”‚     "Current: 5/5"
        â”‚
        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Backend Validation      â”‚
    â”‚ validateUserRoleLimits() â”‚
    â”‚ âœ“ Re-validate all users  â”‚
    â”‚ âœ“ Check each role count  â”‚
    â”‚ âœ“ Prevent bypass attacks â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
      â”‚ Valid?      â”‚
      â””â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚     â”‚
        YES   NO
         â”‚     â”‚
         â–¼     â–¼
      Save  Return Error
      to    + Violations
      GAS   Details
       â”‚
       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Update Users Sheet       â”‚
    â”‚ + Log Activity           â”‚
    â”‚ + Return Success         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Role Limit Configuration

```typescript
// Frontend: src/stores/auth.ts
const ROLE_LIMITS: Record<UserRole, number> = {
  superuser: 1,      // ğŸ‘‘ One system admin
  admin: 5,          // ğŸ§‘â€ğŸ’¼ Up to 5 managers
  agent: 10,         // ğŸ‘¥ Up to 10 team members
  user: Infinity     // ğŸ‘¤ Unlimited basic users
}

// Backend: code.gs (Same config)
const ROLE_LIMITS = {
  superuser: 1,
  admin: 5,
  agent: 10,
  user: Infinity
}
```

## State Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AUTH STORE (Pinia)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  State:                                                     â”‚
â”‚  â€¢ user: AuthUser | null                                   â”‚
â”‚  â€¢ token: string                                           â”‚
â”‚  â€¢ permissions: Permission[]                              â”‚
â”‚                                                             â”‚
â”‚  Constants:                                                â”‚
â”‚  â€¢ ROLE_LIMITS: Record<UserRole, number>                  â”‚
â”‚                                                             â”‚
â”‚  Functions:                                                â”‚
â”‚  â€¢ getRoleStats(users)          â”€â”€â”                        â”‚
â”‚  â€¢ checkRoleLimits(role, users)  â”œâ”€â–º Called by components â”‚
â”‚  â€¢ getRoleLimitsDisplay(users)  â”€â”€â”˜                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–³                                      â”‚
          â”‚ (useAuthStore)                       â”‚
          â”‚                                      â”‚ (exports)
          â”‚                                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Components       â”‚            â”‚   Composable      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ User Management   â”‚            â”‚useRoleManagement()â”‚
    â”‚ Settings          â”‚            â”‚                   â”‚
    â”‚ Admin Panel       â”‚            â”‚ â€¢ canAddRole()    â”‚
    â”‚                   â”‚            â”‚ â€¢ getRoleLabel()  â”‚
    â”‚ (watch/computed)  â”‚            â”‚ â€¢ getRoleColor()  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ â€¢ getRoleIcon()   â”‚
                                      â”‚ â€¢ formatRoleStatsâ”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Permission Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Resource/Action â”‚Superuser â”‚ Admin  â”‚ Agent  â”‚  User    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Lead            â”‚          â”‚        â”‚        â”‚          â”‚
â”‚ â€¢ Create        â”‚    âœ“     â”‚   âœ“    â”‚   âœ“    â”‚    âœ—     â”‚
â”‚ â€¢ Read          â”‚    âœ“     â”‚   âœ“    â”‚ Own âœ“  â”‚ Own âœ“    â”‚
â”‚ â€¢ Update        â”‚    âœ“     â”‚   âœ“    â”‚ Own âœ“  â”‚ Own âœ“    â”‚
â”‚ â€¢ Delete        â”‚    âœ“     â”‚   âœ“    â”‚   âœ—    â”‚    âœ—     â”‚
â”‚ â€¢ Export        â”‚    âœ“     â”‚   âœ“    â”‚   âœ“    â”‚    âœ—     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Task            â”‚          â”‚        â”‚        â”‚          â”‚
â”‚ â€¢ Create        â”‚    âœ“     â”‚   âœ“    â”‚   âœ“    â”‚    âœ—     â”‚
â”‚ â€¢ Read          â”‚    âœ“     â”‚   âœ“    â”‚ Own âœ“  â”‚ Own âœ“    â”‚
â”‚ â€¢ Update        â”‚    âœ“     â”‚   âœ“    â”‚ Own âœ“  â”‚ Own âœ“    â”‚
â”‚ â€¢ Delete        â”‚    âœ“     â”‚   âœ“    â”‚   âœ—    â”‚    âœ—     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Activity        â”‚          â”‚        â”‚        â”‚          â”‚
â”‚ â€¢ Read          â”‚    âœ“     â”‚   âœ“    â”‚ Own âœ“  â”‚ Own âœ“    â”‚
â”‚ â€¢ Delete        â”‚    âœ“     â”‚   âœ—    â”‚   âœ—    â”‚    âœ—     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Report          â”‚          â”‚        â”‚        â”‚          â”‚
â”‚ â€¢ Read          â”‚    âœ“     â”‚   âœ“    â”‚   âœ“    â”‚    âœ—     â”‚
â”‚ â€¢ Export        â”‚    âœ“     â”‚   âœ“    â”‚   âœ—    â”‚    âœ—     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ User            â”‚          â”‚        â”‚        â”‚          â”‚
â”‚ â€¢ Create        â”‚    âœ“     â”‚   âœ—    â”‚   âœ—    â”‚    âœ—     â”‚
â”‚ â€¢ Read          â”‚    âœ“     â”‚   âœ“    â”‚   âœ—    â”‚    âœ—     â”‚
â”‚ â€¢ Update        â”‚    âœ“     â”‚ Self âœ“ â”‚ Self âœ“ â”‚ Self âœ“   â”‚
â”‚ â€¢ Delete        â”‚    âœ“     â”‚   âœ—    â”‚   âœ—    â”‚    âœ—     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Settings        â”‚          â”‚        â”‚        â”‚          â”‚
â”‚ â€¢ Read          â”‚    âœ“     â”‚   âœ“    â”‚   âœ—    â”‚    âœ—     â”‚
â”‚ â€¢ Update        â”‚    âœ“     â”‚   âœ“    â”‚   âœ—    â”‚    âœ—     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Role Limit Check Sequence

```
COMPONENT CALLS: canAddRole('admin', usersList)
â”‚
â”œâ”€â–º checkRoleLimits('admin', usersList)
â”‚   â”‚
â”‚   â”œâ”€â–º getRoleStats(usersList)
â”‚   â”‚   â””â”€â–º Count users by role
â”‚   â”‚       {superuser: 0, admin: 3, agent: 8, user: 5}
â”‚   â”‚
â”‚   â”œâ”€â–º Get limit for 'admin'
â”‚   â”‚   â””â”€â–º 5
â”‚   â”‚
â”‚   â”œâ”€â–º Compare current (3) vs limit (5)
â”‚   â”‚   â””â”€â–º 3 < 5 âœ“ ALLOWED
â”‚   â”‚
â”‚   â””â”€â–º Return
â”‚       {
â”‚         allowed: true,
â”‚         message: "2 slots remaining for admins",
â”‚         remainingSlots: 2,
â”‚         current: 3,
â”‚         limit: 5
â”‚       }
â”‚
â””â”€â–º Component UI Shows: âœ“ "Add Admin"
    Displays: "2 slots remaining"
```

## Error Handling

```
ATTEMPT TO ADD 6TH ADMIN
â”‚
â”œâ”€â–º Frontend: checkRoleLimits('admin', users) 
â”‚   â””â”€â–º { allowed: false, message: "Maximum 5 admins..." }
â”‚       Display error, block form submission
â”‚
â””â”€â–º IF BYPASS ATTEMPTED (API direct call)
    â”‚
    â”œâ”€â–º Backend: validateUserRoleLimits(users)
    â”‚   â””â”€â–º Detect count > limit
    â”‚       Return 400 error with violations
    â”‚
    â””â”€â–º GAS PREVENTS SAVE
        Users sheet not updated
        Error logged in audit trail
```

## Database Schema Impact

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Google Sheets Database           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                  â”‚
â”‚  Users Sheet                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ id | username | role | ... â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ su-001 | nox1 | superuser   â”‚ â”‚ â† 1/1 limit
â”‚  â”‚ ad-001 | john | admin       â”‚ â”‚
â”‚  â”‚ ad-002 | jane | admin       â”‚ â”‚
â”‚  â”‚ ad-003 | mike | admin       â”‚ â”‚ â† 3/5 slots used
â”‚  â”‚ ag-001 | alex | agent       â”‚ â”‚
â”‚  â”‚ ag-002 | bob  | agent       â”‚ â”‚
â”‚  â”‚ ... (up to 10 agents)         â”‚
â”‚  â”‚ us-001 | guest| user        â”‚ â”‚ â† unlimited
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                  â”‚
â”‚  Logs Sheet (Audit Trail)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ timestamp | action | user... â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ 2024-01-15 | add_user      â”‚ â”‚
â”‚  â”‚ (role_admin) | by nox1     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Implementation Summary

| Component | Status | Location |
|-----------|--------|----------|
| Role constants | âœ… Done | auth.ts, code.gs |
| Role stats function | âœ… Done | auth.ts, code.gs |
| Limit checker | âœ… Done | auth.ts, code.gs |
| Display formatter | âœ… Done | auth.ts, code.gs |
| Type definitions | âœ… Done | types/index.ts |
| Composable utils | âœ… Done | useRoleManagement.ts |
| Backend validation | âœ… Done | code.gs save_all |
| UI integration | â³ Next | Components |

