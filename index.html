<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4f46e5">
    <!-- Favicon - Yellow Pacman Ghost -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cpath d='M4 4h24v20c0 0-2-3-4-3s-2 3-4 3-2-3-4-3-2 3-4 3-2-3-4-3-2 3-4 3V4z' fill='%23FFD700'/%3E%3Ccircle cx='10' cy='12' r='2.5' fill='%23000'/%3E%3Ccircle cx='22' cy='12' r='2.5' fill='%23000'/%3E%3Ccircle cx='10' cy='11' r='1' fill='%23fff'/%3E%3Ccircle cx='22' cy='11' r='1' fill='%23fff'/%3E%3C/svg%3E">
    <!-- <meta name="apple-mobile-web-app-capable" content="yes"> -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LeadFlow India</title>
    <!-- Tailwind CSS v3.4.1 (Development CDN; for production use: npx tailwindcss -i input.css -o output.css --minify) -->
    <!-- Tailwind CSS v3 (Development CDN; for production use local build via: npx tailwindcss -i input.css -o output.css --minify) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons web -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Chart.js v4.4.0 (UMD minified) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* --- Native Feel Tweaks --- */
        body { -webkit-tap-highlight-color: transparent; touch-action: manipulation; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select, textarea { font-size: 16px !important; }
        #leadModal.open .modal-content, #logsModal.open .modal-content, #configModal.open .modal-content { transform: translateY(0); }
        .modal-content { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        #sideMenu.open .menu-panel { transform: translateX(0); }
        #sideMenu .menu-panel { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); transform: translateX(-100%); }
        .tab-active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
        .tab-inactive { color: #64748b; border-bottom: 2px solid transparent; }
        .timeline-line::before { content: ''; position: absolute; left: 1rem; top: 2rem; bottom: -1rem; width: 2px; background-color: #e2e8f0; z-index: 0; }
        .timeline-item:last-child .timeline-line::before { display: none; }
        #loginScreen { z-index: 100; }
        input[type="file"]::file-selector-button { display: none; }
        
        /* Loading Overlay */
        #loadingOverlay { z-index: 9999; animation: slideDown 0.3s ease-out forwards; }
        #loadingOverlay.hidden { animation: slideUp 0.3s ease-in forwards; }
        @keyframes slideDown {
            from { transform: translate(-50%, -120%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, -120%); opacity: 0; }
        }

        /* Table Styles */
        .table-row-hover:hover td { background-color: #f8fafc; }
        
        /* Autocomplete Styles */
        .interest-tag { transition: all 0.2s; }
        .interest-tag:hover { background-color: #e0e7ff; border-color: #c7d2fe; }
        .suggestions-box { 
            z-index: 50; 
            max-height: 200px; 
            overflow-y: auto; 
            position: absolute; 
            top: 100%; 
            left: 0; 
            width: 100%; 
            background: white; 
            border: 1px solid #e2e8f0; 
            border-radius: 0.75rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            margin-top: 4px; 
        }
        
        .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; color: #334155; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #f8fafc; color: #4f46e5; }

        @media (min-width: 768px) {
            .mobile-only { display: none !important; }
            .desktop-only { display: block !important; }
            .kanban-board { display: flex !important; overflow-x: auto; }
            .kanban-column { min-width: 320px; display: flex !important; }
        }
        @media (max-width: 767px) {
            .desktop-only { display: none !important; }
            .kanban-column { display: none; }
            .kanban-column.active-mobile { display: flex; }
            .modal-content { transform: translateY(100%); border-radius: 1.5rem 1.5rem 0 0; height: 90vh; margin-top: auto; }
            #appContent { padding-bottom: 80px; }
            main { padding-bottom: 0; }
            #mobileBottomNav { display: flex; }
            .mobile-fab-adjusted { bottom: 5.5rem !important; }
            #mobileBottomNav .active { background-color: #f1f5f9; color: #4f46e5; }
            #mobileBottomNav .active i { color: #4f46e5; }
            #fabMenu { animation: scaleIn 0.2s ease-out; }
            #fabMenu.hidden { display: none; }
            /* Better touch targets on mobile */
            button, a { min-height: 44px; min-width: 44px; }
            button > *, a > * { pointer-events: none; }
            
            /* Mobile Kanban Tabs - Pill Style */
            #kanbanTabs { padding: 0.75rem 1rem; background: white; border-bottom: 1px solid #f3f4f6; }
            #mobileTabs { display: flex; gap: 0.5rem; overflow-x: auto; -ms-overflow-style: none; scrollbar-width: none; }
            #mobileTabs::-webkit-scrollbar { display: none; }
            .mobile-tab-btn { background: white; border: 1px solid #e5e7eb; border-radius: 9999px !important; padding: 0.5rem 1.25rem !important; font-size: 0.875rem; font-weight: 600; color: #4b5563; white-space: nowrap; cursor: pointer; transition: all 0.2s ease; outline: none; border-bottom: none !important; }
            .mobile-tab-btn.active { background-color: #1f2937 !important; color: white !important; border-color: #1f2937 !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
            #kanbanView .mobile-tab-btn:hover { border-color: #d1d5db; }
            #kanbanView .mobile-tab-btn.active { background-color: #1f2937 !important; color: white !important; border-color: #1f2937 !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
            #kanbanView .mobile-tab-btn i { display: none !important; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8) translateY(10px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        

    </style>
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#4f46e5', secondary: '#64748b', } } } }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 h-[100dvh] w-full flex flex-col overflow-hidden">

    <!-- NOTIFICATION TRAY -->
    <div id="notificationTray" class="fixed z-[100] bg-blue-600 text-white px-4 sm:px-5 py-3 sm:py-3.5 rounded-lg sm:rounded-xl shadow-xl flex items-center gap-3 text-sm sm:text-sm font-semibold transition-all duration-300 opacity-0 pointer-events-none sm:max-w-sm md:max-w-md bottom-20 left-2 right-2 sm:bottom-auto sm:left-1/2 sm:-translate-x-1/2 sm:top-4">
        <i class="ph-bold ph-info text-lg sm:text-lg flex-shrink-0"></i>
        <span id="notificationMessage" class="flex-1 text-white break-words line-clamp-3 sm:line-clamp-none">You have a new lead assigned!</span>
        <button onclick="event.stopPropagation(); ui.hideNotification()" class="ml-auto text-white/70 hover:text-white active:text-white transition flex-shrink-0 p-2 sm:p-1.5 hover:bg-white/10 rounded-md touch-none cursor-pointer" aria-label="Close notification" type="button"><i class="ph-bold ph-x text-lg"></i></button>
    </div>

    <!-- LOADING OVERLAY -->
    <!-- Floating Sync Status Indicator -->
    <div id="loadingOverlay" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-indigo-600 to-indigo-700 rounded-full px-4 py-2 shadow-lg flex items-center gap-2 hidden z-50 transition-all duration-300 ease-in-out" style="min-width: 200px;">
        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
        <span class="text-white font-medium text-sm" id="loadingText">Syncing changes...</span>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="fixed inset-0 bg-slate-900 flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-2xl p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="inline-flex bg-primary/10 p-4 rounded-xl mb-4">
                    <svg width="48" height="48" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 4h24v20c0 0-2-3-4-3s-2 3-4 3-2-3-4-3-2 3-4 3-2-3-4-3-2 3-4 3V4z" fill="#FFD700"/>
                        <circle cx="10" cy="12" r="2.5" fill="#000"/>
                        <circle cx="22" cy="12" r="2.5" fill="#000"/>
                        <circle cx="10" cy="11" r="1" fill="#fff"/>
                        <circle cx="22" cy="11" r="1" fill="#fff"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-slate-800" id="loginTitle">LeadFlow</h1>
                <p class="text-slate-500 text-sm mt-1">Please sign in</p>
            </div>
            <form onsubmit="app.handleLogin(event)">
                <div class="space-y-4">
                    <div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Username / ID</label><input type="text" name="username" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition" required></div>
                    <div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Password</label><input type="password" name="password" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition" required></div>
                </div>
                <p id="loginError" class="text-red-500 text-sm mt-3 text-center hidden">Invalid credentials</p>
                <button type="submit" class="w-full bg-primary text-white font-bold text-lg py-3.5 rounded-xl shadow-lg shadow-primary/30 active:scale-[0.98] transition mt-8">Sign In</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="appContent" class="hidden h-full flex-col">
                <!-- NOTIFICATION CENTER DROPDOWN -->
                <div id="notificationBox" class="fixed top-16 right-4 z-[101] w-96 max-w-[calc(100vw-2rem)] bg-white border border-slate-200 rounded-2xl shadow-2xl hidden flex flex-col max-h-[500px]">
                    <!-- Header -->
                    <div class="flex justify-between items-center px-6 py-4 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-slate-0 shrink-0">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i class="ph-bold ph-bell-ringing text-green-600"></i> 
                            Notification Center
                        </h3>
                        <button onclick="ui.toggleNotificationBox()" class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg p-1 transition">
                            <i class="ph-bold ph-x text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- Notifications List -->
                    <div id="notificationList" class="flex-1 overflow-y-auto p-3 space-y-2 no-scrollbar">
                        <div id="notificationEmpty" class="text-slate-400 text-sm text-center py-12 flex flex-col items-center gap-2">
                            <i class="ph-bold ph-bell-slash text-3xl opacity-30"></i>
                            <span>No notifications yet</span>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="px-6 py-3 border-t border-slate-100 bg-slate-50 flex items-center gap-2 shrink-0">
                        <button onclick="app.clearAllNotifications()" class="flex-1 text-sm font-semibold text-slate-600 hover:text-slate-800 hover:bg-slate-200 py-2 px-3 rounded-lg transition">
                            Clear All
                        </button>
                        <button onclick="app.loadNotifications(); ui.updateNotificationBadge()" class="flex-1 text-sm font-semibold text-primary hover:bg-primary/10 py-2 px-3 rounded-lg transition">
                            Refresh
                        </button>
                    </div>
                </div>
        <header class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm z-20 shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="ui.toggleMenu(true)" class="p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-lg active:bg-slate-200 transition"><i class="ph-bold ph-list text-2xl"></i></button>
                <div class="flex items-center gap-2">
                    <div class="bg-primary/10 p-1.5 rounded-lg">
                        <svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 4h24v20c0 0-2-3-4-3s-2 3-4 3-2-3-4-3-2 3-4 3-2-3-4-3-2 3-4 3V4z" fill="#FFD700"/>
                            <circle cx="10" cy="12" r="2.5" fill="#000"/>
                            <circle cx="22" cy="12" r="2.5" fill="#000"/>
                            <circle cx="10" cy="11" r="1" fill="#fff"/>
                            <circle cx="22" cy="11" r="1" fill="#fff"/>
                        </svg>
                    </div>
                    <h1 id="appTitleDisplay" class="text-lg font-bold tracking-tight text-slate-900">LeadFlow</h1>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="currentUserDisplay" class="text-xs font-semibold text-slate-500 bg-slate-100 px-2 py-1 rounded hidden md:block"></span>
                <button onclick="ui.toggleNotificationBox()" class="p-2 text-green-600 hover:bg-green-50 rounded-full transition relative" title="Notifications">
                    <i class="ph-bold ph-bell text-xl"></i>
                    <span id="notificationCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 font-bold" style="display:none;">0</span>
                </button>
                <button onclick="app.sync()" class="p-2 text-blue-600 hover:bg-blue-50 rounded-full transition" title="Force Sync"><i class="ph-bold ph-arrows-clockwise text-xl"></i></button>
            </div>
        </header>

        <!-- Mobile Tabs -->
        <nav id="kanbanTabs" class="md:hidden bg-white border-b border-slate-200 py-2 overflow-x-auto no-scrollbar shrink-0 z-10"><div class="flex px-4 gap-3 min-w-max" id="mobileTabs"></div></nav>

        <!-- Main Content -->
        <main class="flex-1 overflow-hidden relative w-full">
            <div id="kanbanView" class="h-full w-full">
                <div class="kanban-board h-full w-full p-4 md:p-6 md:gap-6">
                    <div id="boardContainer" class="h-full w-full flex md:gap-6"></div>
                </div>
            </div>
            <div id="tableView" class="h-full w-full hidden overflow-auto bg-white">
                <div class="w-full p-3 sm:p-6">
                    <!-- Filter Bar -->
                    <div class="mb-4 p-4 bg-slate-50 border border-slate-200 rounded-lg">
                        <div class="flex items-center gap-3 mb-3">
                            <i class="ph-bold ph-funnel text-slate-600"></i>
                            <h4 class="font-semibold text-slate-700">Filters</h4>
                            <button onclick="app.clearFilters()" class="ml-auto text-sm text-slate-500 hover:text-slate-700 underline">Clear All</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <!-- Search -->
                            <div>
                                <label class="text-xs font-semibold text-slate-600 block mb-1">Search Name/Email/Phone</label>
                                <input type="text" id="filterSearch" placeholder="Type to search..." oninput="app.applyFilters()" class="w-full bg-white border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none">
                            </div>
                            <!-- Status Filter -->
                            <div>
                                <label class="text-xs font-semibold text-slate-600 block mb-1">Status</label>
                                <select id="filterStatus" onchange="app.applyFilters()" class="w-full bg-white border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none">
                                    <option value="">All Status</option>
                                    <option value="New">New</option>
                                    <option value="Contacted">Contacted</option>
                                    <option value="Proposal">Proposal</option>
                                    <option value="Won">Won</option>
                                    <option value="Lost">Lost</option>
                                </select>
                            </div>
                            <!-- Assigned To Filter -->
                            <div>
                                <label class="text-xs font-semibold text-slate-600 block mb-1">Assigned To</label>
                                <select id="filterAssignedTo" onchange="app.applyFilters()" class="w-full bg-white border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none">
                                    <option value="">All Agents</option>
                                </select>
                            </div>
                            <!-- Task Filters -->
                            <div>
                                <label class="text-xs font-semibold text-slate-600 block mb-2">Task Filters</label>
                                <div class="flex flex-col gap-1">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="filterNoTask" onchange="app.applyFilters()" class="w-4 h-4 rounded border-slate-300 cursor-pointer">
                                        <span class="text-sm text-slate-700">No Task (Pending)</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="filterNoAction" onchange="app.applyFilters()" class="w-4 h-4 rounded border-slate-300 cursor-pointer">
                                        <span class="text-sm text-slate-700">No Action (Empty)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Bulk Actions Bar -->
                    <div id="bulkActionsBar" class="hidden mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <i class="ph-bold ph-check-circle text-blue-600"></i>
                            <span id="selectedCount" class="font-semibold text-blue-700">0 selected</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <select id="bulkAssignSelect" class="bg-white border border-blue-300 rounded px-3 py-2 text-sm">
                                <option value="">Select agent to assign...</option>
                            </select>
                            <button onclick="app.bulkAssignLeads()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-semibold">Assign Selected</button>
                            <button id="bulkDeleteBtn" onclick="app.bulkDeleteLeads()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm font-semibold hidden">Delete Selected</button>
                            <button onclick="app.clearSelection()" class="bg-slate-300 hover:bg-slate-400 text-slate-700 px-4 py-2 rounded text-sm font-semibold">Clear</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto -mx-3 sm:mx-0">
                    <table class="w-full text-left border-collapse text-xs sm:text-sm">
                        <thead>
                            <tr class="border-b border-slate-200 bg-slate-50 text-slate-500 text-xs uppercase tracking-wider sticky top-0">
                                <th class="pb-2 sm:pb-3 font-bold pl-3 sm:pl-4"><input type="checkbox" id="selectAllCheckbox" onchange="app.toggleSelectAll(this.checked)" class="w-4 h-4 rounded"></th>
                                <th class="pb-2 sm:pb-3 font-bold pl-3 sm:pl-4 cursor-pointer hover:text-slate-700" onclick="app.sortTable('name')">Name <span id="sort-name" class="ml-1 hidden sm:inline"></span></th>
                                <th class="pb-2 sm:pb-3 font-bold px-2 sm:px-3 cursor-pointer hover:text-slate-700 hidden sm:table-cell" onclick="app.sortTable('phone')">Contact <span id="sort-phone" class="ml-1"></span></th>
                                <th class="pb-2 sm:pb-3 font-bold px-2 sm:px-3 cursor-pointer hover:text-slate-700" onclick="app.sortTable('status')">Status <span id="sort-status" class="ml-1 hidden sm:inline"></span></th>
                                <th class="pb-2 sm:pb-3 font-bold px-2 sm:px-3 cursor-pointer hover:text-slate-700 hidden md:table-cell" onclick="app.sortTable('lostReason')">Lost Reason <span id="sort-lostReason" class="ml-1"></span></th>
                                <th class="pb-2 sm:pb-3 font-bold px-2 sm:px-3 cursor-pointer hover:text-slate-700 hidden lg:table-cell" onclick="app.sortTable('interest')">Interest <span id="sort-interest" class="ml-1"></span></th>
                                <th class="pb-2 sm:pb-3 font-bold px-2 sm:px-3 cursor-pointer hover:text-slate-700 hidden lg:table-cell" onclick="app.sortTable('source')">Source <span id="sort-source" class="ml-1"></span></th>
                                <th class="pb-2 sm:pb-3 font-bold px-2 sm:px-3 cursor-pointer hover:text-slate-700 hidden sm:table-cell" onclick="app.sortTable('assignedTo')">Assigned <span id="sort-assignedTo" class="ml-1"></span></th>
                                <th class="pb-2 sm:pb-3 font-bold text-right px-2 sm:px-3 cursor-pointer hover:text-slate-700" onclick="app.sortTable('value')">Value <span id="sort-value" class="ml-1 hidden sm:inline"></span></th>
                                <th class="pb-2 sm:pb-3 font-bold w-10 px-2 sm:px-3"></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="text-xs sm:text-sm text-slate-700 divide-y divide-slate-100"></tbody>
                    </table>
                    </div>
                </div>
            </div>
            <div id="agentTableView" class="h-full w-full hidden overflow-hidden bg-white flex flex-col">
                <div class="p-4 sm:p-6 border-b border-slate-200 flex-none bg-white sticky top-0 z-20 shrink-0">
                    <h2 class="text-lg sm:text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="ph-bold ph-users text-blue-600"></i>
                        Agent Performance
                    </h2>
                </div>
                <div class="overflow-auto flex-1">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b border-slate-200 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-3 sm:p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider bg-slate-50">Agent</th>
                                <th class="p-3 sm:p-4 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider bg-slate-50">Leads</th>
                                <th class="p-3 sm:p-4 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider bg-slate-50">Won</th>
                                <th class="p-3 sm:p-4 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider bg-slate-50 hidden sm:table-cell">Conv. Rate</th>
                                <th class="p-3 sm:p-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider bg-slate-50">Revenue</th>
                            </tr>
                        </thead>
                        <tbody id="agentTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- Reports / Analytics Dashboard -->
            <div id="reportsView" class="h-full w-full hidden overflow-auto bg-slate-50">
                <div class="p-6 space-y-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-bold text-slate-800 mb-2">üìä Analytics Dashboard</h1>
                            <p class="text-slate-500">Pipeline performance, conversion metrics, and agent leaderboard</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-slate-600 font-medium">Filter by:</label>
                            <select id="dateFilterDropdown" class="px-4 py-2 border border-slate-300 rounded-lg bg-white text-slate-800 font-medium cursor-pointer hover:border-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="till-date">Till Date</option>
                                <option value="this-day">This Day</option>
                                <option value="this-week">This Week</option>
                                <option value="this-month">This Month</option>
                                <option value="this-year">This Year</option>
                            </select>
                        </div>
                    </div>

                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="kpiCardsContainer">
                        <!-- Populated by JavaScript -->
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Pipeline Funnel -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <h2 class="text-lg font-bold text-slate-800 mb-4">Pipeline Funnel</h2>
                            <canvas id="pipelineFunnelChart" height="250"></canvas>
                        </div>

                        <!-- Lost Reasons Analysis -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <h2 class="text-lg font-bold text-slate-800 mb-4">Why Leads Are Lost</h2>
                            <canvas id="lostReasonsChart" height="250"></canvas>
                        </div>
                    </div>

                    <!-- Lead Temperature Distribution -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h2 class="text-lg font-bold text-slate-800 mb-4">Lead Temperature Distribution</h2>
                        <canvas id="temperatureChart" height="100"></canvas>
                    </div>

                    <!-- Agent Leaderboard -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h2 class="text-lg font-bold text-slate-800 mb-4">üèÜ Agent Performance</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-slate-700">
                                <thead>
                                    <tr class="border-b border-slate-200 text-slate-500 text-xs uppercase tracking-wider">
                                        <th class="pb-3 font-bold text-left">Agent</th>
                                        <th class="pb-3 font-bold text-right">Assigned</th>
                                        <th class="pb-3 font-bold text-right">Won</th>
                                        <th class="pb-3 font-bold text-right">Lost</th>
                                        <th class="pb-3 font-bold text-right">Win Rate</th>
                                    </tr>
                                </thead>
                                <tbody id="agentLeaderboardBody" class="divide-y divide-slate-100">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- MOBILE BOTTOM NAVIGATION (hidden on desktop) -->
        <nav id="mobileBottomNav" class="fixed bottom-0 left-0 right-0 md:hidden bg-white border-t border-slate-200 px-2 py-2 flex justify-around items-center gap-1 z-40 h-20">
            <button onclick="app.switchViewMode('kanban'); ui.updateMobileNav()" id="navKanban" class="flex flex-col items-center justify-center gap-1 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-50 transition w-16">
                <i class="ph-bold ph-kanban text-2xl"></i>
                <span class="text-xs font-semibold">Board</span>
            </button>
            <button onclick="app.switchViewMode('table'); ui.updateMobileNav()" id="navTable" class="flex flex-col items-center justify-center gap-1 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-50 transition w-16">
                <i class="ph-bold ph-table text-2xl"></i>
                <span class="text-xs font-semibold">Leads</span>
            </button>
            <button onclick="app.switchViewMode('reports'); ui.updateMobileNav()" id="navReports" class="flex flex-col items-center justify-center gap-1 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-50 transition w-16">
                <i class="ph-bold ph-chart-bar text-2xl"></i>
                <span class="text-xs font-semibold">Reports</span>
            </button>
            <button onclick="ui.toggleMenu(true)" id="navMenu" class="flex flex-col items-center justify-center gap-1 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-50 transition w-16">
                <i class="ph-bold ph-gear text-2xl"></i>
                <span class="text-xs font-semibold">More</span>
            </button>
        </nav>

        <!-- FAB Button with menu (with padding to not overlap mobile nav) -->
        <div class="fixed bottom-6 right-6 md:bottom-8 md:right-8 mobile-fab-adjusted z-30">
            <!-- FAB Menu (hidden by default) -->
            <div id="fabMenu" class="absolute bottom-20 right-0 bg-white rounded-2xl shadow-2xl p-2 hidden flex-col gap-2 w-48">
                <button onclick="ui.toggleModal(true); document.getElementById('fabMenu').classList.add('hidden')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 flex items-center gap-3 transition text-slate-700">
                    <i class="ph-bold ph-plus text-lg text-primary"></i>
                    <span class="font-semibold text-sm">New Lead</span>
                </button>
                <button onclick="app.notify('Scan feature coming soon', 'info'); document.getElementById('fabMenu').classList.add('hidden')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 flex items-center gap-3 transition text-slate-700">
                    <i class="ph-bold ph-qr-code text-lg text-blue-600"></i>
                    <span class="font-semibold text-sm">Scan QR</span>
                </button>
                <button onclick="app.notify('Import feature coming soon', 'info'); document.getElementById('fabMenu').classList.add('hidden')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 flex items-center gap-3 transition text-slate-700">
                    <i class="ph-bold ph-upload-simple text-lg text-green-600"></i>
                    <span class="font-semibold text-sm">Import CSV</span>
                </button>
            </div>
            
            <!-- Primary FAB Button -->
            <button onclick="const menu = document.getElementById('fabMenu'); menu.classList.toggle('hidden')" class="bg-primary hover:bg-indigo-600 text-white w-14 h-14 rounded-full shadow-lg shadow-indigo-500/30 flex items-center justify-center transition transform active:scale-95 focus:outline-none" title="Quick actions">
                <i id="fabIcon" class="ph-bold ph-plus text-2xl"></i>
            </button>
        </div>
    </div>

    <!-- SIDE MENU -->
    <div id="sideMenu" class="fixed inset-0 z-[60] hidden" role="dialog">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="ui.toggleMenu(false)"></div>
        <div class="menu-panel absolute inset-y-0 left-0 w-[85%] max-w-sm bg-white shadow-2xl flex flex-col">
            <div class="p-6 border-b border-slate-100 bg-slate-50">
                <h2 class="text-2xl font-bold text-slate-800 mb-1">Menu</h2>
                <div class="flex items-center gap-2 text-sm text-slate-500"><i class="ph-fill ph-user"></i> <span id="menuUserName">User</span><span id="menuUserRole" class="text-xs bg-slate-200 px-1.5 py-0.5 rounded font-bold uppercase">Role</span></div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-6">
                <div>
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2"><i class="ph-bold ph-squares-four"></i> Views</h3>
                    <div class="space-y-1">
                        <button onclick="app.switchViewMode('kanban')" class="w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 hover:bg-slate-50 transition text-slate-700"><i class="ph-bold ph-kanban text-lg"></i> <span class="font-medium">Kanban Board</span></button>
                        <button onclick="app.switchViewMode('table')" class="w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 hover:bg-slate-50 transition text-slate-700"><i class="ph-bold ph-table text-lg"></i> <span class="font-medium">Leads Table</span></button>
                        <button id="agentTableBtn" style="display:none" onclick="app.switchViewMode('agentTable')" class="w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 hover:bg-slate-50 transition text-slate-700"><i class="ph-bold ph-users text-lg"></i> <span class="font-medium">Agent Table</span></button>
                        <button id="reportsBtn" style="display:none" onclick="app.switchViewMode('reports')" class="w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 hover:bg-slate-50 transition text-slate-700"><i class="ph-bold ph-chart-bar text-lg"></i> <span class="font-medium">Reports</span></button>
                    </div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2"><i class="ph-bold ph-calendar-check"></i> Follow Ups</h3>
                        <select id="followUpAgentFilter" style="display:none" onchange="app.renderFollowUps()" class="bg-white border border-slate-200 rounded px-2 py-1 text-xs text-slate-600 focus:ring-2 focus:ring-primary outline-none">
                            <option value="">All Agents</option>
                        </select>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-red-50 rounded-xl border border-red-100 overflow-hidden"><div class="px-4 py-3 bg-red-100/50 flex justify-between items-center border-b border-red-100"><span class="text-red-800 font-bold text-sm">Overdue</span><span id="count-overdue" class="bg-white text-red-600 text-xs font-bold px-2 py-0.5 rounded-full shadow-sm">0</span></div><div id="list-overdue" class="divide-y divide-red-100"></div></div>
                        <div class="bg-amber-50 rounded-xl border border-amber-100 overflow-hidden"><div class="px-4 py-3 bg-amber-100/50 flex justify-between items-center border-b border-amber-100"><span class="text-amber-800 font-bold text-sm">Today</span><span id="count-today" class="bg-white text-amber-600 text-xs font-bold px-2 py-0.5 rounded-full shadow-sm">0</span></div><div id="list-today" class="divide-y divide-amber-100"></div></div>
                        <div class="bg-blue-50 rounded-xl border border-blue-100 overflow-hidden"><div class="px-4 py-3 bg-blue-100/50 flex justify-between items-center border-b border-blue-100"><span class="text-blue-800 font-bold text-sm">Upcoming</span><span id="count-upcoming" class="bg-white text-blue-600 text-xs font-bold px-2 py-0.5 rounded-full shadow-sm">0</span></div><div id="list-upcoming" class="divide-y divide-blue-100 max-h-60 overflow-y-auto"></div></div>
                    </div>
                </div>
                <div id="adminSysSection" style="display:none">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2"><i class="ph-bold ph-gear"></i> Admin SYS</h3>
                    <div class="space-y-1">
                        <button onclick="ui.toggleLogs(true); ui.toggleMenu(false)" class="w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 hover:bg-slate-50 transition text-slate-700"><i class="ph-bold ph-scroll text-lg"></i> <span class="font-medium">Session Logs</span></button>
                        <button onclick="ui.toggleConfig(true); ui.toggleMenu(false)" class="w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 hover:bg-slate-50 transition text-slate-700"><i class="ph-bold ph-user-gear text-lg"></i> <span class="font-medium">SYS Config</span></button>
                    </div>
                </div>
                <div>
                    <div id="settingsSection"></div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 text-center"><button onclick="app.logout()" class="text-red-500 font-bold text-sm hover:text-red-600 flex items-center justify-center gap-2 w-full py-2"><i class="ph-bold ph-sign-out"></i> Sign Out</button></div>
            <div class="p-4 border-t border-slate-100 text-center">
                <p class="text-xs text-slate-400">Made With <span class="text-red-500">‚ù§Ô∏è</span> By <a href="syntaxfoolcard.html" target="_blank" class="font-semibold text-slate-600 hover:text-slate-800 hover:underline transition">syntaxfool</a></p>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div id="logsModal" class="fixed inset-0 z-[70] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="ui.toggleLogs(false)"></div>
        <div class="modal-content absolute inset-x-0 bottom-0 md:relative md:inset-auto md:m-auto w-full md:w-[480px] md:h-[85vh] md:max-h-[800px] md:rounded-2xl bg-white shadow-2xl flex flex-col">
            <!-- Mobile Back Button (only) -->
            <button type="button" onclick="ui.toggleLogs(false)" class="absolute top-4 left-4 md:hidden flex items-center justify-center w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 focus:outline-none z-10">
                <i class="ph-bold ph-arrow-left text-xl text-primary"></i>
            </button>
            <div class="md:hidden w-full flex justify-center pt-3 pb-1" onclick="ui.toggleLogs(false)"><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
            <div class="px-6 py-4 border-b border-slate-100 shrink-0 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="ph-bold ph-scroll text-primary"></i> Session Logs</h3>
                <!-- Desktop Back Button (only) -->
                <button onclick="ui.toggleLogs(false)" class="hidden md:block p-1 text-slate-400 hover:text-slate-600 bg-slate-100 rounded-full"><i class="ph-bold ph-arrow-left text-lg"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-0 bg-slate-50/50"><div id="logsContainer" class="divide-y divide-slate-100"></div></div>
        </div>
    </div>

    <!-- User Config / Management Modal -->
    <div id="configModal" class="fixed inset-0 z-[70] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="ui.toggleConfig(false)"></div>
        <div class="modal-content absolute inset-x-0 bottom-0 md:relative md:inset-auto md:m-auto w-full md:w-[480px] md:h-auto md:max-h-[90vh] md:rounded-2xl bg-white shadow-2xl flex flex-col">
            <!-- Mobile Exit Button (only) -->
            <button type="button" onclick="ui.toggleConfig(false)" class="absolute top-4 right-4 md:hidden flex items-center justify-center w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 focus:outline-none z-10">
                <i class="ph-bold ph-x text-xl text-primary"></i>
            </button>
            <div class="md:hidden w-full flex justify-center pt-3 pb-1" onclick="ui.toggleConfig(false)"><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
            <div class="px-6 py-4 border-b border-slate-100 shrink-0 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="ph-bold ph-user-gear text-primary"></i> SYS Config</h3>
                <!-- Desktop Exit Button (only) -->
                <button onclick="ui.toggleConfig(false)" class="hidden md:block p-1 text-slate-400 hover:text-slate-600 bg-slate-100 rounded-full"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="mb-8"><h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Database</h4><form onsubmit="app.handleSaveAppConfig(event)"><div class="space-y-3"><div><label class="block text-xs font-semibold text-slate-500 mb-1">Script URL</label><input type="text" name="dbUrl" id="configDbUrl" class="w-full bg-slate-50 border-slate-200 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none" readonly></div><div><label class="block text-xs font-semibold text-slate-500 mb-1">App Name</label><input type="text" name="appTitle" id="configAppTitle" class="w-full bg-slate-50 border-slate-200 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none"></div><button type="submit" class="w-full bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-700">Save & Sync</button></div></form></div>
                <div class="mb-8 p-4 bg-slate-50 rounded-xl border border-slate-200"><h4 class="text-sm font-bold text-slate-800 mb-3 flex justify-between">Add User <span id="userLimitMsg" class="text-xs font-normal text-slate-500"></span></h4><form onsubmit="app.handleAddUser(event)"><div class="grid grid-cols-2 gap-3 mb-3"><input type="text" name="newUsername" placeholder="ID (ABC123)" required class="w-full bg-white border-slate-200 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none"><input type="password" name="newPassword" placeholder="Pwd (4 digits)" required class="w-full bg-white border-slate-200 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none"></div><div class="grid grid-cols-2 gap-3 mb-3"><input type="text" name="newName" placeholder="Name (CAPS max 15)" required class="w-full bg-white border-slate-200 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none"><select name="newRole" class="w-full bg-white border-slate-200 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none"><option value="agent">Agent</option><option value="admin">Admin</option></select></div><button type="submit" class="w-full bg-primary text-white font-bold py-2 rounded-lg text-sm hover:bg-indigo-600 transition shadow-sm">Create User</button></form></div>
                <div><h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Users</h4><div id="userListContainer" class="space-y-3"></div></div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Lead Modal -->
    <div id="leadModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="ui.toggleModal(false)"></div>
        <div class="modal-content absolute inset-x-0 bottom-0 md:relative md:inset-auto md:m-auto w-full md:w-[480px] md:h-[85vh] md:max-h-[800px] md:rounded-2xl bg-white shadow-2xl flex flex-col">
            <!-- Mobile Exit Button (only) -->
            <button type="button" onclick="ui.toggleModal(false)" class="absolute top-4 right-4 md:hidden flex items-center justify-center w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 focus:outline-none z-10">
                <i class="ph-bold ph-x text-xl text-primary"></i>
            </button>
            <div class="md:hidden w-full flex justify-center pt-3 pb-1" onclick="ui.toggleModal(false)"><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
            <div class="px-6 pt-4 pb-0 border-b border-slate-100 shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-xl font-bold text-slate-800">New Lead</h3>
                    <!-- Desktop Exit Button (only) -->
                    <button onclick="ui.toggleModal(false)" class="hidden md:block p-1 text-slate-400 hover:text-slate-600 bg-slate-100 rounded-full"><i class="ph-bold ph-x text-lg"></i></button>
                </div>
                <div class="flex gap-6 overflow-x-auto no-scrollbar"><button onclick="app.switchModalTab('info')" id="tab-btn-info" class="tab-active pb-3 font-semibold text-sm transition-colors whitespace-nowrap">Info</button><button onclick="app.switchModalTab('activity')" id="tab-btn-activity" class="tab-inactive pb-3 font-semibold text-sm transition-colors disabled:opacity-30 disabled:cursor-not-allowed whitespace-nowrap">Activity</button><button onclick="app.switchModalTab('task')" id="tab-btn-task" class="tab-inactive pb-3 font-semibold text-sm transition-colors disabled:opacity-30 disabled:cursor-not-allowed whitespace-nowrap">Task</button><button onclick="app.switchModalTab('contact')" id="tab-btn-contact" class="tab-inactive pb-3 font-semibold text-sm transition-colors disabled:opacity-30 disabled:cursor-not-allowed whitespace-nowrap">Contact</button></div>
            </div>
            <div class="flex-1 overflow-y-auto relative bg-slate-50/50">
                <div id="view-info" class="p-6">
                    <form id="leadForm" onsubmit="app.handleFormSubmit(event)">
                        <input type="hidden" name="leadId" id="leadIdInput">
                        <div class="space-y-5">
                            <div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Lead Name</label><input type="text" name="name" required class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition" placeholder="e.g. Acme Corp"></div>
                            
                            <!-- INTEREST (Autocomplete + Tags) -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">Interest</label>
                                <div class="relative">
                                    <input type="text" id="interestInput" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition" placeholder="Search or add interest..." autocomplete="off">
                                    <div id="interestSuggestions" class="suggestions-box hidden"></div>
                                </div>
                                <div id="interestTags" class="flex flex-wrap gap-2 mt-2"></div>
                                <input type="hidden" name="interest" id="interestHidden">
                            </div>

                            <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Value</label><div class="relative"><span class="absolute left-4 top-3.5 text-slate-400">‚Çπ</span><input type="number" name="value" id="leadValue" min="0" step="0.01" class="w-full bg-white border-slate-200 border rounded-xl pl-8 pr-4 py-3 focus:ring-2 focus:ring-primary outline-none" placeholder="0"></div></div><div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Status</label><select name="status" id="formStatusSelect" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none appearance-none"></select></div></div>
                            
                            <!-- LOST REASON (Conditional Display) -->
                            <div id="lostReasonDisplay" class="hidden p-4 bg-red-50 border border-red-200 rounded-xl">
                                <label class="block text-sm font-semibold text-red-800 mb-2">‚ùå Reason for Loss</label>
                                <p id="lostReasonText" class="text-sm text-red-700 font-medium"></p>
                            </div>
                            
                            <!-- TEMPERATURE (Manual) -->
                            <div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Temperature</label><select name="temperature" id="temperatureSelect" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none appearance-none"><option value="">Not Set</option><option value="Hot">üî¥ Hot</option><option value="Warm">üü† Warm</option><option value="Cold">üîµ Cold</option></select></div>
                            
                            <!-- LOCATION (Autocomplete) -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">Location</label>
                                <div class="relative">
                                    <input type="text" name="location" id="locationInput" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition" placeholder="City, Area..." autocomplete="off">
                                    <div id="locationSuggestions" class="suggestions-box hidden"></div>
                                </div>
                            </div>
                            
                            <!-- SOURCE (Autocomplete) -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">Lead Source</label>
                                <div class="relative">
                                    <input type="text" name="source" id="sourceInput" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition" placeholder="e.g. LinkedIn, Referral..." autocomplete="off">
                                    <div id="sourceSuggestions" class="suggestions-box hidden"></div>
                                </div>
                            </div>
                            
                            <div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Assigned To</label>
                                <select name="assignedTo" id="assignedToSelect" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition">
                                    <option value="">Select User</option>
                                </select>
                                <div id="assignedToDisplay" class="hidden w-full bg-slate-50 border-slate-200 border rounded-xl px-4 py-3 text-slate-700 font-medium">Unassigned</div>
                            </div>
                            <div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Contact Details</label><input type="email" name="email" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 mb-3 focus:ring-2 focus:ring-primary outline-none" placeholder="Email"><div class="relative flex items-stretch"><input type="text" name="phonePrefix" class="w-16 bg-slate-100 border-y border-l border-slate-200 rounded-l-xl text-center text-slate-700 font-medium text-sm focus:ring-2 focus:ring-primary focus:z-10 outline-none transition" value="+91" placeholder="+91"><input type="tel" name="phone" class="flex-1 bg-white border border-slate-200 rounded-r-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition" placeholder="98765 43210" pattern="\d{10}" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10)"></div></div>
                            <div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Notes</label><textarea name="notes" rows="3" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none resize-none"></textarea></div>
                        </div>
                    </form>
                </div>
                <div id="view-activity" class="hidden p-6"><div id="activityTimeline" class="space-y-0"></div></div>
                <div id="view-task" class="hidden p-6"><div id="taskList" class="space-y-3"></div></div>
                <div id="view-contact" class="hidden p-6 h-full"><div id="contactActions" class="h-full flex flex-col justify-center items-center gap-6"></div></div>
            </div>
            <div id="modalFooter" class="p-4 border-t border-slate-100 shrink-0 md:rounded-b-2xl bg-white pb-8 md:pb-4">
                <div id="footer-info"><button id="submitBtn" type="button" onclick="document.getElementById('leadForm').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}))" class="w-full bg-primary text-white font-bold text-lg py-3.5 rounded-xl shadow-lg shadow-primary/30 active:scale-[0.98] transition">Save Lead</button></div>
                <div id="footer-activity" class="hidden"></div>
                <div id="footer-task" class="hidden">
                    <form onsubmit="app.handleAddTask(event)" class="flex flex-col gap-2 mb-4">
                        <div class="relative">
                            <input type="text" id="taskInput" placeholder="Task title..." required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary text-sm">
                            <div id="taskSuggestions" class="suggestions-box hidden"></div>
                        </div>
                        <div class="relative">
                            <textarea id="taskNote" placeholder="Task note (max 15 words)..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary text-sm resize-none h-12" onkeyup="app.validateTaskNoteLength(this)"></textarea>
                            <span id="taskNoteCount" class="absolute bottom-2 right-3 text-xs text-slate-400">0/15</span>
                        </div>
                        <div class="flex gap-2">
                            <input type="date" id="taskDueDate" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary text-sm">
                            <button type="submit" class="bg-slate-800 text-white rounded-xl px-4 py-3 hover:bg-slate-700 active:scale-95 transition shadow-sm font-medium text-sm"><i class="ph-bold ph-plus"></i> Add</button>
                        </div>
                    </form>
                    <div id="taskDetailForm" class="hidden flex flex-col gap-3 p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 id="taskDetailTitle" class="font-semibold text-slate-700"></h3>
                            <button type="button" onclick="app.closeTaskDetail()" class="text-slate-400 hover:text-slate-600"><i class="ph-bold ph-x text-lg"></i></button>
                        </div>
                        <div id="taskDetailInfo" class="text-sm text-slate-600 space-y-1"></div>
                        <textarea id="taskNoteBox" placeholder="Add a note..." class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-primary resize-none h-20"></textarea>
                        <div class="flex gap-2">
                            <button type="button" onclick="app.updateTaskStatus('completed')" class="flex-1 bg-green-500 text-white rounded-lg px-3 py-2 hover:bg-green-600 active:scale-95 transition font-medium text-sm"><i class="ph-bold ph-check mr-1"></i>Complete</button>
                            <button type="button" onclick="app.updateTaskStatus('dropped')" class="flex-1 bg-red-500 text-white rounded-lg px-3 py-2 hover:bg-red-600 active:scale-95 transition font-medium text-sm"><i class="ph-bold ph-x mr-1"></i>Drop</button>
                            <button type="button" onclick="app.saveTaskNote()" class="flex-1 bg-primary text-white rounded-lg px-3 py-2 hover:bg-primary/90 active:scale-95 transition font-medium text-sm"><i class="ph-bold ph-floppy-disk mr-1"></i>Save</button>
                        </div>
                    </div>
                </div>
                <div id="footer-contact" class="hidden"></div>
            </div>
        </div>
    </div>

    <!-- Lost Reason Modal -->
    <div id="lostReasonModal" class="fixed inset-0 z-50 hidden flex items-center justify-center" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-96 p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Why Was This Lead Lost?</h3>
            <p class="text-sm text-slate-600 mb-6">Select a reason and enter details about why this lead was lost.</p>
            
            <div class="space-y-3 mb-6">
                <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition">
                    <input type="radio" name="lostReason" value="Price too high" class="w-4 h-4 text-primary" onchange="app.showLostReasonDetails()">
                    <span class="ml-3 text-sm text-slate-700 font-medium">üí∞ Price too high</span>
                </label>
                <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition">
                    <input type="radio" name="lostReason" value="Not interested" class="w-4 h-4 text-primary" onchange="app.showLostReasonDetails()">
                    <span class="ml-3 text-sm text-slate-700 font-medium">üòï Not interested</span>
                </label>
                <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition">
                    <input type="radio" name="lostReason" value="Competitor" class="w-4 h-4 text-primary" onchange="app.showLostReasonDetails()">
                    <span class="ml-3 text-sm text-slate-700 font-medium">üèÜ Chose competitor</span>
                </label>
                <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition">
                    <input type="radio" name="lostReason" value="Invalid Number" class="w-4 h-4 text-primary" onchange="app.showLostReasonDetails()">
                    <span class="ml-3 text-sm text-slate-700 font-medium">üìû Invalid number</span>
                </label>
                <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition">
                    <input type="radio" name="lostReason" value="Duplicate" class="w-4 h-4 text-primary" onchange="app.showLostReasonDetails()">
                    <span class="ml-3 text-sm text-slate-700 font-medium">üîÑ Duplicate lead</span>
                </label>
                <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition">
                    <input type="radio" name="lostReason" value="Other" class="w-4 h-4 text-primary" onchange="app.showLostReasonDetails()">
                    <span class="ml-3 text-sm text-slate-700 font-medium">üìù Other reason</span>
                </label>
            </div>

            <!-- Reason details input (hidden by default) -->
            <div id="customReasonContainer" class="hidden mb-6">
                <label class="block text-sm font-semibold text-slate-700 mb-2">üìã Enter details about this reason:</label>
                <textarea id="customReasonInput" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-primary outline-none resize-none" rows="3" placeholder="Explain why the lead was lost..."></textarea>
            </div>
            
            <div class="flex gap-3">
                <button type="button" onclick="app.closeLostReasonModal()" class="flex-1 bg-slate-200 text-slate-700 font-bold py-2.5 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                <button type="button" onclick="app.confirmLostReason()" class="flex-1 bg-primary text-white font-bold py-2.5 rounded-lg hover:bg-indigo-600 transition">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        class LeadStore {
            constructor() {
                this.subscribers = [];
                this.STORAGE_KEY = 'LEAD_FLOW_DB_V27'; 
                const data = this.loadLocal();
                this.state = data.leads || [];
                this.logs = data.logs || [];
                this.config = data.config || { appTitle: 'LeadFlow', dbUrl: '' };
                // Hardcode the Script URL
                this.config.dbUrl = 'https://script.google.com/macros/s/AKfycbxevXBoOPZkOq82wHla6WKrOiGhnrNM7FXKtHmeItMOnUp0vBOYF13lcBRAE3Gtfw/exec';
                this.users = data.users || [];
                this.interests = data.interests || []; 
                this.settings = data.settings || { locations: [], sources: [], taskTitles: [] };
                
                if (this.users.length === 0) {
                    this.users.push({ id: 'super-01', username: 'nox1', password: '1233', role: 'superuser', name: 'Super User' });
                    this.saveLocal();
                }
            }

            subscribe(callback) { this.subscribers.push(callback); }
            notify() { this.subscribers.forEach(cb => cb(this.state)); }
            generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
            loadLocal() { try { return JSON.parse(localStorage.getItem(this.STORAGE_KEY)) || {}; } catch(e) { return {}; } }
            
            saveLocal() {
                const data = { leads: this.state, logs: this.logs, config: this.config, users: this.users, interests: this.interests, settings: this.settings };
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
                this.notify();
            }

            async syncWithCloud() {
                if (!this.config.dbUrl) return;
                ui.showLoading(true, 'üì• Downloading updates...');
                try {
                    // Support differential sync: pass lastSyncTime to get only changed leads
                    const lastSyncTime = this.lastSyncTime || 0;
                    const url = lastSyncTime > 0 
                        ? `${this.config.dbUrl}?lastSyncTime=${lastSyncTime}`
                        : this.config.dbUrl;
                    
                    const response = await fetch(url, { 
                        method: 'GET', 
                        redirect: 'follow', 
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    if (!response.ok) throw new Error('Network response was not ok');
                    const cloudData = await response.json();
                    
                    // Differential sync: merge received leads instead of replacing entire state
                    if (cloudData.leads && cloudData.leads.length > 0) {
                        if (lastSyncTime > 0) {
                            // Merge: update or add only the received leads
                            cloudData.leads.forEach(remoteLead => {
                                const existingIdx = this.state.findIndex(l => l.id === remoteLead.id);
                                if (existingIdx !== -1) {
                                    this.state[existingIdx] = remoteLead;
                                } else {
                                    this.state.push(remoteLead);
                                }
                            });
                        } else {
                            // Full sync: replace entire state (first sync)
                            this.state = cloudData.leads;
                        }
                    }
                    
                    if (cloudData.users && cloudData.users.length > 0) this.users = cloudData.users;
                    if (cloudData.logs) this.logs = cloudData.logs;
                    if (cloudData.interests) this.interests = cloudData.interests;
                    if (cloudData.settings) this.settings = cloudData.settings; 
                    // Debug: log what we get from backend
                    console.log('Backend config:', cloudData.config);
                    // Always sync appTitle from backend config if present
                    if (cloudData.config && cloudData.config.appTitle) this.config.appTitle = cloudData.config.appTitle;
                    // Capture server time for real-time sync
                    if (cloudData.serverTime) {
                        this.lastSyncTime = cloudData.serverTime; // Store for next differential sync
                        if (window.app) window.app.lastSyncTime = cloudData.serverTime;
                        if (window.app) window.app.lastServerUpdate = cloudData.lastUpdate || 0;
                    }
                    this.saveLocal();
                    if(window.app && typeof window.app.applyConfig==='function'){window.app.applyConfig();}
                    if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
                } catch (e) { 
                    console.warn("Cloud sync unavailable, using local data:", e.message); 
                } finally { 
                    ui.showLoading(false); 
                }
            }
            async pushToCloud() {
                if (!this.config.dbUrl) return;
                ui.showLoading(true, 'üì§ Uploading changes...');
                try {
                    const payload = { action: 'save_all', leads: this.state, users: this.users, logs: this.logs, config: this.config };
                    await fetch(this.config.dbUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
                    console.log('Data pushed to cloud successfully');
                } catch (e) { 
                    console.warn("Cloud sync unavailable, data saved locally:", e.message); 
                } finally { 
                    ui.showLoading(false); 
                }
            }
            save() { this.saveLocal(); this.pushToCloud(); }
            getCounts() { return { admins: this.users.filter(u => u.role === 'admin').length, agents: this.users.filter(u => u.role === 'agent').length }; }
            addUser(user) { this.users.push({id: this.generateId(), ...user}); this.save(); }
            deleteUser(id) { const u = this.users.find(x => x.id === id); if (u && u.role === 'superuser') return false; this.users = this.users.filter(x => x.id !== id); this.save(); return true; }
            async saveConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
                this.saveLocal();
                // Push appTitle to backend via dedicated action
                if (this.config.dbUrl && this.config.appTitle) {
                    try {
                        await fetch(this.config.dbUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({ action: 'save_script_url', appTitle: this.config.appTitle })
                        });
                    } catch (e) { console.error('AppTitle sync failed', e); }
                }
                await this.pushToCloud();
                if (this.config.dbUrl) await this.syncWithCloud();
            }
            log(msg, user) { const prefix = user ? `${user.name} (${user.role}): ` : 'System: '; this.logs.unshift({ id: this.generateId(), timestamp: new Date().toISOString(), message: prefix + msg }); if (this.logs.length > 50) this.logs.pop(); this.save(); }
            add(data, user) {
                const now = new Date().toISOString();
                const newLead = { id: this.generateId(), createdAt: now, updatedAt: now, activities: [], ...data };
                this.state.push(newLead);
                this.log(`Created lead ${data.name}`, user);
                
                // Log activity if lead is assigned on creation
                if (data.assignedTo) {
                    const agentName = window.app ? window.app.getUserName(data.assignedTo) : data.assignedTo;
                    newLead.activities.push({
                        id: this.generateId(),
                        type: 'assignment',
                        note: `Lead created and assigned to ${agentName}`,
                        timestamp: new Date().toISOString(),
                        createdBy: user ? user.name : 'System',
                        role: user ? user.role : ''
                    });
                }
                
                this.save();
                if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
            }
            update(id, data, user) {
                const idx = this.state.findIndex(l => l.id === id);
                if (idx !== -1) {
                    const oldLead = this.state[idx];
                    this.state[idx] = { ...this.state[idx], ...data, updatedAt: new Date().toISOString() };
                    this.log(`Updated ${data.name}`, user);
                    
                    // Log activity if assignment changed
                    if (oldLead.assignedTo !== data.assignedTo) {
                        const oldAgent = oldLead.assignedTo ? (window.app ? window.app.getUserName(oldLead.assignedTo) : oldLead.assignedTo) : 'Unassigned';
                        const newAgent = data.assignedTo ? (window.app ? window.app.getUserName(data.assignedTo) : data.assignedTo) : 'Unassigned';
                        
                        if (!this.state[idx].activities) this.state[idx].activities = [];
                        this.state[idx].activities.unshift({
                            id: this.generateId(),
                            type: 'assignment',
                            note: `Lead reassigned from ${oldAgent} to ${newAgent}`,
                            timestamp: new Date().toISOString(),
                            createdBy: user ? user.name : 'System',
                            role: user ? user.role : ''
                        });
                    }
                    
                    this.save();
                    if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
                }
            }
            delete(id, user) {
                const l = this.state.find(x => x.id === id);
                this.state = this.state.filter(x => x.id !== id);
                this.log(`Deleted ${l ? l.name : 'Lead'}`, user);
                this.save();
                if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
            }
            updateStatus(id, status, user) {
                const l = this.state.find(x => x.id === id);
                if (l) {
                    l.status = status;
                    l.updatedAt = new Date().toISOString();
                    this.log(`Moved ${l.name} to ${status}`, user);
                    this.save();
                    if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
                }
            }
            addActivity(id, activity, user) {
                const l = this.state.find(x => x.id === id);
                if (l) {
                    if(!l.activities) l.activities = [];
                    l.activities.unshift({ id: this.generateId(), timestamp: new Date().toISOString(), createdBy: user ? user.name : 'System', role: user ? user.role : '', ...activity });
                    l.updatedAt = new Date().toISOString();
                    this.log(`Logged activity for ${l.name}`, user);
                    this.save();
                    if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
                }
            }
            reset() { this.state = []; this.logs = []; this.save(); }
        }

        class App {
                                                                                                                        // Adaptive Polling Configuration
                                                                                                                        activePollRate = 5000;      // 5 seconds when active
                                                                                                                        idlePollRate = 40000;       // 40 seconds when idle
                                                                                                                        idleThreshold = 60000;      // 60 seconds of inactivity triggers idle mode
                                                                                                                        currentPollRate = 5000;     // Start in active mode
                                                                                                                        lastActivityTime = Date.now();
                                                                                                                        pollingTimer = null;
                                                                                                                        isIdle = false;
                                                                                                                        
                                                                                                                        // Network error handling
                                                                                                                        consecutiveNetworkErrors = 0;
                                                                                                                        maxNetworkErrors = 5;
                                                                                                                        networkErrorBackoffMultiplier = 1.5;
                                                                                                                        
                                                                                                                        addNotification(msg, type = 'info') {
                                                                                                                            if (!this._notifications) this._notifications = [];
                                                                                                                            const timestamp = new Date();
                                                                                                                            this._notifications.unshift({ 
                                                                                                                                msg, 
                                                                                                                                type,
                                                                                                                                ts: this.formatDateTime(timestamp.toISOString()),
                                                                                                                                fullTs: this.formatDateTime(timestamp.toISOString())
                                                                                                                            });
                                                                                                                            if (this._notifications.length > 20) this._notifications.pop();
                                                                                                                            this.renderNotificationBox();
                                                                                                                            this.saveNotifications();
                                                                                                                            if (ui && ui.updateNotificationBadge) ui.updateNotificationBadge();
                                                                                                                        }

                                                                                                                        renderNotificationBox() {
                                                                                                                            const list = document.getElementById('notificationList');
                                                                                                                            const count = document.getElementById('notificationCount');
                                                                                                                            if (!this._notifications || this._notifications.length === 0) {
                                                                                                                                list.innerHTML = `<div id="notificationEmpty" class="text-slate-400 text-sm text-center py-12 flex flex-col items-center gap-2">
                                                                                                                                    <i class="ph-bold ph-bell-slash text-3xl opacity-30"></i>
                                                                                                                                    <span>No notifications yet</span>
                                                                                                                                </div>`;
                                                                                                                                if (count) count.style.display = 'none';
                                                                                                                                return;
                                                                                                                            }
                                                                                                                            
                                                                                                                            const typeConfig = {
                                                                                                                                success: { bg: 'bg-green-50', border: 'border-green-200', icon: 'ph-check-circle', text: 'text-green-700', iconColor: 'text-green-600' },
                                                                                                                                error: { bg: 'bg-red-50', border: 'border-red-200', icon: 'ph-warning-circle', text: 'text-red-700', iconColor: 'text-red-600' },
                                                                                                                                warning: { bg: 'bg-amber-50', border: 'border-amber-200', icon: 'ph-warning', text: 'text-amber-700', iconColor: 'text-amber-600' },
                                                                                                                                info: { bg: 'bg-blue-50', border: 'border-blue-200', icon: 'ph-info', text: 'text-blue-700', iconColor: 'text-blue-600' }
                                                                                                                            };
                                                                                                                            
                                                                                                                            list.innerHTML = this._notifications.map((n, idx) => {
                                                                                                                                const cfg = typeConfig[n.type] || typeConfig.info;
                                                                                                                                // Escape HTML special characters in all user-controlled fields
                                                                                                                                const escapedMsg = this.escapeHtml(n.msg);
                                                                                                                                const escapedTs = this.escapeHtml(n.ts);
                                                                                                                                const escapedFullTs = this.escapeHtml(n.fullTs);
                                                                                                                                return `<div class="${cfg.bg} border ${cfg.border} rounded-lg sm:rounded-xl px-3 sm:px-4 py-2.5 sm:py-3 flex items-start gap-2.5 sm:gap-3 hover:shadow-md active:shadow-md transition group cursor-pointer\" title="${escapedFullTs}">
                                                                                                                                    <i class="ph-bold ${cfg.icon} ${cfg.iconColor} text-lg mt-0.5 flex-shrink-0"></i>
                                                                                                                                    <div class="flex-1 min-w-0">
                                                                                                                                        <div class="font-semibold text-slate-700 text-sm line-clamp-2">${escapedMsg}</div>
                                                                                                                                        <div class="text-xs ${cfg.text} opacity-70 mt-1">${escapedTs}</div>
                                                                                                                                    </div>
                                                                                                                                    <button onclick="event.stopPropagation(); app._notifications.splice(${idx}, 1); app.renderNotificationBox(); app.saveNotifications()" class="text-slate-300 hover:text-slate-600 active:text-slate-700 opacity-0 group-hover:opacity-100 active:opacity-100 transition flex-shrink-0 p-1.5 hover:bg-slate-200/50 rounded-md" aria-label="Delete notification">
                                                                                                                                        <i class="ph-bold ph-x text-lg"></i>
                                                                                                                                    </button>
                                                                                                                                </div>`;
                                                                                                                            }).join('');
                                                                                                                            if (count) {
                                                                                                                                count.textContent = this._notifications.length;
                                                                                                                                count.style.display = '';
                                                                                                                            }
                                                                                                                        }
                                                                                                                        
                                                                                                                        clearAllNotifications() {
                                                                                                                            this._notifications = [];
                                                                                                                            this.renderNotificationBox();
                                                                                                                            this.saveNotifications();
                                                                                                                            this.notify('All notifications cleared', 'success');
                                                                                                                        }
                                                                                                                        
                                                                                                                        saveNotifications() {
                                                                                                                            try {
                                                                                                                                localStorage.setItem('app_notifications', JSON.stringify(this._notifications || []));
                                                                                                                            } catch(e) {
                                                                                                                                console.warn('Failed to save notifications:', e);
                                                                                                                            }
                                                                                                                        }
                                                                                                                        
                                                                                                                        loadNotifications() {
                                                                                                                            try {
                                                                                                                                const saved = localStorage.getItem('app_notifications');
                                                                                                                                this._notifications = saved ? JSON.parse(saved) : [];
                                                                                                                                this.renderNotificationBox();
                                                                                                                            } catch(e) {
                                                                                                                                console.warn('Failed to load notifications:', e);
                                                                                                                                this._notifications = [];
                                                                                                                            }
                                                                                                                        }
                                                                                                            startAutoSync() {
                                                                                                                // Load persisted notifications from localStorage
                                                                                                                this.loadNotifications();
                                                                                                                ui.updateNotificationBadge();
                                                                                                                // Store last assigned lead IDs for notification
                                                                                                                this._lastAssignedLeadIds = new Set();
                                                                                                                // Initial population
                                                                                                                this.updateAssignedLeadIds();
                                                                                                                // Check for upcoming task reminders every minute
                                                                                                                this.checkUpcomingTasks();
                                                                                                                setInterval(() => {
                                                                                                                    this.autoSyncWithNotification();
                                                                                                                }, 2400000); // Sync every 40 minutes
                                                                                                                setInterval(() => {
                                                                                                                    this.checkUpcomingTasks();
                                                                                                                }, 60000); // Check tasks every minute
                                                                                                                // Start adaptive polling system
                                                                                                                this.initActivityTracker();
                                                                                                                this.scheduleNextPoll();
                                                                                                            }

                                                                                                            initActivityTracker() {
                                                                                                                const resetActivity = () => {
                                                                                                                    this.lastActivityTime = Date.now();
                                                                                                                    // If we were idle (poll rate > 5000), switch back to active immediately
                                                                                                                    if (this.currentPollRate > this.activePollRate) {
                                                                                                                        console.log('üìä User activity detected: Switching to Fast Polling (5s)');
                                                                                                                        this.currentPollRate = this.activePollRate;
                                                                                                                        this.isIdle = false;
                                                                                                                        // Reschedule to poll immediately
                                                                                                                        clearTimeout(this.pollingTimer);
                                                                                                                        this.scheduleNextPoll();
                                                                                                                    }
                                                                                                                };

                                                                                                                // Add event listeners for user activity with passive flag for better performance
                                                                                                                ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(event => {
                                                                                                                    window.addEventListener(event, resetActivity, { passive: true });
                                                                                                                });
                                                                                                                
                                                                                                                console.log('üìä Activity tracker initialized');
                                                                                                            }

                                                                                                            scheduleNextPoll() {
                                                                                                                clearTimeout(this.pollingTimer);
                                                                                                                
                                                                                                                this.pollingTimer = setTimeout(() => {
                                                                                                                    this.performPollStep();
                                                                                                                }, this.currentPollRate);
                                                                                                            }

                                                                                                            performPollStep() {
                                                                                                                // Check activity to determine next rate
                                                                                                                const timeSinceActivity = Date.now() - this.lastActivityTime;

                                                                                                                if (timeSinceActivity > this.idleThreshold) {
                                                                                                                    // Switch to Idle Mode
                                                                                                                    if (!this.isIdle) {
                                                                                                                        console.log('üìä No activity detected: Switching to Slow Polling (40s)');
                                                                                                                        this.currentPollRate = this.idlePollRate;
                                                                                                                        this.isIdle = true;
                                                                                                                    }
                                                                                                                } else {
                                                                                                                    // Switch to Active Mode
                                                                                                                    if (this.isIdle) {
                                                                                                                        console.log('üìä Activity detected: Switching to Fast Polling (5s)');
                                                                                                                        this.currentPollRate = this.activePollRate;
                                                                                                                        this.isIdle = false;
                                                                                                                    }
                                                                                                                }

                                                                                                                // Execute sync
                                                                                                                this.checkForServerUpdates();

                                                                                                                // Schedule next poll
                                                                                                                this.scheduleNextPoll();
                                                                                                            }

                                                                                                            updateAssignedLeadIds() {
                                                                                                                if (!this.currentUser || !(this.currentUser.role === 'agent' || this.currentUser.role === 'user')) return;
                                                                                                                const assignedLeads = this.store.state.filter(lead => lead.assignedTo === this.currentUser.username || lead.assignedTo === this.currentUser.id);
                                                                                                                this._lastAssignedLeadIds = new Set(assignedLeads.map(l => l.id));
                                                                                                            }

                                                                                                            checkUpcomingTasks() {
                                                                                                                if (!this.currentUser || !(this.currentUser.role === 'agent' || this.currentUser.role === 'user')) return;
                                                                                                                const now = new Date();
                                                                                                                const fifteenMinutesFromNow = new Date(now.getTime() + 15 * 60000);
                                                                                                                const today = now.toISOString().split('T')[0];
                                                                                                                const reminderKey = `task_reminder_${today}`;
                                                                                                                const remindedTasks = JSON.parse(sessionStorage.getItem(reminderKey) || '[]');
                                                                                                                const assignedLeads = this.store.state.filter(lead => lead.assignedTo === this.currentUser.username || lead.assignedTo === this.currentUser.id);
                                                                                                                
                                                                                                                assignedLeads.forEach(lead => {
                                                                                                                    if (!lead.tasks || lead.tasks.length === 0) return;
                                                                                                                    lead.tasks.forEach((task, idx) => {
                                                                                                                        if (task.status !== 'pending' || !task.dueDate) return;
                                                                                                                        const taskId = `${lead.id}_${idx}`;
                                                                                                                        if (remindedTasks.includes(taskId)) return; // Already reminded today
                                                                                                                        
                                                                                                                        const dueDate = new Date(task.dueDate + 'T23:59:59');
                                                                                                                        if (dueDate <= fifteenMinutesFromNow && dueDate > now) {
                                                                                                                            const minutesLeft = Math.round((dueDate - now) / 60000);
                                                                                                                            this.notify(`Task reminder: "${task.title}" for ${lead.name} due in ${minutesLeft} min`, 'warning');
                                                                                                                            remindedTasks.push(taskId);
                                                                                                                        }
                                                                                                                    });
                                                                                                                });
                                                                                                                
                                                                                                                sessionStorage.setItem(reminderKey, JSON.stringify(remindedTasks));
                                                                                                            }

            // Track previous state for change detection
            previousState = null;

            detectChanges(oldLeads, newLeads) {
                const changes = [];
                
                // Create maps for quick lookup
                const oldMap = {};
                const newMap = {};
                oldLeads.forEach(l => oldMap[l.id] = l);
                newLeads.forEach(l => newMap[l.id] = l);
                
                // Check for modified leads
                newLeads.forEach(newLead => {
                    const oldLead = oldMap[newLead.id];
                    if (!oldLead) return; // New lead, not a change
                    
                    const fieldChanges = this.getFieldChanges(oldLead, newLead);
                    if (fieldChanges.length > 0) {
                        changes.push({
                            leadId: newLead.id,
                            leadName: newLead.name,
                            fieldChanges: fieldChanges
                        });
                    }
                });
                
                return changes;
            }

            getFieldChanges(oldLead, newLead) {
                const changes = [];
                const fieldsToTrack = ['temperature', 'status', 'assignedTo', 'interest', 'value', 'lostReason'];
                
                fieldsToTrack.forEach(field => {
                    const oldVal = oldLead[field];
                    const newVal = newLead[field];
                    
                    if (oldVal !== newVal && newVal !== undefined && newVal !== null && newVal !== '') {
                        changes.push({
                            field: field,
                            oldValue: oldVal,
                            newValue: newVal
                        });
                    }
                });
                
                return changes;
            }

            formatChangeMessage(change) {
                if (change.fieldChanges.length === 0) return null;
                
                const fieldLabel = {
                    'temperature': 'Temperature',
                    'status': 'Status',
                    'assignedTo': 'Assigned To',
                    'interest': 'Interest',
                    'value': 'Value',
                    'lostReason': 'Lost Reason'
                };
                
                const changes = change.fieldChanges.map(fc => {
                    const label = fieldLabel[fc.field];
                    if (fc.field === 'assignedTo') {
                        // Get user name if available
                        const oldUser = fc.oldValue ? this.getUserName(fc.oldValue) : 'Unassigned';
                        const newUser = fc.newValue ? this.getUserName(fc.newValue) : 'Unassigned';
                        return `${label} from ${oldUser} to ${newUser}`;
                    } else if (fc.field === 'value') {
                        return `${label} from ${this.formatCurrency(fc.oldValue || 0)} to ${this.formatCurrency(fc.newValue || 0)}`;
                    } else {
                        return `${label} from ${fc.oldValue || 'None'} to ${fc.newValue}`;
                    }
                }).join(', ');
                
                return `${change.leadName}: ${changes}`;
            }

            async checkForServerUpdates() {
                if (!this.store.config.dbUrl) return;
                
                try {
                    const response = await fetch(this.store.config.dbUrl, { 
                        method: 'GET', 
                        redirect: 'follow', 
                        mode: 'cors',
                        credentials: 'omit',
                        signal: AbortSignal.timeout(15000) // 15 second timeout
                    });
                    if (!response.ok) return;
                    const data = await response.json();
                    
                    // Reset network error counter on successful request
                    this.consecutiveNetworkErrors = 0;
                    
                    // Check if server has new data
                    if (data.lastUpdate && data.lastUpdate > this.lastServerUpdate) {
                        // Keep a copy of current state before syncing
                        const previousLeads = JSON.parse(JSON.stringify(this.store.state));
                        
                        // Check if user is currently editing (modal is open)
                        const isModalOpen = document.getElementById('leadModal') && document.getElementById('leadModal').classList.contains('open');
                        const currentEditingLeadId = isModalOpen ? document.getElementById('leadModal').dataset.leadId : null;
                        
                        // Always sync in background (Soft Sync) - don't wait for modal to close
                        console.log('Auto-refreshing data from server...');
                        await this.store.syncWithCloud();
                        
                        // Detect changes
                        const changes = this.detectChanges(previousLeads, this.store.state);
                        
                        if (changes.length > 0) {
                            // Check if currently editing lead was modified by someone else
                            const editingLeadChanged = currentEditingLeadId && changes.some(c => c.leadId === currentEditingLeadId);
                            
                            if (editingLeadChanged) {
                                // Interrupt only if user's current lead was modified
                                const message = this.formatChangeMessage(changes.find(c => c.leadId === currentEditingLeadId));
                                this.notify(`Lead being edited was updated: ${message}. Refresh to see changes.`, 'warning');
                            } else if (isModalOpen) {
                                // Other leads changed - show updates available badge but don't interrupt
                                this.notify(`${changes.length} lead${changes.length > 1 ? 's' : ''} updated. Refresh when ready.`, 'info');
                            } else {
                                // Modal not open - show detailed message and refresh UI
                                const message = this.formatChangeMessage(changes[0]);
                                if (message) {
                                    this.notify(message, 'info');
                                }
                                this.render(this.store.state);
                            }
                        } else {
                            // No specific changes detected, but data was updated
                            if (!isModalOpen) {
                                this.notify('Data updated from other users', 'success');
                                this.render(this.store.state);
                            }
                        }
                        
                        // Update local tracking
                        this.lastServerUpdate = data.lastUpdate;
                    }
                } catch (e) {
                    // Handle network errors with exponential backoff
                    this.consecutiveNetworkErrors++;
                    
                    if (this.consecutiveNetworkErrors >= this.maxNetworkErrors) {
                        // Too many errors - show user notification
                        console.warn('Multiple sync failures - possible offline or server issue', e.message);
                        this.notify('Sync failed - check your connection. Will retry automatically.', 'warning');
                        
                        // Increase idle poll rate temporarily
                        this.idlePollRate = Math.min(60000, this.idlePollRate * this.networkErrorBackoffMultiplier);
                    } else {
                        // Log for debugging
                        console.debug('Update check failed (will retry)', e.message);
                    }
                }
            }

                                                                                                            async autoSyncWithNotification() {
                                                                                                                if (!this.currentUser || !(this.currentUser.role === 'agent' || this.currentUser.role === 'user')) return;
                                                                                                                const prevIds = new Set(this._lastAssignedLeadIds);
                                                                                                                await this.store.syncWithCloud();
                                                                                                                const assignedLeads = this.store.state.filter(lead => lead.assignedTo === this.currentUser.username || lead.assignedTo === this.currentUser.id);
                                                                                                                const newAssigned = assignedLeads.filter(l => !prevIds.has(l.id));
                                                                                                                if (newAssigned.length > 0) {
                                                                                                                    this.showNotification(`New lead assigned: ${newAssigned[0].name}`);
                                                                                                                }
                                                                                                                this._lastAssignedLeadIds = new Set(assignedLeads.map(l => l.id));
                                                                                                            }
                                                                                                showNotification(msg) {
                                                                                                    const tray = document.getElementById('notificationTray');
                                                                                                    document.getElementById('notificationMessage').textContent = msg || 'You have a new lead assigned!';
                                                                                                    tray.classList.remove('opacity-0', 'pointer-events-none');
                                                                                                    tray.classList.add('opacity-100', 'pointer-events-auto');
                                                                                                    if (this._notifTimeout) clearTimeout(this._notifTimeout);
                                                                                                    this._notifTimeout = setTimeout(() => {
                                                                                                        ui.hideNotification();
                                                                                                    }, 5000);
                                                                                                    this.addNotification(msg);
                                                                                                }

                                                                                                notify(msg, type = 'info') {
                                                                                                    const tray = document.getElementById('notificationTray');
                                                                                                    if (!tray) return;
                                                                                                    
                                                                                                    // Color mapping - solid colors for tray
                                                                                                    const colors = {
                                                                                                        success: 'bg-green-600',
                                                                                                        error: 'bg-red-600',
                                                                                                        warning: 'bg-amber-600',
                                                                                                        info: 'bg-blue-600'
                                                                                                    };
                                                                                                    
                                                                                                    // Icon mapping
                                                                                                    const icons = {
                                                                                                        success: 'ph-check-circle',
                                                                                                        error: 'ph-warning-circle',
                                                                                                        warning: 'ph-warning',
                                                                                                        info: 'ph-info'
                                                                                                    };
                                                                                                    
                                                                                                    const bgColor = colors[type] || colors.info;
                                                                                                    const icon = icons[type] || icons.info;
                                                                                                    
                                                                                                    // Mobile-optimized: bottom on mobile, top on desktop
                                                                                                    tray.className = `fixed bottom-20 left-2 right-2 sm:bottom-auto sm:left-1/2 sm:-translate-x-1/2 sm:top-4 z-[100] ${bgColor} text-white px-4 sm:px-5 py-3 sm:py-3.5 rounded-lg sm:rounded-xl shadow-xl flex items-center gap-3 text-sm font-semibold transition-all duration-300 opacity-100 pointer-events-auto sm:max-w-sm md:max-w-md`;
                                                                                                    document.getElementById('notificationMessage').textContent = msg;
                                                                                                    
                                                                                                    // Update icon
                                                                                                    const iconEl = tray.querySelector('i');
                                                                                                    if (iconEl) {
                                                                                                        iconEl.className = `ph-bold ${icon} text-lg flex-shrink-0`;
                                                                                                    }
                                                                                                    
                                                                                                    if (this._notifTimeout) clearTimeout(this._notifTimeout);
                                                                                                    this._notifTimeout = setTimeout(() => {
                                                                                                        ui.hideNotification();
                                                                                                    }, 4000);
                                                                                                    
                                                                                                    this.addNotification(msg, type);
                                                                                                }

                                                                                                // Show notification if a new lead is assigned to the current user
                                                                                                handleLeadAssignment(lead, prevAssignedTo) {
                                                                                                    if (!this.currentUser) return;
                                                                                                    // Only notify if the current user is agent/user and the lead is now assigned to them
                                                                                                    if ((this.currentUser.role === 'agent' || this.currentUser.role === 'user') &&
                                                                                                        (lead.assignedTo === this.currentUser.username || lead.assignedTo === this.currentUser.id) &&
                                                                                                        prevAssignedTo !== lead.assignedTo) {
                                                                                                        this.showNotification(`New lead assigned: ${lead.name}`);
                                                                                                    }
                                                                                                }
                                                                                    switchTab(tabId) {
                                                                                        this.activeMobileTab = tabId;
                                                                                        this.render(this.store.state);
                                                                                        ui.updateKanbanTabs();
                                                                                    }
                                                                        // --- LEADERBOARD RENDERING ---
                                                                        renderLeaderboard() {
                                                                            const container = document.getElementById('leaderboardContainer');
                                                                            if (!container) return;
                                                                            // Aggregate scores by user
                                                                            const userScores = {};
                                                                            (this.store.state || []).forEach(lead => {
                                                                                if (lead.assignedTo) {
                                                                                    if (!userScores[lead.assignedTo]) userScores[lead.assignedTo] = 0;
                                                                                    // Score: 1 per lead, +1 per 100k value, +1 per activity
                                                                                    let score = 1;
                                                                                    if (lead.value && lead.value > 0) score += Math.floor(lead.value / 100000);
                                                                                    if (Array.isArray(lead.activities)) score += lead.activities.length;
                                                                                    userScores[lead.assignedTo] += score;
                                                                                }
                                                                            });
                                                                            // Convert to array and sort
                                                                            const sorted = Object.entries(userScores).sort((a, b) => b[1] - a[1]);
                                                                            if (sorted.length === 0) {
                                                                                container.innerHTML = '<div class="text-slate-400 text-sm">No leaderboard data yet.</div>';
                                                                                return;
                                                                            }
                                                                            container.innerHTML = sorted.map(([user, score], i) => `
                                                                                <div class="flex items-center gap-3 p-2 rounded-lg ${i === 0 ? 'bg-yellow-100 border border-yellow-300' : 'bg-slate-50'}">
                                                                                    <span class="font-bold text-lg w-6 text-center">${i + 1}</span>
                                                                                    <span class="flex-1 font-medium text-slate-700">${this.escapeHtml(user)}</span>
                                                                                    <span class="font-bold text-primary">${score}</span>
                                                                                    ${i === 0 ? '<i class="ph-bold ph-crown text-yellow-500"></i>' : ''}
                                                                                </div>
                                                                            `).join('');
                                                                        }
                                                            // --- LEAD SCORING & TEMPERATURE ---
                                                            getLeadScores(lead) {
                                                                // Temperature: Manual assignment (Hot, Warm, Cold)
                                                                let temp = lead.temperature || '';
                                                                let tempColor = 'bg-slate-200 text-slate-700';
                                                                let tempIcon = 'ph-thermometer';
                                                                
                                                                if (temp === 'Hot') {
                                                                    tempColor = 'bg-red-200 text-red-700';
                                                                    tempIcon = 'ph-thermometer-hot';
                                                                } else if (temp === 'Warm') {
                                                                    tempColor = 'bg-amber-200 text-amber-700';
                                                                    tempIcon = 'ph-thermometer-simple';
                                                                } else if (temp === 'Cold') {
                                                                    tempColor = 'bg-blue-200 text-blue-700';
                                                                    tempIcon = 'ph-thermometer-cold';
                                                                }
                                                                
                                                                return { temp, tempColor, tempIcon };
                                                            }
                                                // Render the leads table view
                                                renderTable(leads) {
                                                    const tbody = document.getElementById('tableBody');
                                                    if (!tbody) return;
                                                    
                                                    // Debug: log available users and sample leads
                                                    console.log('Available users in store:', this.store.users);
                                                    if (leads.length > 0) {
                                                        console.log('Sample lead assignedTo values:', leads.slice(0, 3).map(l => ({ name: l.name, assignedTo: l.assignedTo })));
                                                    }
                                                    
                                                    // Filter for agent/user: only show assigned leads
                                                    let filteredLeads = leads;
                                                    if (this.currentUser && (this.currentUser.role === 'agent' || this.currentUser.role === 'user')) {
                                                        filteredLeads = leads.filter(lead => lead.assignedTo === this.currentUser.username || lead.assignedTo === this.currentUser.id);
                                                    }
                                                    // Apply custom filters (search, status, assigned-to)
                                                    filteredLeads = this.filterLeads(filteredLeads);
                                                    // Apply sorting
                                                    filteredLeads = this.getSortedLeads(filteredLeads);
                                                    // Populate bulk assign dropdown if admin/superuser
                                                    if (this.currentUser && (this.currentUser.role === 'admin' || this.currentUser.role === 'superuser')) {
                                                        const assignSelect = document.getElementById('bulkAssignSelect');
                                                        if (assignSelect) {
                                                            const currentVal = assignSelect.value;
                                                            assignSelect.innerHTML = '<option value="">Select agent to assign...</option>';
                                                            this.store.users.filter(u => u.role === 'admin' || u.role === 'agent').forEach(u => {
                                                                const opt = document.createElement('option');
                                                                opt.value = u.username || u.id;
                                                                opt.textContent = u.name;
                                                                assignSelect.appendChild(opt);
                                                            });
                                                            assignSelect.value = currentVal;
                                                        }
                                                        // Also populate filter dropdown
                                                        const filterAssignedTo = document.getElementById('filterAssignedTo');
                                                        if (filterAssignedTo) {
                                                            const currentVal = filterAssignedTo.value;
                                                            filterAssignedTo.innerHTML = '<option value="">All Agents</option>';
                                                            this.store.users.filter(u => u.role === 'admin' || u.role === 'agent').forEach(u => {
                                                                const opt = document.createElement('option');
                                                                opt.value = u.username || u.id;
                                                                opt.textContent = u.name;
                                                                filterAssignedTo.appendChild(opt);
                                                            });
                                                            filterAssignedTo.value = currentVal;
                                                        }
                                                    }
                                                    tbody.innerHTML = filteredLeads.map(lead => {
                                                        // Check for task status
                                                        const isActiveStage = !['Won', 'Lost'].includes(lead.status);
                                                        const taskCount = lead.tasks ? lead.tasks.length : 0;
                                                        const hasPendingTask = lead.tasks && lead.tasks.some(t => t.status === 'pending');
                                                        
                                                        const isNoAction = isActiveStage && taskCount === 0;
                                                        const isNoTask = isActiveStage && taskCount > 0 && !hasPendingTask;
                                                        
                                                        let badge = '';
                                                        if (isNoAction) {
                                                            badge = `<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700 flex-shrink-0" title="Active lead with 0 tasks"><i class="ph-bold ph-warning-circle text-sm"></i> <span class="hidden sm:inline">No Action</span></span>`;
                                                        } else if (isNoTask) {
                                                            badge = `<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-bold bg-amber-100 text-amber-700 flex-shrink-0" title="Active lead with no pending task"><i class="ph-bold ph-warning text-sm"></i> <span class="hidden sm:inline">No Task</span></span>`;
                                                        }

                                                        return `
                                                        <tr class="table-row-hover ${isNoAction ? 'bg-red-50' : isNoTask ? 'bg-amber-50' : 'hover:bg-slate-50'} active:bg-slate-100 transition">
                                                            <td class="pl-3 sm:pl-4 py-2 sm:py-3"><input type="checkbox" class="leadCheckbox w-4 h-4 rounded" data-leadId="${lead.id}" onchange="app.updateBulkActionsBar()"></td>
                                                            <td class="pl-3 sm:pl-4 py-2 sm:py-3 font-bold text-slate-800"><span class="inline-flex items-center gap-1.5">${this.escapeHtml(lead.name || lead.phone)}${badge}</span></td>
                                                            <td class="px-2 sm:px-3 py-2 sm:py-3 hidden sm:table-cell text-slate-600"><div class="text-xs">${this.escapeHtml(lead.phone || '-')}</div><div class="text-xs text-slate-400 line-clamp-1">${this.escapeHtml(lead.email || '')}</div></td>
                                                            <td class="px-2 sm:px-3 py-2 sm:py-3"><span class="inline-block px-2 py-1 bg-slate-100 text-slate-700 text-xs rounded font-medium whitespace-nowrap">${this.escapeHtml(lead.status)}</span></td>
                                                            <td class="px-2 sm:px-3 py-2 sm:py-3 hidden md:table-cell">${lead.status === 'Lost' && lead.lostReason ? `<span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded font-medium">${this.escapeHtml(lead.lostReason)}</span>` : '-'}</td>
                                                            <td class="px-2 sm:px-3 py-2 sm:py-3 hidden lg:table-cell text-slate-600">${this.escapeHtml(lead.interest || '-')}</td>
                                                            <td class="px-2 sm:px-3 py-2 sm:py-3 hidden lg:table-cell text-slate-600">${this.escapeHtml(lead.source || '-')}</td>
                                                            <td class="px-2 sm:px-3 py-2 sm:py-3 hidden sm:table-cell text-slate-600"><span class="text-xs font-medium">${this.escapeHtml(this.getUserName(lead.assignedTo))}</span></td>
                                                            <td class="px-2 sm:px-3 py-2 sm:py-3 text-right text-slate-700 font-semibold text-xs sm:text-sm">${this.formatCurrency(lead.value)}</td>
                                                            <td class="px-2 sm:px-3 py-2 sm:py-3 text-right">
                                                                <button onclick="app.editLead('${lead.id}')" class="text-primary hover:text-primary-dark active:text-primary font-bold text-xs sm:text-sm px-2 py-1 rounded hover:bg-primary/5 active:bg-primary/10 transition">
                                                                    <i class="ph-bold ph-pencil"></i> <span class="hidden sm:inline">Edit</span>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    `;
                                                    }).join('');
                                                    // Reset bulk actions bar
                                                    this.updateBulkActionsBar();
                                                }

                                                // Sort table by column
                                                sortTable(column) {
                                                    // Toggle sort direction if same column clicked
                                                    if (this.sortColumn === column) {
                                                        this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                                                    } else {
                                                        this.sortColumn = column;
                                                        this.sortDirection = 'asc';
                                                    }
                                                    
                                                    // Clear all sort indicators
                                                    document.querySelectorAll('[id^="sort-"]').forEach(el => el.textContent = '');
                                                    
                                                    // Add sort indicator to current column
                                                    const indicator = document.getElementById(`sort-${column}`);
                                                    if (indicator) {
                                                        indicator.textContent = this.sortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
                                                    }
                                                    
                                                    // Re-render with sorted data
                                                    this.render(this.store.state);
                                                }

                                                // Get sorted leads
                                                getSortedLeads(leads) {
                                                    if (!this.sortColumn) return leads;
                                                    
                                                    const sorted = [...leads].sort((a, b) => {
                                                        let aVal = a[this.sortColumn];
                                                        let bVal = b[this.sortColumn];
                                                        
                                                        // Handle null/undefined
                                                        if (aVal == null && bVal == null) return 0;
                                                        if (aVal == null) return this.sortDirection === 'asc' ? 1 : -1;
                                                        if (bVal == null) return this.sortDirection === 'asc' ? -1 : 1;
                                                        
                                                        // For numbers (like value)
                                                        if (typeof aVal === 'number' && typeof bVal === 'number') {
                                                            return this.sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                                                        }
                                                        
                                                        // For strings
                                                        aVal = String(aVal).toLowerCase();
                                                        bVal = String(bVal).toLowerCase();
                                                        
                                                        if (this.sortDirection === 'asc') {
                                                            return aVal.localeCompare(bVal);
                                                        } else {
                                                            return bVal.localeCompare(aVal);
                                                        }
                                                    });
                                                    
                                                    return sorted;
                                                }

                                                // Apply filters to leads
                                                applyFilters() {
                                                    // Get filter values from UI
                                                    const searchInput = document.getElementById('filterSearch');
                                                    const statusSelect = document.getElementById('filterStatus');
                                                    const assignedSelect = document.getElementById('filterAssignedTo');
                                                    const noTaskCheckbox = document.getElementById('filterNoTask');
                                                    const noActionCheckbox = document.getElementById('filterNoAction');
                                                    
                                                    if (searchInput) this.filters.search = searchInput.value.toLowerCase().trim();
                                                    if (statusSelect) this.filters.status = statusSelect.value;
                                                    if (assignedSelect) this.filters.assignedTo = assignedSelect.value;
                                                    if (noTaskCheckbox) this.filters.noTask = noTaskCheckbox.checked;
                                                    if (noActionCheckbox) this.filters.noAction = noActionCheckbox.checked;
                                                    
                                                    // Re-render with filtered and sorted data
                                                    this.render(this.store.state);
                                                }

                                                // Clear all filters
                                                clearFilters() {
                                                    this.filters = {
                                                        search: '',
                                                        status: '',
                                                        assignedTo: '',
                                                        noTask: false,
                                                        noAction: false
                                                    };
                                                    
                                                    // Reset UI
                                                    const searchInput = document.getElementById('filterSearch');
                                                    const statusSelect = document.getElementById('filterStatus');
                                                    const assignedSelect = document.getElementById('filterAssignedTo');
                                                    const noTaskCheckbox = document.getElementById('filterNoTask');
                                                    const noActionCheckbox = document.getElementById('filterNoAction');
                                                    
                                                    if (searchInput) searchInput.value = '';
                                                    if (statusSelect) statusSelect.value = '';
                                                    if (assignedSelect) assignedSelect.value = '';
                                                    if (noTaskCheckbox) noTaskCheckbox.checked = false;
                                                    if (noActionCheckbox) noActionCheckbox.checked = false;
                                                    
                                                    // Re-render
                                                    this.render(this.store.state);
                                                }

                                                // Apply filters to leads array
                                                filterLeads(leads) {
                                                    let filtered = leads;
                                                    
                                                    // Apply search filter (name, email, phone)
                                                    if (this.filters.search) {
                                                        filtered = filtered.filter(lead => {
                                                            const search = this.filters.search;
                                                            return (lead.name && String(lead.name).toLowerCase().includes(search)) ||
                                                                   (lead.email && String(lead.email).toLowerCase().includes(search)) ||
                                                                   (lead.phone && String(lead.phone).toLowerCase().includes(search));
                                                        });
                                                    }
                                                    
                                                    // Apply status filter
                                                    if (this.filters.status) {
                                                        filtered = filtered.filter(lead => lead.status === this.filters.status);
                                                    }
                                                    
                                                    // Apply assigned-to filter
                                                    if (this.filters.assignedTo) {
                                                        filtered = filtered.filter(lead => lead.assignedTo === this.filters.assignedTo);
                                                    }
                                                    
                                                    // Apply "No Task" filter - shows leads with tasks but none pending
                                                    if (this.filters.noTask) {
                                                        filtered = filtered.filter(lead => {
                                                            const isActiveStage = !['Won', 'Lost'].includes(lead.status);
                                                            const hasTasks = lead.tasks && lead.tasks.length > 0;
                                                            const hasPendingTask = lead.tasks && lead.tasks.some(t => t.status === 'pending');
                                                            return isActiveStage && hasTasks && !hasPendingTask;
                                                        });
                                                    }

                                                    // Apply "No Action" filter - shows leads with 0 tasks
                                                    if (this.filters.noAction) {
                                                        filtered = filtered.filter(lead => {
                                                            const isActiveStage = !['Won', 'Lost'].includes(lead.status);
                                                            const hasTasks = lead.tasks && lead.tasks.length > 0;
                                                            return isActiveStage && !hasTasks;
                                                        });
                                                    }
                                                    
                                                    return filtered;
                                                }

                                                // Get user name from username/id
                                                getUserName(username) {
                                                    if (!username) return '';
                                                    // Try to find user by username or id
                                                    const user = this.store.users.find(u => {
                                                        return String(u.username).toLowerCase() === String(username).toLowerCase() || 
                                                               String(u.id).toLowerCase() === String(username).toLowerCase();
                                                    });
                                                    return user && user.name ? user.name : username;
                                                }

                                    // Switch between Kanban and Table views
                                    switchViewMode(mode) {
                                        this.activeView = mode;
                                        this.currentView = mode; // Store for mobile nav update
                                        const kanban = document.getElementById('kanbanView');
                                        const table = document.getElementById('tableView');
                                        const agentTable = document.getElementById('agentTableView');
                                        const reports = document.getElementById('reportsView');
                                        const kanbanTabs = document.getElementById('kanbanTabs');
                                        
                                        if (mode === 'kanban') {
                                            kanban.classList.remove('hidden');
                                            table.classList.add('hidden');
                                            agentTable.classList.add('hidden');
                                            reports.classList.add('hidden');
                                            if (kanbanTabs) kanbanTabs.classList.remove('hidden'); // Show tabs for Kanban
                                            this.render(this.store.state);
                                            ui.updateKanbanTabs(); // Update Kanban mobile tabs
                                        } else if (mode === 'table') {
                                            kanban.classList.add('hidden');
                                            table.classList.remove('hidden');
                                            agentTable.classList.add('hidden');
                                            reports.classList.add('hidden');
                                            if (kanbanTabs) kanbanTabs.classList.add('hidden'); // Hide tabs for Table
                                            this.render(this.store.state);
                                        } else if (mode === 'agentTable') {
                                            kanban.classList.add('hidden');
                                            table.classList.add('hidden');
                                            agentTable.classList.remove('hidden');
                                            reports.classList.add('hidden');
                                            if (kanbanTabs) kanbanTabs.classList.add('hidden'); // Hide tabs for Agent Table
                                            this.renderAgentTable();
                                        } else if (mode === 'reports') {
                                            kanban.classList.add('hidden');
                                            table.classList.add('hidden');
                                            agentTable.classList.add('hidden');
                                            reports.classList.remove('hidden');
                                            if (kanbanTabs) kanbanTabs.classList.add('hidden'); // Hide tabs for Reports
                                            this.renderReports();
                                            this.setupDateFilter(); // Setup date filter for Reports view
                                        }
                                        this.renderLeaderboard();
                                        ui.updateMobileNav(); // Update mobile nav indicator
                                    }

                                    renderAgentTable() {
                                        const tbody = document.getElementById('agentTableBody');
                                        if (!tbody) return;
                                        // Only show for admin/superuser
                                        if (!this.currentUser || (this.currentUser.role !== 'admin' && this.currentUser.role !== 'superuser')) {
                                            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-12 text-slate-400">Access denied</td></tr>';
                                            return;
                                        }
                                        // Get all agents (admin, agent)
                                        const agents = this.store.users.filter(u => u.role === 'admin' || u.role === 'agent');
                                        const leads = this.store.state || [];
                                        
                                        if (agents.length === 0) {
                                            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-12 text-slate-400">No agents found</td></tr>';
                                            return;
                                        }
                                        
                                        // Calculate agent performance metrics
                                        const agentMetrics = agents.map(agent => {
                                            const assignedLeads = leads.filter(lead => {
                                                const leadAssigned = lead.assignedTo ? String(lead.assignedTo).toLowerCase() : '';
                                                const agentName = agent.username ? String(agent.username).toLowerCase() : '';
                                                const agentId = agent.id ? String(agent.id).toLowerCase() : '';
                                                return leadAssigned === agentName || leadAssigned === agentId;
                                            });
                                            const wonLeads = assignedLeads.filter(l => l.status === 'Won').length;
                                            const totalValue = assignedLeads.reduce((sum, l) => sum + (l.value || 0), 0);
                                            const conversionRate = assignedLeads.length > 0 ? Math.round((wonLeads / assignedLeads.length) * 100) : 0;
                                            return { agent, assignedLeads: assignedLeads.length, wonLeads, revenue: totalValue, conversionRate };
                                        });
                                        
                                        // Sort by revenue (descending)
                                        agentMetrics.sort((a, b) => b.revenue - a.revenue);
                                        
                                        tbody.innerHTML = agentMetrics.map((metric, index) => {
                                            const agent = metric.agent;
                                            // Generate initials
                                            const initials = agent.name
                                                .split(' ')
                                                .map(n => n[0])
                                                .join('')
                                                .substring(0, 2)
                                                .toUpperCase();
                                            
                                            // Rank styling
                                            let rankIcon = '';
                                            if (index === 0) rankIcon = '<i class="ph-bold ph-trophy text-amber-500 text-lg"></i>';
                                            else if (index === 1) rankIcon = '<i class="ph-bold ph-medal text-slate-400 text-lg"></i>';
                                            else if (index === 2) rankIcon = '<i class="ph-bold ph-medal text-amber-700 text-lg"></i>';
                                            else rankIcon = `<span class="text-slate-400 font-medium text-sm">#${index + 1}</span>`;
                                            
                                            return `
                                            <tr class="hover:bg-slate-50 transition-colors group">
                                                <td class="p-3 sm:p-4">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-8 h-8 flex-none flex items-center justify-center rounded-full bg-slate-100 text-slate-600 text-xs font-bold border border-slate-200 shadow-sm">
                                                            ${initials}
                                                        </div>
                                                        <div>
                                                            <div class="font-semibold text-slate-900 text-sm sm:text-base flex items-center gap-2">
                                                                ${this.escapeHtml(agent.name || agent.username || agent.id)}
                                                                ${index < 3 ? '<span class="sm:hidden">' + rankIcon + '</span>' : ''}
                                                            </div>
                                                            <div class="text-xs text-slate-500 hidden sm:block">${this.escapeHtml(agent.role)}</div>
                                                        </div>
                                                        <div class="ml-auto hidden sm:block">
                                                            ${rankIcon}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="p-3 sm:p-4 text-center">
                                                    <div class="inline-flex flex-col items-center">
                                                        <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100">
                                                            ${metric.assignedLeads}
                                                        </span>
                                                        <span class="text-[10px] text-slate-400 mt-1 sm:hidden">Total</span>
                                                    </div>
                                                </td>
                                                <td class="p-3 sm:p-4 text-center">
                                                    <div class="inline-flex flex-col items-center">
                                                        <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-50 text-green-700 border border-green-100">
                                                            ${metric.wonLeads}
                                                        </span>
                                                        <span class="text-[10px] text-slate-400 mt-1 sm:hidden">Won</span>
                                                    </div>
                                                </td>
                                                <td class="p-3 sm:p-4 text-center hidden sm:table-cell">
                                                    <div class="flex items-center justify-center gap-2">
                                                        <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                                            <div class="h-full bg-indigo-500 rounded-full" style="width: ${Math.min(metric.conversionRate, 100)}%"></div>
                                                        </div>
                                                        <span class="text-slate-700 font-medium text-sm">${metric.conversionRate}%</span>
                                                    </div>
                                                </td>
                                                <td class="p-3 sm:p-4 text-right">
                                                    <div class="font-bold text-slate-800 text-sm sm:text-base">‚Çπ${metric.revenue.toLocaleString()}</div>
                                                    <div class="text-xs text-slate-500 sm:hidden font-medium">
                                                        ${metric.conversionRate}% Conv.
                                                    </div>
                                                </td>
                                            </tr>
                                            `;
                                        }).join('');
                                    }

                                    // Bulk selection methods
                                    updateBulkActionsBar() {
                                        const checkboxes = document.querySelectorAll('.leadCheckbox:checked');
                                        const selectedCount = checkboxes.length;
                                        const bulkActionsBar = document.getElementById('bulkActionsBar');
                                        const selectedCountEl = document.getElementById('selectedCount');
                                        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                                        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
                                        
                                        if (selectedCount > 0) {
                                            bulkActionsBar.classList.remove('hidden');
                                            selectedCountEl.textContent = `${selectedCount} selected`;
                                            
                                            // Show delete button only for admin/superuser
                                            if (this.currentUser && (this.currentUser.role === 'admin' || this.currentUser.role === 'superuser')) {
                                                bulkDeleteBtn.classList.remove('hidden');
                                            } else {
                                                bulkDeleteBtn.classList.add('hidden');
                                            }
                                        } else {
                                            bulkActionsBar.classList.add('hidden');
                                            bulkDeleteBtn.classList.add('hidden');
                                            if (selectAllCheckbox) selectAllCheckbox.checked = false;
                                        }
                                    }

                                    toggleSelectAll(checked) {
                                        const checkboxes = document.querySelectorAll('.leadCheckbox');
                                        checkboxes.forEach(cb => cb.checked = checked);
                                        this.updateBulkActionsBar();
                                    }

                                    clearSelection() {
                                        const checkboxes = document.querySelectorAll('.leadCheckbox');
                                        checkboxes.forEach(cb => cb.checked = false);
                                        document.getElementById('selectAllCheckbox').checked = false;
                                        this.updateBulkActionsBar();
                                    }

                                    bulkAssignLeads() {
                                        const assignSelect = document.getElementById('bulkAssignSelect');
                                        const assignTo = assignSelect.value;
                                        if (!assignTo) {
                                            this.notify('Please select an agent to assign leads to', 'error');
                                            return;
                                        }
                                        
                                        const checkboxes = document.querySelectorAll('.leadCheckbox:checked');
                                        const leadIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-leadid'));
                                        
                                        console.log('Bulk Assign - Selected Lead IDs:', leadIds);
                                        console.log('Bulk Assign - Assigning to:', assignTo);
                                        console.log('Bulk Assign - Current store state:', this.store.state);
                                        
                                        if (leadIds.length === 0) {
                                            this.notify('Please select at least one lead', 'error');
                                            return;
                                        }
                                        
                                        if (!confirm(`Assign ${leadIds.length} lead(s) to the selected agent?`)) {
                                            return;
                                        }
                                        
                                        // Update all selected leads
                                        let updateCount = 0;
                                        leadIds.forEach(leadId => {
                                            const lead = this.store.state.find(l => l.id === leadId);
                                            console.log(`Looking for lead with id "${leadId}":`, lead);
                                            if (lead) {
                                                console.log(`Updating lead "${lead.name}" from "${lead.assignedTo}" to "${assignTo}"`);
                                                lead.assignedTo = assignTo;
                                                updateCount++;
                                                // Add activity log
                                                if (!lead.activities) lead.activities = [];
                                                lead.activities.push({
                                                    type: 'Assigned',
                                                    note: `Bulk assigned to ${assignTo}`,
                                                    createdBy: this.currentUser.name,
                                                    role: this.currentUser.role,
                                                    timestamp: new Date().toISOString()
                                                });
                                            }
                                        });
                                        
                                        console.log(`Updated ${updateCount} leads out of ${leadIds.length}`);
                                        
                                        // Save locally and push to cloud
                                        this.store.saveLocal();
                                        this.store.pushToCloud();
                                        
                                        console.log('After push, store state:', this.store.state);
                                        
                                        // Clear selection and show success
                                        this.clearSelection();
                                        this.showNotification(`Successfully assigned ${leadIds.length} lead(s)`);
                                        this.render(this.store.state);
                                    }

                                    bulkDeleteLeads() {
                                        // Check if user is admin/superuser
                                        if (!this.currentUser || (this.currentUser.role !== 'admin' && this.currentUser.role !== 'superuser')) {
                                            this.notify('Only admin/superuser can delete leads', 'error');
                                            return;
                                        }

                                        const checkboxes = document.querySelectorAll('.leadCheckbox:checked');
                                        const leadIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-leadid'));
                                        
                                        if (leadIds.length === 0) {
                                            this.notify('Please select at least one lead to delete', 'error');
                                            return;
                                        }

                                        // Get lead names for confirmation
                                        const leadNames = leadIds.map(id => {
                                            const lead = this.store.state.find(l => l.id === id);
                                            return lead ? lead.name : id;
                                        }).join(', ');

                                        if (!confirm(`Are you sure you want to delete ${leadIds.length} lead(s)?\n\n${leadNames}\n\nThis action cannot be undone.`)) {
                                            return;
                                        }

                                        // Delete selected leads
                                        let deleteCount = 0;
                                        leadIds.forEach(leadId => {
                                            const index = this.store.state.findIndex(l => l.id === leadId);
                                            if (index !== -1) {
                                                const deletedLead = this.store.state[index];
                                                this.store.state.splice(index, 1);
                                                deleteCount++;
                                                
                                                // Log deletion
                                                this.store.logs.push({
                                                    timestamp: new Date().toISOString(),
                                                    user: this.currentUser.name,
                                                    action: 'Delete',
                                                    message: `Deleted lead: ${deletedLead.name}`
                                                });
                                            }
                                        });

                                        // Save and sync
                                        this.store.saveLocal();
                                        this.store.pushToCloud();

                                        // Clear selection and show success
                                        this.clearSelection();
                                        this.notify(`Successfully deleted ${deleteCount} lead(s)`, 'success');
                                        this.render(this.store.state);
                                    }
                        // Render the activity timeline for a lead in the modal
                        renderTimeline(lead) {
                            const container = document.getElementById('activityTimeline');
                            if (!container || !lead || !Array.isArray(lead.activities)) {
                                container.innerHTML = '<div class="text-slate-400 text-sm">No activity yet.</div>';
                                return;
                            }
                            if (lead.activities.length === 0) {
                                container.innerHTML = '<div class="text-slate-400 text-sm">No activity yet.</div>';
                                return;
                            }
                            container.innerHTML = lead.activities.map(a => `
                                <div class="timeline-item relative pl-8 py-4">
                                    <div class="timeline-line absolute left-0 top-0 h-full w-4 flex items-center justify-center">
                                        <div class="w-2 h-2 rounded-full bg-primary"></div>
                                    </div>
                                    <div class="flex flex-col gap-1">
                                        <div class="text-xs text-slate-500">${a.timestamp ? this.formatDateTime(a.timestamp) : ''}</div>
                                        <div class="text-sm font-medium text-slate-800">${this.escapeHtml(a.type || '')}${a.note ? ': ' + this.escapeHtml(a.note) : ''}</div>
                                        <div class="text-xs text-slate-400">${a.createdBy ? this.escapeHtml(a.createdBy) : ''}${a.role ? ' (' + this.escapeHtml(a.role) + ')' : ''}</div>
                                    </div>
                                </div>
                            `).join('');
                        }
            // Populate Assigned To dropdown with Admins and Agents
            populateAssignedToDropdown() {
                const select = document.getElementById('assignedToSelect');
                if (!select) return;
                const current = select.value;
                select.innerHTML = '<option value="">Select User</option>';
                this.store.users.filter(u => u.role === 'admin' || u.role === 'agent').forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.username || u.id;
                    opt.textContent = u.name;
                    select.appendChild(opt);
                });
                if (current) select.value = current;
            }

            // --- EDIT LEAD LOGIC ---
            editLead(id, tab) {
                const lead = this.store.state.find(l => l.id === id);
                if (!lead) return;
                // Store current editing lead ID for soft sync detection
                document.getElementById('leadModal').dataset.leadId = id;
                // Store lead snapshot for optimistic locking (conflict detection)
                this._editingLeadSnapshot = JSON.parse(JSON.stringify(lead));
                // Fill modal form fields
                document.getElementById('leadIdInput').value = lead.id;
                document.getElementById('modalTitle').textContent = 'Edit Lead';
                document.getElementById('submitBtn').textContent = 'Update';
                document.getElementById('tab-btn-activity').disabled = false;
                document.getElementById('tab-btn-contact').disabled = false;
                document.getElementById('leadForm').name.value = lead.name || '';
                document.getElementById('leadForm').interest.value = lead.interest || '';
                document.getElementById('leadForm').value.value = lead.value || '';
                document.getElementById('leadForm').status.value = lead.status || '';
                document.getElementById('leadForm').temperature.value = lead.temperature || '';
                document.getElementById('leadForm').email.value = lead.email || '';
                document.getElementById('leadForm').querySelector('input[name="location"]').value = lead.location || '';
                document.getElementById('leadForm').querySelector('input[name="source"]').value = lead.source || '';
                // Assigned To select - only editable by admins
                const isAdmin = this.currentUser && (this.currentUser.role === 'admin' || this.currentUser.role === 'superuser');
                const assignedToSelect = document.getElementById('assignedToSelect');
                const assignedToDisplay = document.getElementById('assignedToDisplay');
                if (isAdmin) {
                    // Admin: show editable dropdown
                    this.populateAssignedToDropdown();
                    assignedToSelect.classList.remove('hidden');
                    assignedToDisplay.classList.add('hidden');
                    if (assignedToSelect) assignedToSelect.value = lead.assignedTo || '';
                } else {
                    // Agent: show read-only display
                    assignedToSelect.classList.add('hidden');
                    assignedToDisplay.classList.remove('hidden');
                    assignedToDisplay.textContent = lead.assignedTo ? this.getUserName(lead.assignedTo) : 'Unassigned';
                }
                // Phone split
                let phone = lead.phone || '';
                let prefix = '+91', number = '';
                if (phone.startsWith('+')) {
                    const parts = phone.split(' ');
                    prefix = parts[0];
                    number = parts.slice(1).join(' ');
                } else if (phone) {
                    number = phone;
                }
                document.getElementById('leadForm').phonePrefix.value = prefix;
                document.getElementById('leadForm').phone.value = number;
                document.getElementById('leadForm').notes.value = lead.notes || '';
                // Interests tags
                this.selectedInterests = (lead.interest || '').split(',').filter(x=>x.trim()).map(i=>({name:i.trim(),value:0}));
                this.renderInterestTags();
                // Show lost reason if status is "Lost"
                const lostReasonDisplay = document.getElementById('lostReasonDisplay');
                const lostReasonText = document.getElementById('lostReasonText');
                if (lead.status === 'Lost' && lead.lostReason) {
                    lostReasonDisplay.classList.remove('hidden');
                    lostReasonText.textContent = lead.lostReason;
                } else {
                    lostReasonDisplay.classList.add('hidden');
                }
                // Show modal
                ui.toggleModal(true);
                // Switch tab if specified
                if (tab) this.switchModalTab(tab);
            }
            constructor() {
                this.store = new LeadStore();
                this.currentUser = null;
                this.statusConfig = [
                    { id: 'New', color: 'bg-blue-500', text: 'text-blue-700', bg: 'bg-blue-50' },
                    { id: 'Contacted', color: 'bg-yellow-500', text: 'text-yellow-700', bg: 'bg-yellow-50' },
                    { id: 'Proposal', color: 'bg-purple-500', text: 'text-purple-700', bg: 'bg-purple-50' },
                    { id: 'Won', color: 'bg-green-500', text: 'text-green-700', bg: 'bg-green-50' },
                    { id: 'Lost', color: 'bg-red-500', text: 'text-red-700', bg: 'bg-red-50' }
                ];
                this.activeMobileTab = this.statusConfig[0].id;
                this.currentModalTab = 'info';
                this.activeView = 'kanban'; 
                this.selectedInterests = [];
                this.sortColumn = null;
                this.sortDirection = 'asc';
                this.dateFilter = 'till-date';
                this.chartInstances = {};
                this.settingsAutocompleteInitialized = false;
                this.lastSyncTime = 0;
                this.lastServerUpdate = 0;
                this.filters = {
                    search: '',
                    status: '',
                    assignedTo: '',
                    noTask: false,
                    noAction: false
                };
                // Always update login card/app title on construction
                if (typeof this.applyConfig === 'function') this.applyConfig();
                this.store.subscribe((data) => {
                    if (this.currentUser) {
                        this.render(data);
                        if(document.getElementById('sideMenu').classList.contains('open')) this.renderFollowUps();
                    }
                });
            }

            // --- AUTOCOMPLETE LOGIC (Generic) ---
            setupAutocomplete(inputId, suggestionsId, dataList, onSelect) {
                const input = document.getElementById(inputId);
                const suggestions = document.getElementById(suggestionsId);
                if (!input || !suggestions) return;
                
                input.addEventListener('input', (e) => {
                    const val = e.target.value.toLowerCase();
                    if (!val) { suggestions.classList.add('hidden'); return; }
                    
                    const matches = dataList.filter(i => {
                        const text = typeof i === 'string' ? i : i.name;
                        return text.toLowerCase().includes(val);
                    });

                    if (matches.length > 0) {
                        suggestions.innerHTML = matches.map((m, index) => {
                            const text = typeof m === 'string' ? m : m.name;
                            const isState = text.startsWith('State - ') || text.startsWith('Union Territory - ');
                            const isCity = text.startsWith('Cities - ');
                            const displayText = text.replace(/^(State - |Union Territory - |Cities - )/, '');
                            const subtext = typeof m === 'string' ? '' : `‚Çπ${m.value.toLocaleString('en-IN')}`;
                            const indent = isCity ? 'pl-6' : '';
                            const badge = isState ? '<span class="text-xs bg-primary text-white px-2 py-0.5 rounded ml-2">State</span>' : isCity ? '<span class="text-xs bg-slate-200 text-slate-700 px-2 py-0.5 rounded ml-2">City</span>' : '';
                            return `<div class="suggestion-item py-2 cursor-pointer hover:bg-slate-100 ${indent}" data-index="${index}">${displayText} ${badge} <span class="text-xs text-slate-400 float-right">${subtext}</span></div>`;
                        }).join('');
                        suggestions.classList.remove('hidden');
                        
                        const items = suggestions.querySelectorAll('.suggestion-item');
                        items.forEach((item) => {
                            item.addEventListener('click', () => {
                                const index = parseInt(item.getAttribute('data-index'));
                                const selected = matches[index];
                                const text = typeof selected === 'string' ? selected : selected.name;
                                const cleanText = text.replace(/^(State - |Union Territory - |Cities - )/, '');
                                onSelect(selected);
                                suggestions.classList.add('hidden');
                            });
                        });
                    } else {
                        suggestions.classList.add('hidden');
                    }
                });

                // Close suggestions when clicking outside
                document.addEventListener('click', (e) => {
                    if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                        suggestions.classList.add('hidden');
                    }
                });
            }

            // --- INTEREST LOGIC ---
            initInterestLogic() {
                const getMasterList = () => {
                    if (this.store.interests && this.store.interests.length > 0) {
                        return this.store.interests.map(i => ({ 
                            name: i.Name || i.name, 
                            value: parseFloat(i.Value || i.value) || 0 
                        }));
                    }
                    return [];
                };
                
                const input = document.getElementById('interestInput');
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); if (input.value.trim()) this.addInterest(input.value.trim(), 0); }
                });

                this.setupAutocomplete('interestInput', 'interestSuggestions', getMasterList(), (selected) => {
                    const name = typeof selected === 'string' ? selected : selected.name;
                    const value = typeof selected === 'string' ? 0 : selected.value;
                    this.addInterest(name, value);
                    document.getElementById('interestInput').value = ''; 
                });
            }

            addInterest(name, value) {
                if (this.selectedInterests.some(i => i.name === name)) return;
                this.selectedInterests.push({ name, value });
                this.renderInterestTags();
                this.updateTotalValue();
            }
            removeInterest(name) {
                this.selectedInterests = this.selectedInterests.filter(i => i.name !== name);
                this.renderInterestTags();
                this.updateTotalValue();
            }
            renderInterestTags() {
                const container = document.getElementById('interestTags');
                const hiddenInput = document.getElementById('interestHidden');
                container.innerHTML = this.selectedInterests.map(i => `
                    <span class="interest-tag inline-flex items-center px-2.5 py-1 rounded-md text-sm font-medium bg-indigo-50 text-indigo-700 border border-indigo-100">
                        ${i.name}
                        <button type="button" onclick="app.removeInterest('${i.name}')" class="ml-1.5 text-indigo-400 hover:text-indigo-600 focus:outline-none"><i class="ph-bold ph-x"></i></button>
                    </span>`).join('');
                hiddenInput.value = this.selectedInterests.map(i => i.name).join(', ');
            }
            updateTotalValue() {
                const total = this.selectedInterests.reduce((sum, item) => sum + item.value, 0);
                if (total > 0) document.getElementById('leadValue').value = total;
            }

            // --- LOCATION & SOURCE LOGIC ---
            initSettingsAutocomplete() {
                // Only initialize once to avoid duplicate event listeners
                if (this.settingsAutocompleteInitialized) {
                    // Don't clear inputs - they may have been populated from editLead()
                    return;
                }

                const locations = this.store.settings.locations || [];
                const sources = this.store.settings.sources || [];
                const taskTitles = this.store.settings.taskTitles || [];

                // Set up fresh autocompletes
                this.setupAutocomplete('locationInput', 'locationSuggestions', locations, (selected) => {
                    const text = typeof selected === 'string' ? selected : selected.name;
                    const cleanText = text.replace(/^(State - |Union Territory - |Cities - )/, '');
                    document.getElementById('locationInput').value = cleanText;
                });

                this.setupAutocomplete('sourceInput', 'sourceSuggestions', sources, (selected) => {
                    const text = typeof selected === 'string' ? selected : selected.name;
                    document.getElementById('sourceInput').value = text;
                });

                this.setupAutocomplete('taskInput', 'taskSuggestions', taskTitles, (selected) => {
                    const text = typeof selected === 'string' ? selected : selected.name;
                    document.getElementById('taskInput').value = text;
                });

                this.settingsAutocompleteInitialized = true;
            }

            // --- STANDARD LOGIC ---

            async handleLogin(e) {
                e.preventDefault();
                document.getElementById('loginError').classList.add('hidden');
                ui.showLoading(true, 'Syncing users...');
                await this.store.syncWithCloud();
                // Ensure UI/app name updates instantly after sync
                if (typeof this.applyConfig === 'function') this.applyConfig();
                ui.showLoading(false);
                const u = e.target.username.value;
                const p = e.target.password.value;
                const user = this.store.users.find(x => String(x.username) === String(u) && String(x.password) === String(p));
                if (user) {
                    this.currentUser = user;
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('appContent').classList.remove('hidden');
                    document.getElementById('appContent').classList.add('flex');
                    // Show Agent Table button only for admin/superuser
                    const agentTableBtn = document.getElementById('agentTableBtn');
                    if (agentTableBtn) {
                        if (this.currentUser.role === 'admin' || this.currentUser.role === 'superuser') {
                            agentTableBtn.style.display = '';
                        } else {
                            agentTableBtn.style.display = 'none';
                        }
                    }
                    // Show Reports button only for admin/superuser
                    const reportsBtn = document.getElementById('reportsBtn');
                    if (reportsBtn) {
                        if (this.currentUser.role === 'admin' || this.currentUser.role === 'superuser') {
                            reportsBtn.style.display = '';
                        } else {
                            reportsBtn.style.display = 'none';
                        }
                    }
                    this.init();
                } else {
                    document.getElementById('loginError').classList.remove('hidden');
                }
            }

            logout() { location.reload(); }

            async init() {
                this.applyConfig();
                this.updateUserUI();
                // Update Kanban tabs with safe check
                if (ui && typeof ui.updateKanbanTabs === 'function') {
                    ui.updateKanbanTabs();
                }
                this.render(this.store.state);

                this.initInterestLogic();
                this.initSettingsAutocomplete();
                this.populateAssignedToDropdown();

                // Show admin settings for superuser/admin
                if (this.currentUser.role === 'superuser' || this.currentUser.role === 'admin') {
                    // Show Admin SYS section in hamburger menu
                    const adminSysSection = document.getElementById('adminSysSection');
                    if (adminSysSection) {
                        adminSysSection.style.display = '';
                    }
                }

                if (this.store.config.dbUrl) {
                    await this.store.syncWithCloud();
                    this.initInterestLogic(); 
                    this.initSettingsAutocomplete();
                    this.populateAssignedToDropdown();
                }

                const s = document.getElementById('formStatusSelect');
                s.innerHTML = '';
                this.statusConfig.forEach(x => {
                    const opt = document.createElement('option');
                    opt.value = x.id; opt.textContent = x.id; s.appendChild(opt);
                });
            }

            sync() { this.store.syncWithCloud(); }
            updateUserUI() {
                document.getElementById('currentUserDisplay').textContent = this.currentUser.username;
                document.getElementById('menuUserName').textContent = this.currentUser.name;
                document.getElementById('menuUserRole').textContent = this.currentUser.role;
            }
            applyConfig() {
                const title = this.store.config.appTitle || 'LeadFlow';
                document.getElementById('appTitleDisplay').textContent = title;
                document.getElementById('loginTitle').textContent = title;
                document.getElementById('configAppTitle').value = title;
                document.getElementById('configDbUrl').value = 'https://script.google.com/macros/s/AKfycbxevXBoOPZkOq82wHla6WKrOiGhnrNM7FXKtHmeItMOnUp0vBOYF13lcBRAE3Gtfw/exec';
                document.title = title;
            }

            handleAddUser(e) {
                e.preventDefault();
                const username = e.target.newUsername.value.trim();
                const password = e.target.newPassword.value.trim();
                const name = e.target.newName.value.trim();
                const role = e.target.newRole.value;
                
                // Validation rules
                // ID: 3 CAPS letters + 3 digits, max 6 characters
                const idRegex = /^[A-Z]{3}\d{3}$/;
                if (!idRegex.test(username)) {
                    return this.notify('ID must be exactly 3 UPPERCASE letters followed by 3 digits (e.g., ABC123)', 'error');
                }
                
                // Password: 4 digits only
                if (!/^\d{4}$/.test(password)) {
                    return this.notify('Password must be exactly 4 digits', 'error');
                }
                
                // Name: UPPERCASE only, max 15 characters
                if (name !== name.toUpperCase()) {
                    return this.notify('Name must be in UPPERCASE letters only', 'error');
                }
                if (name.length > 15) {
                    return this.notify('Name must be maximum 15 characters', 'error');
                }
                
                // Check role limits
                const counts = this.store.getCounts();
                if (role === 'admin' && counts.admins >= 5) return this.notify('Max 5 Admins', 'warning');
                if (role === 'agent' && counts.agents >= 10) return this.notify('Max 10 Agents', 'warning');
                this.store.addUser({ username: username, password: password, name: name, role: role });
                e.target.reset(); 
                this.renderUserList();
                this.populateAssignedToDropdown();
                if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
            }
            deleteUser(id) { if(confirm('Remove user?')) { if(!this.store.deleteUser(id)) this.notify('Cannot delete Superuser', 'error'); this.renderUserList(); } }
            renderUserList() {
                const c = document.getElementById('userListContainer');
                const counts = this.store.getCounts();
                document.getElementById('userLimitMsg').textContent = `Admins: ${counts.admins}/5 | Agents: ${counts.agents}/10`;
                c.innerHTML = this.store.users.map(u => `<div class="flex justify-between items-center p-3 bg-white border border-slate-100 rounded-lg"><div><div class="font-bold text-sm text-slate-800">${u.name} <span class="text-xs text-slate-400">(${u.username})</span></div><div class="text-xs uppercase font-bold text-primary bg-primary/5 w-fit px-1.5 rounded mt-0.5">${u.role}</div></div>${u.role !== 'superuser' ? `<button onclick="app.deleteUser('${u.id}')" class="text-red-400 p-2"><i class="ph-bold ph-trash"></i></button>` : ''}</div>`).join('');
            }
            async handleSaveAppConfig(e) {
                e.preventDefault();
                await this.store.saveConfig({ appTitle: e.target.appTitle.value, dbUrl: e.target.dbUrl.value });
                this.applyConfig();
                if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
                this.notify('Saved & Synced', 'success');
            }

            checkDuplicatePhone(phoneNumber) {
                const duplicateLead = this.store.state.find(l => l.phone === phoneNumber);
                return duplicateLead || null;
            }

            handleFormSubmit(e) {
                e.preventDefault();
                const f = e.target;
                const prefix = f.phonePrefix.value || '';
                const num = f.phone.value || '';
                const fullPhone = num ? (prefix + ' ' + num) : '';

                // Phone number validation: must not be empty
                if (!num || num.length < 10) {
                    // Show error message (simple alert or custom UI)
                    if (!document.getElementById('phoneErrorMsg')) {
                        const phoneInput = f.phone;
                        const err = document.createElement('div');
                        err.id = 'phoneErrorMsg';
                        err.className = 'text-red-500 text-xs mt-1';
                        err.textContent = 'Phone number is required (10 digits)';
                        phoneInput.parentNode.appendChild(err);
                    }
                    f.phone.focus();
                    return;
                } else {
                    // Remove error if present
                    const err = document.getElementById('phoneErrorMsg');
                    if (err) err.remove();
                }

                // Check if status is being changed to "Lost" and intercept
                const newStatus = f.status.value;
                const leadId = f.leadId.value;
                if (leadId && newStatus === 'Lost') {
                    const currentLead = this.store.state.find(l => l.id === leadId);
                    if (currentLead && currentLead.status !== 'Lost') {
                        // Status is changing TO Lost - show the reason modal
                        this._pendingFormData = {
                            leadId: leadId,
                            name: f.name.value,
                            interest: f.interest.value,
                            value: parseFloat(f.value.value) || 0,
                            temperature: f.temperature.value,
                            email: f.email.value,
                            location: f.querySelector('input[name="location"]').value,
                            source: f.querySelector('input[name="source"]').value,
                            assignedTo: f.assignedTo.value || currentLead.assignedTo,
                            phone: fullPhone,
                            notes: f.notes.value
                        };
                        this.showLostReasonModal(leadId);
                        return;
                    }
                }

                // Get the existing lead if editing
                let existingLead = null;
                if (f.leadId.value) {
                    existingLead = this.store.state.find(l => l.id === f.leadId.value);
                }
                
                // Optimistic Locking: Check for conflicts if editing an existing lead
                if (f.leadId.value && existingLead && this._editingLeadSnapshot) {
                    const hasConflict = this._detectLeadConflict(this._editingLeadSnapshot, existingLead);
                    if (hasConflict) {
                        this.showConflictDialog(f.leadId.value, this._editingLeadSnapshot, existingLead, {
                            name: f.name.value,
                            interest: f.interest.value,
                            value: parseFloat(f.value.value) || 0,
                            status: f.status.value,
                            temperature: f.temperature.value,
                            email: f.email.value,
                            location: f.querySelector('input[name="location"]').value,
                            source: f.querySelector('input[name="source"]').value,
                            assignedTo: f.assignedTo.value || existingLead.assignedTo,
                            phone: fullPhone,
                            notes: f.notes.value
                        });
                        return;
                    }
                }
                
                // Build the update object, preserving existing assignedTo if agent doesn't change it
                const isFormAdmin = this.currentUser && (this.currentUser.role === 'admin' || this.currentUser.role === 'superuser');
                const d = {
                    name: f.name.value,
                    interest: f.interest.value,
                    value: parseFloat(f.value.value) || 0,
                    status: f.status.value,
                    temperature: f.temperature.value,
                    email: f.email.value,
                    location: f.querySelector('input[name="location"]').value,
                    source: f.querySelector('input[name="source"]').value,
                    // Only admins can change assignedTo; agents always preserve existing value
                    assignedTo: isFormAdmin ? (f.assignedTo.value || (existingLead ? existingLead.assignedTo : '')) : (existingLead ? existingLead.assignedTo : ''),
                    phone: fullPhone,
                    notes: f.notes.value,
                    // Preserve lostReason if status is "Lost", otherwise clear it
                    lostReason: f.status.value === 'Lost' ? (existingLead ? existingLead.lostReason : '') : ''
                };
                let prevAssignedTo = null;
                if (f.leadId.value) {
                    prevAssignedTo = existingLead ? existingLead.assignedTo : null;
                    this.store.update(f.leadId.value, d, this.currentUser);
                } else {
                    // Check for duplicate phone number before adding new lead
                    const duplicateLead = this.checkDuplicatePhone(fullPhone);
                    if (duplicateLead) {
                        // Show prominent error message
                        this.notify(`‚ùå Cannot add lead: ${duplicateLead.name} (${duplicateLead.phone}) already exists`, 'error');
                        // Add visual error indicator to phone input
                        const phoneInput = f.phone;
                        phoneInput.classList.add('border-red-500', 'bg-red-50');
                        phoneInput.focus();
                        return;
                    }
                    // Remove error styling if resubmitting
                    const phoneInput = f.phone;
                    phoneInput.classList.remove('border-red-500', 'bg-red-50');
                    this.store.add(d, this.currentUser);
                    // For new leads, prevAssignedTo is null
                }
                // Show notification if assigned to current user
                this.handleLeadAssignment(d, prevAssignedTo);
                if (typeof this.switchTab === 'function') {
                    this.switchTab(d.status);
                }
                if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
                ui.toggleModal(false);
            }

            // Optimistic Locking: Detect if lead was modified by another user
            _detectLeadConflict(snapshot, current) {
                // Track which fields have changed since snapshot was taken
                const fieldsToCheck = ['name', 'email', 'phone', 'status', 'temperature', 'interest', 'value', 'location', 'source', 'assignedTo', 'notes', 'lostReason'];
                const conflicts = [];
                
                fieldsToCheck.forEach(field => {
                    const snapVal = snapshot[field];
                    const currVal = current[field];
                    if (snapVal !== currVal) {
                        conflicts.push(field);
                    }
                });
                
                return conflicts.length > 0;
            }

            // Show conflict resolution dialog
            showConflictDialog(leadId, snapshot, current, userChanges) {
                const modal = document.createElement('div');
                modal.id = 'conflictModal';
                modal.className = 'fixed inset-0 z-[150] flex items-center justify-center hidden';
                
                // Build comparison HTML
                const changedFields = ['name', 'email', 'phone', 'status', 'temperature', 'interest', 'value', 'location', 'source', 'assignedTo', 'notes'];
                const conflicts = [];
                changedFields.forEach(field => {
                    if (snapshot[field] !== current[field]) {
                        conflicts.push({
                            field,
                            yours: userChanges[field] !== undefined ? userChanges[field] : snapshot[field],
                            theirs: current[field],
                            current: current[field]
                        });
                    }
                });
                
                let conflictHTML = conflicts.map(c => `
                    <div class="border-l-4 border-orange-400 bg-orange-50 p-4 rounded-r-lg mb-3">
                        <div class="font-semibold text-sm text-orange-900 capitalize">${c.field}</div>
                        <div class="grid grid-cols-2 gap-4 mt-2 text-xs">
                            <div>
                                <div class="text-slate-500 font-medium">Your change:</div>
                                <div class="text-slate-700 font-mono bg-white p-2 rounded mt-1 break-all">${this.escapeHtml(String(c.yours || ''))}</div>
                            </div>
                            <div>
                                <div class="text-slate-500 font-medium">Other user changed to:</div>
                                <div class="text-slate-700 font-mono bg-white p-2 rounded mt-1 break-all">${this.escapeHtml(String(c.current || ''))}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                modal.innerHTML = `
                    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="document.getElementById('conflictModal').remove()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 p-6 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold text-slate-800 mb-2 flex items-center gap-2">
                            <i class="ph-bold ph-warning text-orange-500 text-2xl"></i> Conflict Detected
                        </h3>
                        <p class="text-sm text-slate-600 mb-4">
                            Another user modified this lead while you were editing it. Choose how to resolve the conflict:
                        </p>
                        
                        <div class="bg-slate-50 p-4 rounded-lg mb-6 border border-slate-200">
                            ${conflictHTML}
                        </div>
                        
                        <div class="flex gap-3">
                            <button type="button" onclick="document.getElementById('conflictModal').remove()" class="flex-1 bg-slate-200 text-slate-700 font-bold py-2.5 rounded-lg hover:bg-slate-300 transition">
                                Cancel & Reload
                            </button>
                            <button type="button" onclick="window.app._resolveConflict('${leadId}', 'theirs')" class="flex-1 bg-orange-500 text-white font-bold py-2.5 rounded-lg hover:bg-orange-600 transition">
                                Use Their Changes
                            </button>
                            <button type="button" onclick="window.app._resolveConflict('${leadId}', 'yours')" class="flex-1 bg-primary text-white font-bold py-2.5 rounded-lg hover:bg-indigo-600 transition">
                                Keep My Changes
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            // Resolve conflict by choosing one version
            _resolveConflict(leadId, choice) {
                const modal = document.getElementById('conflictModal');
                if (modal) modal.remove();
                
                if (choice === 'theirs') {
                    // Reload the lead from server and close modal
                    const freshLead = this.store.state.find(l => l.id === leadId);
                    if (freshLead) {
                        this.notify('Conflict resolved: Using other user\'s changes', 'info');
                        this._editingLeadSnapshot = null;
                        ui.toggleModal(false);
                        this.render(this.store.state);
                    }
                } else if (choice === 'yours') {
                    // Re-trigger form submission with current user's changes
                    const form = document.getElementById('leadForm');
                    if (form) {
                        // Update snapshot to current state and retry submit
                        this._editingLeadSnapshot = this.store.state.find(l => l.id === leadId);
                        this.handleFormSubmit({ preventDefault: () => {}, target: form });
                    }
                }
            }

            showLostReasonModal(leadId) {
                this._pendingLostLeadId = leadId;
                document.getElementById('lostReasonModal').classList.remove('hidden');
            }

            closeLostReasonModal() {
                document.getElementById('lostReasonModal').classList.add('hidden');
                this._pendingLostLeadId = null;
                // Clear radio selection
                document.querySelectorAll('input[name="lostReason"]').forEach(r => r.checked = false);
                // Clear custom input
                document.getElementById('customReasonInput').value = '';
                document.getElementById('customReasonContainer').classList.add('hidden');
            }

            showLostReasonDetails() {
                const selectedReason = document.querySelector('input[name="lostReason"]:checked')?.value;
                const container = document.getElementById('customReasonContainer');
                const textarea = document.getElementById('customReasonInput');
                
                if (selectedReason) {
                    container.classList.remove('hidden');
                    textarea.placeholder = `Enter details for: ${selectedReason}`;
                    textarea.focus();
                } else {
                    container.classList.add('hidden');
                    textarea.value = '';
                }
            }

            toggleOtherReasonInput(show) {
                // This function is deprecated but kept for backward compatibility
                this.showLostReasonDetails();
            }

            confirmLostReason() {
                const selectedReason = document.querySelector('input[name="lostReason"]:checked')?.value;
                if (!selectedReason) {
                    this.notify('Please select a reason for the loss', 'error');
                    return;
                }

                // Require details for ALL reasons, not just "Other"
                const customDetails = document.getElementById('customReasonInput').value.trim();
                if (!customDetails) {
                    this.notify('Please enter details about why this lead was lost', 'error');
                    document.getElementById('customReasonInput').focus();
                    return;
                }

                // Append details to the selected reason
                const finalReason = `${selectedReason}: ${customDetails}`;

                if (this._pendingLostLeadId) {
                    // If we have pending form data, use it (came from form edit)
                    if (this._pendingFormData) {
                        const formData = { ...this._pendingFormData, status: 'Lost', lostReason: finalReason };
                        this.store.update(this._pendingLostLeadId, formData, this.currentUser);
                        this._pendingFormData = null;
                    } else {
                        // Came from drag-drop
                        this.store.update(this._pendingLostLeadId, { status: 'Lost', lostReason: finalReason }, this.currentUser);
                    }
                    this.closeLostReasonModal();
                    if (typeof this.renderCards === 'function') this.renderCards();
                    if (typeof this.renderTable === 'function') this.renderTable(this.store.state);
                    if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
                }
            }

            handleAddActivity(e) {
                e.preventDefault();
                const f = e.target;
                const id = document.getElementById('leadIdInput').value;
                const type = f.type.value;
                let note = f.noteText.value;
                if(type==='follow_up') note = f.noteDate.value;
                else if(type==='file') note = f.noteFile.files[0]?.name || 'File';
                
                if(id && note) {
                    this.store.addActivity(id, { type, note }, this.currentUser);
                    f.noteText.value = ''; f.noteDate.value = ''; f.noteFile.value = '';
                    this.renderTimeline(this.store.state.find(l => l.id === id));
                }
            }

            handleAddTask(e) {
                e.preventDefault();
                const id = document.getElementById('leadIdInput').value;
                const title = document.getElementById('taskInput').value;
                const taskNote = document.getElementById('taskNote').value;
                const dueDate = document.getElementById('taskDueDate').value;
                
                if(id && title) {
                    const lead = this.store.state.find(l => l.id === id);
                    if(lead) {
                        if(!lead.tasks) lead.tasks = [];
                        lead.tasks.push({ id: this.store.generateId(), title, note: taskNote, dueDate, status: 'pending', createdAt: new Date().toISOString() });
                        // Add activity log for task creation
                        const activityNote = `Task created: Pending: ${title}${taskNote ? ' - ' + taskNote : ''}${dueDate ? ' (Due: ' + this.formatDate(dueDate) + ')' : ''}`;
                        this.store.addActivity(id, { type: 'task', note: activityNote }, this.currentUser);
                        // Add follow-up activity if due date exists
                        if(dueDate) {
                            this.store.addActivity(id, { type: 'follow_up', note: dueDate }, this.currentUser);
                        }
                        this.store.save();
                        document.getElementById('taskInput').value = '';
                        document.getElementById('taskNote').value = '';
                        document.getElementById('taskNoteCount').textContent = '0/15';
                        document.getElementById('taskDueDate').value = '';
                        this.renderTaskView(lead);
                    }
                }
            }

            validateTaskNoteLength(textarea) {
                const words = textarea.value.trim().split(/\s+/).filter(w => w.length > 0);
                const wordCount = textarea.value.trim() === '' ? 0 : words.length;
                const countDisplay = document.getElementById('taskNoteCount');
                
                if (wordCount > 15) {
                    textarea.value = words.slice(0, 15).join(' ');
                    countDisplay.textContent = '15/15';
                } else {
                    countDisplay.textContent = wordCount + '/15';
                }
                
                if (wordCount > 12) {
                    countDisplay.classList.add('text-amber-600');
                } else {
                    countDisplay.classList.remove('text-amber-600');
                }
            }
            moveLead(id, s) { 
                // If moving to "Lost", show the reason modal
                if (s === 'Lost') {
                    const lead = this.store.state.find(l => l.id === id);
                    if (lead && lead.status !== 'Lost') {
                        this.showLostReasonModal(id);
                        return;
                    }
                } else {
                    // If moving away from "Lost", clear the lostReason
                    const lead = this.store.state.find(l => l.id === id);
                    if (lead && lead.status === 'Lost') {
                        this.store.update(id, { status: s, lostReason: '' }, this.currentUser);
                        return;
                    }
                }
                this.store.updateStatus(id, s, this.currentUser); 
            }
            deleteLead(id) { 
                if(this.currentUser.role==='agent') return this.notify('Access Denied', 'error');
                if(confirm('Delete?')) this.store.delete(id, this.currentUser); 
            }
            
            render(leads) {
                // Filter for agent/user: only show assigned leads
                let filteredLeads = leads;
                if (this.currentUser && (this.currentUser.role === 'agent' || this.currentUser.role === 'user')) {
                    filteredLeads = leads.filter(lead => lead.assignedTo === this.currentUser.username || lead.assignedTo === this.currentUser.id);
                }
                if (this.activeView === 'table') { this.renderTable(filteredLeads); this.renderLeaderboard(); return; }
                const b = document.getElementById('boardContainer'); b.innerHTML = '';
                this.statusConfig.forEach(s => {
                    const sl = filteredLeads.filter(l => l.status === s.id);
                    const sum = sl.reduce((a,c) => a + (c.value||0), 0);
                    const hide = this.activeMobileTab !== s.id ? 'hidden md:flex' : 'flex';
                    b.innerHTML += `
                        <div class="kanban-column ${hide} flex-col h-full w-full md:w-80 md:bg-slate-100 md:rounded-xl md:border md:border-slate-200 overflow-hidden shrink-0">
                            <div class="px-4 py-3 md:bg-white md:border-b md:border-slate-200 flex justify-between items-center shrink-0">
                                <div class="flex items-center gap-2"><div class="w-2.5 h-2.5 rounded-full ${s.color}"></div><h2 class="font-bold text-slate-700">${s.id}</h2></div>
                                <span class="bg-slate-200 text-slate-600 text-xs font-bold px-2 py-0.5 rounded-full">${sl.length}</span>
                            </div>
                            <div class="flex-1 overflow-y-auto p-3 space-y-3 overscroll-contain">
                                ${sl.length===0 ? '<div class="flex flex-col items-center justify-center h-48 text-slate-400 opacity-60"><i class="ph-duotone ph-ghost text-4xl mb-2"></i><p class="text-sm">Empty</p></div>' : sl.map(l => this.createCardHTML(l)).join('')}
                                <div class="h-20 md:hidden"></div>
                            </div>
                            <div class="bg-white/50 border-t border-slate-200 p-2 text-center text-xs text-slate-500 font-medium">Total: ${this.formatCurrency(sum)}</div>
                        </div>`;
                });
                this.renderLeaderboard();

            }



            filterLeadsByDate(leads) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                return leads.filter(lead => {
                    if (!lead.createdAt) return false;
                    const leadDate = new Date(lead.createdAt);
                    leadDate.setHours(0, 0, 0, 0);
                    
                    switch (this.dateFilter) {
                        case 'this-day':
                            return leadDate.getTime() === today.getTime();
                        case 'this-week': {
                            const weekStart = new Date(today);
                            weekStart.setDate(today.getDate() - today.getDay());
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekStart.getDate() + 6);
                            return leadDate >= weekStart && leadDate <= weekEnd;
                        }
                        case 'this-month':
                            return leadDate.getMonth() === today.getMonth() && leadDate.getFullYear() === today.getFullYear();
                        case 'this-year':
                            return leadDate.getFullYear() === today.getFullYear();
                        case 'till-date':
                        default:
                            return true;
                    }
                });
            }

            generateReportData() {
                let leads = this.store.state;
                
                // Apply date filter
                leads = this.filterLeadsByDate(leads);
                
                const totalLeads = leads.length;
                const totalValue = leads.reduce((sum, l) => sum + (l.value || 0), 0);
                const wonLeads = leads.filter(l => l.status === 'Won').length;
                const conversionRate = totalLeads > 0 ? ((wonLeads / totalLeads) * 100).toFixed(1) : 0;
                
                // Pipeline breakdown
                const pipelineData = {};
                this.statusConfig.forEach(s => {
                    pipelineData[s.id] = leads.filter(l => l.status === s.id).length;
                });
                
                // Lost reasons breakdown - extract base reason (before the colon)
                const lostLeads = leads.filter(l => l.status === 'Lost');
                const lostReasonsData = {};
                lostLeads.forEach(l => {
                    // Extract base reason (format is "Reason: Details" or just "Reason")
                    const fullReason = l.lostReason || 'Unknown';
                    const baseReason = fullReason.split(':')[0].trim();
                    lostReasonsData[baseReason] = (lostReasonsData[baseReason] || 0) + 1;
                });
                
                // Temperature distribution
                const temperatureData = { Hot: 0, Warm: 0, Cold: 0, 'Not Set': 0 };
                leads.forEach(l => {
                    const temp = l.temperature || 'Not Set';
                    if (temperatureData.hasOwnProperty(temp)) temperatureData[temp]++;
                    else temperatureData['Not Set']++;
                });
                
                // Agent performance
                const agentData = {};
                this.store.users.filter(u => u.role === 'agent' || u.role === 'admin').forEach(user => {
                    const userKey = user.username || user.id;
                    const assigned = leads.filter(l => l.assignedTo === userKey).length;
                    const won = leads.filter(l => l.assignedTo === userKey && l.status === 'Won').length;
                    const lost = leads.filter(l => l.assignedTo === userKey && l.status === 'Lost').length;
                    const winRate = assigned > 0 ? ((won / assigned) * 100).toFixed(1) : 0;
                    agentData[userKey] = { name: user.name, assigned, won, lost, winRate };
                });
                
                return { totalLeads, totalValue, conversionRate, wonLeads, pipelineData, lostReasonsData, temperatureData, agentData };
            }

            renderReports() {
                // Destroy existing charts before re-rendering
                this.destroyCharts();
                
                const data = this.generateReportData();
                this.renderReportKPIs(data);
                this.renderPipelineFunnelChart(data);
                this.renderLostReasonsChart(data);
                this.renderTemperatureChart(data);
                this.renderAgentLeaderboard(data);
            }

            destroyCharts() {
                Object.keys(this.chartInstances).forEach(key => {
                    if (this.chartInstances[key]) {
                        this.chartInstances[key].destroy();
                        delete this.chartInstances[key];
                    }
                });
            }

            setupDateFilter() {
                const dropdown = document.getElementById('dateFilterDropdown');
                if (dropdown) {
                    dropdown.removeEventListener('change', this.dateFilterHandler);
                    this.dateFilterHandler = (e) => {
                        this.dateFilter = e.target.value;
                        this.renderReports();
                    };
                    dropdown.addEventListener('change', this.dateFilterHandler);
                }
            }

            renderReportKPIs(data) {
                const kpiContainer = document.getElementById('kpiCardsContainer');
                kpiContainer.innerHTML = `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 text-sm font-medium">Total Leads</p>
                                <p class="text-3xl font-bold text-slate-800 mt-1">${data.totalLeads}</p>
                            </div>
                            <i class="ph-bold ph-users text-4xl text-blue-500 opacity-20"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 text-sm font-medium">Pipeline Value</p>
                                <p class="text-3xl font-bold text-slate-800 mt-1">${this.formatCurrency(data.totalValue)}</p>
                            </div>
                            <i class="ph-bold ph-currency-inr text-4xl text-green-500 opacity-20"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 text-sm font-medium">Conversion Rate</p>
                                <p class="text-3xl font-bold text-slate-800 mt-1">${data.conversionRate}%</p>
                            </div>
                            <i class="ph-bold ph-trend-up text-4xl text-purple-500 opacity-20"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 text-sm font-medium">Won Deals</p>
                                <p class="text-3xl font-bold text-slate-800 mt-1">${data.wonLeads}</p>
                            </div>
                            <i class="ph-bold ph-trophy text-4xl text-amber-500 opacity-20"></i>
                        </div>
                    </div>
                `;
            }

            renderPipelineFunnelChart(data) {
                const ctx = document.getElementById('pipelineFunnelChart');
                if (!ctx) return;
                
                const labels = this.statusConfig.map(s => s.id);
                const values = labels.map(label => data.pipelineData[label] || 0);
                const colors = this.statusConfig.map(s => s.color.replace('bg-', '').split('-')[0]);
                
                this.chartInstances.pipelineFunnelChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Leads by Status',
                            data: values,
                            backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#ef4444'],
                            borderRadius: 6,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }

            renderLostReasonsChart(data) {
                const ctx = document.getElementById('lostReasonsChart');
                if (!ctx) return;
                
                // Emoji map for lost reasons
                const emojiMap = {
                    'Price too high': 'üí∞',
                    'Not interested': 'üòï',
                    'Competitor': 'üèÜ',
                    'Invalid Number': 'üìû',
                    'Duplicate': 'üîÑ',
                    'Other': 'üìù',
                    'Unknown': '‚ùì'
                };
                
                const reasons = Object.keys(data.lostReasonsData);
                const values = Object.values(data.lostReasonsData);
                const colors = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#06b6d4', '#9ca3af'];
                
                // Add emoji to labels
                const labels = reasons.map(reason => {
                    const emoji = emojiMap[reason] || '‚ùì';
                    return `${emoji} ${reason}`;
                });
                
                this.chartInstances.lostReasonsChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors.slice(0, reasons.length),
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 } } }
                        }
                    }
                });
            }

            renderTemperatureChart(data) {
                const ctx = document.getElementById('temperatureChart');
                if (!ctx) return;
                
                const labels = ['Hot', 'Warm', 'Cold', 'Not Set'];
                const values = labels.map(label => data.temperatureData[label] || 0);
                
                this.chartInstances.temperatureChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Lead Count',
                            data: values,
                            backgroundColor: ['#ef4444', '#f97316', '#3b82f6', '#9ca3af'],
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        indexAxis: 'x',
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }

            renderAgentLeaderboard(data) {
                const tbody = document.getElementById('agentLeaderboardBody');
                tbody.innerHTML = Object.entries(data.agentData).map(([key, agent]) => `
                    <tr>
                        <td class="py-3 px-4 font-semibold text-slate-800">${this.escapeHtml(agent.name)}</td>
                        <td class="py-3 px-4 text-right">${this.escapeHtml(String(agent.assigned))}</td>
                        <td class="py-3 px-4 text-right"><span class="bg-green-100 text-green-700 text-sm font-bold px-2 py-1 rounded">${this.escapeHtml(String(agent.won))}</span></td>
                        <td class="py-3 px-4 text-right"><span class="bg-red-100 text-red-700 text-sm font-bold px-2 py-1 rounded">${this.escapeHtml(String(agent.lost))}</span></td>
                        <td class="py-3 px-4 text-right"><span class="bg-blue-100 text-blue-700 text-sm font-bold px-2 py-1 rounded">${this.escapeHtml(String(agent.winRate))}%</span></td>
                    </tr>
                `).join('');
            }            createCardHTML(lead) {
                const scores = this.getLeadScores(lead);
                const idx = this.statusConfig.findIndex(s => s.id === lead.status);
                const prev = idx > 0 ? this.statusConfig[idx-1].id : null;
                const next = idx < this.statusConfig.length-1 ? this.statusConfig[idx+1].id : null;
                const delBtn = (this.currentUser.role==='admin' || this.currentUser.role==='superuser') ? `<button onclick="event.stopPropagation(); app.deleteLead('${lead.id}')" class="text-slate-300 hover:text-red-500 p-2 rounded-full active:bg-red-50"><i class="ph-bold ph-trash"></i></button>` : '';
                
                // Check for task status
                const isActiveStage = !['Won', 'Lost'].includes(lead.status);
                const taskCount = lead.tasks ? lead.tasks.length : 0;
                const hasPendingTask = lead.tasks && lead.tasks.some(t => t.status === 'pending');
                
                const isNoAction = isActiveStage && taskCount === 0;
                const isNoTask = isActiveStage && taskCount > 0 && !hasPendingTask;
                
                let badge = '';
                if (isNoAction) {
                    badge = `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700 whitespace-nowrap"><i class="ph-bold ph-warning-circle"></i> No Action</span>`;
                } else if (isNoTask) {
                    badge = `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-700 whitespace-nowrap"><i class="ph-bold ph-warning"></i> No Task</span>`;
                }
                
                const rawPhone = lead.phone || '';
                let displayPhone = rawPhone;
                if (rawPhone && !rawPhone.includes('+')) displayPhone = '+91 ' + rawPhone; 
                
                const interests = lead.interest ? lead.interest.split(',').map(i => i.trim()) : [];
                
                // Determine if we need icon-only mode for buttons
                const cardWidth = 320; // Approximate card width

                return `
                    <div onclick="app.editLead('${lead.id}')" class="bg-white rounded-xl shadow-sm border ${isNoAction ? 'border-red-300 bg-red-50/30' : isNoTask ? 'border-amber-300 bg-amber-50/30' : 'border-slate-100'} active:scale-[0.99] transition-transform cursor-pointer ${lead.status === 'Lost' ? 'grayscale opacity-60' : ''} overflow-hidden flex flex-col">
                        <!-- Card Content -->
                        <div class="p-3 flex flex-col gap-1.5 flex-1">
                            <!-- Row 1: Name + Badge -->
                            <div class="flex justify-between items-start gap-1">
                                <h3 class="font-bold text-slate-800 text-xs leading-tight line-clamp-2 flex-1">${this.escapeHtml(lead.name || lead.phone)}</h3>
                                <div class="flex gap-0.5 shrink-0 text-xs">${badge}</div>
                            </div>
                            
                            <!-- Row 2: AssignedTo | Status | Temperature (all in one row) -->
                            <div class="flex items-center gap-1.5 text-xs font-semibold flex-wrap">
                                ${lead.assignedTo ? `<span class="px-2 py-1 rounded-md bg-indigo-100 text-indigo-700 text-[10px] font-bold inline-flex items-center gap-1 whitespace-nowrap">
                                    <i class="ph-bold ph-user text-indigo-600 text-xs"></i>
                                    ${this.escapeHtml(this.getUserName(lead.assignedTo))}
                                </span>` : ''}
                                <span class="px-2 py-1 rounded-md bg-slate-100 text-slate-700 text-[10px] font-bold inline-flex items-center gap-1">
                                    <i class="ph-bold ph-folder text-xs text-slate-600"></i>
                                    ${this.escapeHtml(lead.status)}
                                </span>
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md text-[10px] font-bold ${scores.tempColor}">
                                    <i class="ph-bold ${scores.tempIcon} text-xs"></i>
                                    ${scores.temp || 'N/A'}
                                </span>
                            </div>

                            
                            <!-- Row 3-4: Interests (styled) -->
                            ${interests.length > 0 ? `<div class="flex flex-col gap-0.5 mt-1">
                                ${interests.slice(0, 2).map((i, idx) => `<div class="inline-flex items-center gap-1 px-2 py-1 bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-200 rounded-md text-[11px] font-medium text-indigo-700 line-clamp-1">
                                    <i class="ph-bold ph-star text-indigo-600 text-xs"></i>
                                    <span>${this.escapeHtml(i)}</span>
                                </div>`).join('')}
                                ${interests.length > 2 ? `<div class="text-[10px] font-medium text-slate-400 px-2 py-0.5">+${interests.length - 2} interest${interests.length - 2 > 1 ? 's' : ''}</div>` : ''}
                            </div>` : ''}
                            
                            <!-- Row 5: Value -->
                            <div class="text-sm font-bold text-slate-900 mt-1">${this.formatCurrency(lead.value)}</div>
                            
                            <!-- Row 6: Action Buttons (Icon Only) -->
                            <div class="flex gap-1.5 flex-wrap mt-1.5 w-full">
                                <button onclick="event.stopPropagation(); app.editLead('${lead.id}', 'activity')" title="Activity" class="flex-1 flex items-center justify-center px-3 py-2 bg-blue-50 text-blue-600 rounded-lg border border-blue-200 hover:bg-blue-100 active:bg-blue-200 transition-colors shadow-sm">
                                    <i class="ph-bold ph-chat text-base"></i>
                                </button>
                                <button onclick="event.stopPropagation(); app.editLead('${lead.id}', 'task')" title="Task" class="flex-1 flex items-center justify-center px-3 py-2 ${isNoAction ? 'bg-red-50 text-red-600 border-red-200 hover:bg-red-100' : isNoTask ? 'bg-amber-50 text-amber-600 border-amber-200 hover:bg-amber-100' : 'bg-purple-50 text-purple-600 border-purple-200 hover:bg-purple-100'} rounded-lg border transition-colors shadow-sm">
                                    <i class="ph-bold ph-plus text-base"></i>
                                </button>
                                ${lead.phone ? `
                                <a href="tel:${lead.phone.replace(/\s+/g,'')}" onclick="event.stopPropagation()" title="Call" class="flex-1 flex items-center justify-center px-3 py-2 bg-orange-50 text-orange-600 rounded-lg border border-orange-200 hover:bg-orange-100 active:bg-orange-200 transition-colors shadow-sm">
                                    <i class="ph-fill ph-phone text-base"></i>
                                </a>
                                <a href="https://wa.me/${lead.phone.replace(/\D/g,'')}" target="_blank" onclick="event.stopPropagation()" title="WhatsApp" class="flex-1 flex items-center justify-center px-3 py-2 bg-green-50 text-green-600 rounded-lg border border-green-200 hover:bg-green-100 active:bg-green-200 transition-colors shadow-sm">
                                    <i class="ph-fill ph-whatsapp-logo text-base"></i>
                                </a>
                                ` : ''}
                            </div>
                            
                            <!-- Row 7: Notes (single line) -->
                            ${lead.notes ? `<div class="text-[10px] text-slate-600 bg-slate-50 p-1.5 rounded line-clamp-1 mt-1 truncate">${this.escapeHtml(lead.notes)}</div>` : ''}
                        </div>
                        
                        <!-- Navigation Buttons -->
                        <div class="flex gap-1.5 p-2 border-t border-slate-100 bg-slate-50 mt-auto">
                            ${prev ? `<button onclick="event.stopPropagation(); app.moveLead('${lead.id}', '${prev}')" title="Move left" class="flex items-center justify-center flex-1 py-1.5 bg-slate-200 text-slate-700 rounded text-xs font-semibold hover:bg-slate-300 active:bg-slate-400 transition-colors"><i class="ph-bold ph-arrow-left text-xs"></i></button>` : '<div class="flex-1"></div>'}
                            ${next ? `<button onclick="event.stopPropagation(); app.moveLead('${lead.id}', '${next}')" title="Move right" class="flex items-center justify-center flex-1 py-1.5 bg-primary/15 text-primary rounded text-xs font-semibold hover:bg-primary/25 active:bg-primary/35 transition-colors"><i class="ph-bold ph-arrow-right text-xs"></i></button>` : '<div class="flex-1"></div>'}
                        </div>
                    </div>`;
            }

            renderFollowUps() {
                const today = new Date().toISOString().split('T')[0];
                let od=[], td=[], uc=[];
                
                // Get selected agent filter
                const filterSelect = document.getElementById('followUpAgentFilter');
                const selectedAgent = filterSelect ? filterSelect.value : '';
                
                // Show filter only for admin/superuser
                if (filterSelect) {
                    if (this.currentUser && (this.currentUser.role === 'admin' || this.currentUser.role === 'superuser')) {
                        filterSelect.style.display = 'block';
                        // Populate agent filter dropdown (only populate once)
                        if (filterSelect.options.length === 1) {
                            const agents = new Set();
                            this.store.state.forEach(l => {
                                if (l.assignedTo) agents.add(l.assignedTo);
                            });
                            // Sort agents and add to dropdown
                            Array.from(agents).sort().forEach(agent => {
                                const agentName = this.getUserName(agent);
                                const opt = document.createElement('option');
                                opt.value = agent;
                                opt.textContent = agentName;
                                filterSelect.appendChild(opt);
                            });
                        }
                    } else {
                        filterSelect.style.display = 'none';
                    }
                }
                
                // Filter for agent/user: only show follow-ups for assigned leads
                let leads = this.store.state;
                if (this.currentUser && (this.currentUser.role === 'agent' || this.currentUser.role === 'user')) {
                    leads = leads.filter(lead => lead.assignedTo === this.currentUser.username || lead.assignedTo === this.currentUser.id);
                } else if (selectedAgent && this.currentUser && (this.currentUser.role === 'admin' || this.currentUser.role === 'superuser')) {
                    // Admin/Superuser can filter by selected agent
                    leads = leads.filter(lead => lead.assignedTo === selectedAgent);
                }
                
                // Exclude Won and Lost leads from follow-ups
                leads = leads.filter(lead => lead.status !== 'Won' && lead.status !== 'Lost');
                
                leads.forEach(l => {
                    const f = l.activities?.find(a => a.type==='follow_up');
                    if(f && f.note) {
                        const d = { ...l, followUpDate: f.note };
                        if(f.note < today) od.push(d); else if(f.note === today) td.push(d); else uc.push(d);
                    }
                });
                const ri = (l) => `<button onclick="app.openLeadFromMenu('${l.id}')" class="w-full text-left px-4 py-3 hover:bg-slate-50 flex justify-between items-center group"><div><div class="font-bold text-slate-700 text-sm group-hover:text-primary">${this.escapeHtml(l.name)}</div><div class="text-xs text-slate-400 mt-0.5">${this.formatDate(l.followUpDate)}</div></div><i class="ph-bold ph-caret-right text-slate-300"></i></button>`;
                document.getElementById('count-overdue').textContent = od.length; document.getElementById('list-overdue').innerHTML = od.map(ri).join('');
                document.getElementById('count-today').textContent = td.length; document.getElementById('list-today').innerHTML = td.map(ri).join('');
                document.getElementById('count-upcoming').textContent = uc.length; document.getElementById('list-upcoming').innerHTML = uc.map(ri).join('');
            }

            renderLogs() {
                const c = document.getElementById('logsContainer');
                if(this.store.logs.length === 0) return c.innerHTML = '<div class="p-8 text-center text-slate-400"><p class="text-sm">No logs</p></div>';
                c.innerHTML = this.store.logs.map(l => `<div class="px-6 py-4 flex gap-3 hover:bg-white"><div class="flex-col pt-1"><div class="w-2 h-2 rounded-full bg-slate-300"></div></div><div><div class="text-xs text-slate-400 mb-0.5">${this.formatDateTime(l.timestamp)}</div><div class="text-sm text-slate-700 font-medium">${this.escapeHtml(l.message)}</div></div></div>`).join('');
            }

            switchModalTab(t) {
                this.currentModalTab = t;
                ['info','activity','task','contact'].forEach(x => {
                    document.getElementById(`tab-btn-${x}`).className = x===t ? 'tab-active pb-3 font-semibold text-sm transition-colors whitespace-nowrap' : 'tab-inactive pb-3 font-semibold text-sm transition-colors whitespace-nowrap';
                    document.getElementById(`view-${x}`).classList.toggle('hidden', x!==t);
                    if(document.getElementById(`footer-${x}`)) document.getElementById(`footer-${x}`).classList.toggle('hidden', x!==t);
                });
                // Render content for activity/contact tabs
                const leadId = document.getElementById('leadIdInput').value;
                const lead = this.store.state.find(l => l.id === leadId);
                if (t === 'activity' && lead) this.renderTimeline(lead);
                if (t === 'task' && lead) this.renderTaskView(lead);
                if (t === 'contact' && lead) this.renderContactView(lead);
            }

            renderContactView(lead) {
                const c = document.getElementById('contactActions');
                if(!lead.phone) return c.innerHTML = '<div class="text-center text-slate-400"><p>No Phone</p></div>';
                const phoneStr = String(lead.phone || '');
                const cp = phoneStr.replace(/\D/g, '');
                c.innerHTML = `
                    <a href="tel:+91${cp}" class="w-full bg-green-500 text-white rounded-2xl py-6 flex flex-col items-center justify-center gap-2 shadow-lg active:scale-95 transition"><i class="ph-fill ph-phone text-4xl"></i><span class="text-xl font-bold">Call</span><span class="text-sm opacity-90">${phoneStr}</span></a>
                    <a href="https://wa.me/91${cp}" target="_blank" class="w-full bg-[#25D366] text-white rounded-2xl py-6 flex flex-col items-center justify-center gap-2 shadow-lg active:scale-95 transition"><i class="ph-fill ph-whatsapp-logo text-4xl"></i><span class="text-xl font-bold">WhatsApp</span><span class="text-sm opacity-90">Open Chat</span></a>`;
            }

            renderTaskView(lead) {
                const t = document.getElementById('taskList');
                if(!lead.tasks || lead.tasks.length === 0) {
                    return t.innerHTML = '<div class="text-center text-slate-400 py-8"><p>No tasks yet</p></div>';
                }
                t.innerHTML = lead.tasks.map((task, i) => `
                    <div onclick="app.openTaskDetail('${lead.id}', ${i})" class="bg-slate-50 border border-slate-200 rounded-xl p-3 flex items-center justify-between gap-3 cursor-pointer hover:bg-slate-100 transition">
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-slate-700 break-words">${this.escapeHtml(task.title)}</p>
                            ${task.note ? `<p class="text-xs text-slate-600 mt-1 break-words">${this.escapeHtml(task.note)}</p>` : ''}
                            <div class="flex gap-3 items-center mt-2 text-xs text-slate-500">
                                <span class="px-2 py-1 rounded-full ${task.status === 'completed' ? 'bg-green-100 text-green-700' : task.status === 'dropped' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'} font-medium">${task.status || 'pending'}</span>
                                <span>${task.dueDate ? this.formatDate(task.dueDate) : ''}</span>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); app.deleteTask('${lead.id}', ${i})" class="text-slate-400 hover:text-red-500 transition p-1 shrink-0" title="Delete task"><i class="ph ph-trash text-lg"></i></button>
                    </div>
                `).join('');
            }

            openTaskDetail(leadId, taskIndex) {
                this.currentEditingTask = { leadId, taskIndex };
                const lead = this.store.state.find(l => l.id === leadId);
                if(!lead || !lead.tasks || !lead.tasks[taskIndex]) return;
                const task = lead.tasks[taskIndex];
                document.getElementById('taskDetailTitle').textContent = this.escapeHtml(task.title);
                document.getElementById('taskDetailInfo').innerHTML = `
                    <div><strong>Status:</strong> ${task.status || 'pending'}</div>
                    <div><strong>Due Date:</strong> ${task.dueDate ? this.formatDate(task.dueDate) : 'No due date'}</div>
                `;
                document.getElementById('taskNoteBox').value = task.note || '';
                document.getElementById('taskDetailForm').classList.remove('hidden');
            }

            closeTaskDetail() {
                document.getElementById('taskDetailForm').classList.add('hidden');
                this.currentEditingTask = null;
            }

            updateTaskStatus(status) {
                if(!this.currentEditingTask) return;
                const noteBox = document.getElementById('taskNoteBox');
                const note = noteBox.value.trim();
                
                // Make note mandatory for completed/dropped tasks
                if(!note) {
                    this.notify('Please add a note before completing or dropping the task', 'error');
                    return;
                }
                
                const { leadId, taskIndex } = this.currentEditingTask;
                const lead = this.store.state.find(l => l.id === leadId);
                if(lead && lead.tasks && lead.tasks[taskIndex]) {
                    const taskTitle = lead.tasks[taskIndex].title;
                    lead.tasks[taskIndex].status = status;
                    lead.tasks[taskIndex].note = note;
                    lead.tasks[taskIndex].completedAt = new Date().toISOString();
                    
                    // Add activity log
                    this.store.addActivity(leadId, { type: 'task', note: `Task ${status}: ${taskTitle} - ${note}` }, this.currentUser);
                    
                    // Remove associated follow-up activity
                    if(lead.activities) {
                        lead.activities = lead.activities.filter(a => !(a.type === 'follow_up' && a.note === lead.tasks[taskIndex].dueDate));
                    }
                    
                    this.store.save();
                    this.renderTaskView(lead);
                    this.renderTimeline(lead);
                    this.closeTaskDetail();
                }
            }

            saveTaskNote() {
                if(!this.currentEditingTask) return;
                const { leadId, taskIndex } = this.currentEditingTask;
                const lead = this.store.state.find(l => l.id === leadId);
                if(lead && lead.tasks && lead.tasks[taskIndex]) {
                    lead.tasks[taskIndex].note = document.getElementById('taskNoteBox').value;
                    this.store.save();
                    this.renderTaskView(lead);
                    this.closeTaskDetail();
                }
            }

            deleteTask(leadId, taskIndex) {
                const lead = this.store.state.find(l => l.id === leadId);
                if(lead && lead.tasks) {
                    const deletedTask = lead.tasks[taskIndex];
                    const taskTitle = deletedTask ? deletedTask.title : 'Unknown Task';
                    lead.tasks.splice(taskIndex, 1);
                    // Log activity when task is deleted
                    this.store.addActivity(leadId, { type: 'task', note: `Task deleted: ${taskTitle}` }, this.currentUser);
                    this.store.save();
                    this.renderTaskView(lead);
                }
            }

            handleTypeChange(s) {
                const t = document.getElementById('activityInputText'), d = document.getElementById('activityInputDate'), f = document.getElementById('activityInputFile');
                t.classList.add('hidden'); d.classList.add('hidden'); f.classList.add('hidden');
                t.required = false; d.required = false;
                if(s.value==='follow_up') { d.classList.remove('hidden'); d.required = true; }
                else if(s.value==='file') { f.classList.remove('hidden'); }
                else { t.classList.remove('hidden'); t.required = true; }
            }

            openLeadFromMenu(id) { ui.toggleMenu(false); setTimeout(() => this.editLead(id, 'activity'), 150); }
            formatCurrency(v) { return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(v||0); }
            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }

            formatDateTime(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                let hours = date.getHours();
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12;
                return `${day}/${month}/${year} ${hours}:${minutes} ${ampm}`;
            }

            escapeHtml(s) { if(!s && s !== 0) return ''; const str = String(s); return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        }

        const ui = {
                                    toggleNotificationBox: () => {
                                        const box = document.getElementById('notificationBox');
                                        if (box) {
                                            box.classList.toggle('hidden');
                                            if (!box.classList.contains('hidden')) {
                                                app.loadNotifications();
                                            }
                                        }
                                    },
                                    updateNotificationBadge: () => {
                                        const count = document.getElementById('notificationCount');
                                        if (app._notifications && app._notifications.length > 0) {
                                            count.textContent = app._notifications.length;
                                            count.style.display = '';
                                        } else {
                                            count.style.display = 'none';
                                        }
                                    },
                                    updateMobileNav: () => {
                                        const currentView = app.currentView || 'kanban';
                                        ['kanban', 'table', 'reports'].forEach(view => {
                                            const btn = document.getElementById(`nav${view.charAt(0).toUpperCase() + view.slice(1)}`);
                                            if (btn) btn.classList.toggle('active', view === currentView);
                                        });
                                    },
                                    updateKanbanTabs: () => {
                                        const container = document.getElementById('mobileTabs');
                                        if (!container) return;
                                        const tabs = app.statusConfig.map(s => {
                                            const isActive = s.id === app.activeMobileTab ? 'active' : '';
                                            return `<button onclick="app.activeMobileTab='${s.id}'; app.render(app.store.state)" class="mobile-tab-btn ${isActive}">${s.id}</button>`;
                                        }).join('');
                                        container.innerHTML = tabs;
                                    },
                        hideNotification: () => {
                            const tray = document.getElementById('notificationTray');
                            if (!tray) return;
                            // Clear any pending auto-hide timeout
                            if (window.app && window.app._notifTimeout) {
                                clearTimeout(window.app._notifTimeout);
                                window.app._notifTimeout = null;
                            }
                            tray.classList.add('opacity-0');
                            tray.classList.remove('opacity-100', 'pointer-events-auto');
                            // Re-add pointer-events-none after transition to prevent accidental clicks
                            setTimeout(() => {
                                if (tray.classList.contains('opacity-0')) {
                                    tray.classList.add('pointer-events-none');
                                }
                            }, 300);
                        },
            toggleModal: (s) => { 
                const m = document.getElementById('leadModal'); 
                if(s) { 
                    if(!document.getElementById('leadIdInput').value) { 
                        document.getElementById('modalTitle').textContent='New Lead'; 
                        document.getElementById('submitBtn').textContent='Save'; 
                        // Call App method safely
                        if (window.app && typeof window.app.switchModalTab === 'function') {
                             window.app.switchModalTab('info');
                             window.app.selectedInterests = []; 
                             window.app.renderInterestTags();
                        }
                        document.getElementById('tab-btn-activity').disabled=true; 
                        document.getElementById('tab-btn-contact').disabled=true;
                        // Clear task input for new leads only
                        const taskInput = document.getElementById('taskInput');
                        if (taskInput) taskInput.value = '';
                    }
                    // Setup autocompletes when modal opens
                    if (window.app && typeof window.app.initSettingsAutocomplete === 'function') {
                        window.app.initSettingsAutocomplete();
                    }
                    m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('open')); 
                    // Add swipe-down handler for mobile
                    if (window.innerWidth < 768) {
                        ui.initModalSwipeClose(m);
                    }
                } else { 
                    m.classList.remove('open'); 
                    setTimeout(()=>{m.classList.add('hidden'); document.getElementById('leadForm').reset(); document.getElementById('leadIdInput').value=''; m.dataset.leadId = ''; if(window.app) window.app._editingLeadSnapshot = null;},300); 
                } 
            },
            initModalSwipeClose: (modal) => {
                if (!modal) return;
                const content = modal.querySelector('.modal-content');
                if (!content) return;
                
                let touchStartY = 0;
                let touchEndY = 0;
                
                const handleSwipeDown = () => {
                    const diff = touchEndY - touchStartY;
                    if (diff > 80) { // Swiped down more than 80px
                        ui.toggleModal(false);
                    }
                };
                
                // Remove previous listeners to avoid duplicates
                content.replaceWith(content.cloneNode(true));
                const newContent = modal.querySelector('.modal-content');
                
                newContent.addEventListener('touchstart', (e) => { touchStartY = e.changedTouches[0].screenY; }, false);
                newContent.addEventListener('touchend', (e) => { touchEndY = e.changedTouches[0].screenY; handleSwipeDown(); }, false);
            },
            toggleMenu: (s) => { const m = document.getElementById('sideMenu'); if(s) { try { window.app.renderFollowUps(); } catch(e){} m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('open')); } else { m.classList.remove('open'); setTimeout(()=>m.classList.add('hidden'),300); } },
            toggleLogs: (s) => { const m = document.getElementById('logsModal'); if(s) { try { window.app.renderLogs(); } catch(e){} m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('open')); } else { m.classList.remove('open'); setTimeout(()=>m.classList.add('hidden'),300); } },
            toggleConfig: (s) => { const m = document.getElementById('configModal'); if(s) { try { window.app.renderUserList(); } catch(e){} m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('open')); } else { m.classList.remove('open'); setTimeout(()=>m.classList.add('hidden'),300); } },
            showLoading: (s, message = 'Syncing changes...') => { 
                const l = document.getElementById('loadingOverlay'); 
                const msg = document.getElementById('loadingText');
                if(s) { 
                    msg.textContent = message;
                    l.classList.remove('hidden'); 
                } else { 
                    l.classList.add('hidden'); 
                    setTimeout(() => { msg.textContent = 'Syncing changes...'; }, 300);
                }
            }
        };

        // Explictly attach to window
        window.app = new App();
        
        // Always update login card/app title on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.app && typeof window.app.applyConfig === 'function') {
                window.app.applyConfig();
            }
            if (window.app && typeof window.app.startAutoSync === 'function') {
                window.app.startAutoSync();
            }
            if (window.app && typeof window.app.renderLeaderboard === 'function') {
                window.app.renderLeaderboard();
            }
        });
    </script>
</body>
</html>