<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <!-- Favicon - Yellow Pacman Ghost -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cpath d='M4 4h24v20c0 0-2-3-4-3s-2 3-4 3-2-3-4-3-2 3-4 3-2-3-4-3-2 3-4 3V4z' fill='%23FFD700'/%3E%3Ccircle cx='10' cy='12' r='2.5' fill='%23000'/%3E%3Ccircle cx='22' cy='12' r='2.5' fill='%23000'/%3E%3Ccircle cx='10' cy='11' r='1' fill='%23fff'/%3E%3Ccircle cx='22' cy='11' r='1' fill='%23fff'/%3E%3C/svg%3E">
    <!-- <meta name="apple-mobile-web-app-capable" content="yes"> -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LeadFlow India</title>
    <!-- Tailwind CSS (CDN used for development only; use npm/PostCSS or Tailwind CLI for production) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <style>
        /* --- Native Feel Tweaks --- */
        body { -webkit-tap-highlight-color: transparent; touch-action: manipulation; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select, textarea { font-size: 16px !important; }
        #leadModal.open .modal-content, #logsModal.open .modal-content, #configModal.open .modal-content { transform: translateY(0); }
        .modal-content { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        #sideMenu.open .menu-panel { transform: translateX(0); }
        #sideMenu .menu-panel { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); transform: translateX(-100%); }
        .tab-active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
        .tab-inactive { color: #64748b; border-bottom: 2px solid transparent; }
        .timeline-line::before { content: ''; position: absolute; left: 1rem; top: 2rem; bottom: -1rem; width: 2px; background-color: #e2e8f0; z-index: 0; }
        .timeline-item:last-child .timeline-line::before { display: none; }
        #loginScreen { z-index: 100; }
        input[type="file"]::file-selector-button { display: none; }
        
        /* Loading Overlay */
        #loadingOverlay { z-index: 9999; }

        /* Table Styles */
        .table-row-hover:hover td { background-color: #f8fafc; }
        
        /* Autocomplete Styles */
        .interest-tag { transition: all 0.2s; }
        .interest-tag:hover { background-color: #e0e7ff; border-color: #c7d2fe; }
        .suggestions-box { 
            z-index: 50; 
            max-height: 200px; 
            overflow-y: auto; 
            position: absolute; 
            top: 100%; 
            left: 0; 
            width: 100%; 
            background: white; 
            border: 1px solid #e2e8f0; 
            border-radius: 0.75rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            margin-top: 4px; 
        }
        
        .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; color: #334155; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #f8fafc; color: #4f46e5; }

        @media (min-width: 768px) {
            .mobile-only { display: none !important; }
            .desktop-only { display: block !important; }
            .kanban-board { display: flex !important; overflow-x: auto; }
            .kanban-column { min-width: 320px; display: flex !important; }
        }
        @media (max-width: 767px) {
            .desktop-only { display: none !important; }
            .kanban-column { display: none; }
            .kanban-column.active-mobile { display: flex; }
            .modal-content { transform: translateY(100%); border-radius: 1.5rem 1.5rem 0 0; height: 90vh; margin-top: auto; }
            #appContent { padding-bottom: 80px; }
            main { padding-bottom: 0; }
            #mobileBottomNav { display: flex; }
            .mobile-fab-adjusted { bottom: 5.5rem !important; }
            #mobileBottomNav .active { background-color: #f1f5f9; color: #4f46e5; }
            #mobileBottomNav .active i { color: #4f46e5; }
            #fabMenu { animation: scaleIn 0.2s ease-out; }
            #fabMenu.hidden { display: none; }
            /* Better touch targets on mobile */
            button, a { min-height: 44px; min-width: 44px; }
            button > *, a > * { pointer-events: none; }
            
            /* Mobile Kanban Tabs - Pill Style */
            #kanbanTabs { padding: 0.75rem 1rem; background: white; border-bottom: 1px solid #f3f4f6; }
            #mobileTabs { display: flex; gap: 0.5rem; overflow-x: auto; -ms-overflow-style: none; scrollbar-width: none; }
            #mobileTabs::-webkit-scrollbar { display: none; }
            .mobile-tab-btn { background: white; border: 1px solid #e5e7eb; border-radius: 9999px !important; padding: 0.5rem 1.25rem !important; font-size: 0.875rem; font-weight: 600; color: #4b5563; white-space: nowrap; cursor: pointer; transition: all 0.2s ease; outline: none; border-bottom: none !important; }
            .mobile-tab-btn.active { background-color: #1f2937 !important; color: white !important; border-color: #1f2937 !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
            #kanbanView .mobile-tab-btn:hover { border-color: #d1d5db; }
            #kanbanView .mobile-tab-btn.active { background-color: #1f2937 !important; color: white !important; border-color: #1f2937 !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
            #kanbanView .mobile-tab-btn i { display: none !important; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8) translateY(10px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        /* Card swipe gestures */
        .card-swipe-container {
            position: relative;
            overflow: hidden;
        }
        .card-swipe-container > div {
            transition: transform 0.3s ease-out;
        }
        .card-swipe-left { animation: swipeLeft 0.3s ease-out forwards; }
        .card-swipe-right { animation: swipeRight 0.3s ease-out forwards; }
        
        @keyframes swipeLeft {
            to { transform: translateX(-100%); opacity: 0; }
        }
        @keyframes swipeRight {
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#4f46e5', secondary: '#64748b', } } } }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 h-[100dvh] w-full flex flex-col overflow-hidden">

    <!-- NOTIFICATION TRAY -->
    <div id="notificationTray" class="fixed top-3 left-1/2 -translate-x-1/2 z-[100] bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 text-sm font-semibold transition-all duration-300 opacity-0 pointer-events-none">
        <i class="ph-bold ph-bell"></i>
        <span id="notificationMessage">You have a new lead assigned!</span>
        <button onclick="ui.hideNotification()" class="ml-4 text-white/80 hover:text-white"><i class="ph-bold ph-x"></i></button>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="fixed inset-0 bg-slate-900/60 flex flex-col items-center justify-center hidden backdrop-blur-sm">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mb-3"></div>
        <div class="text-white font-bold text-sm" id="loadingText">Syncing...</div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="fixed inset-0 bg-slate-900 flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-2xl p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="inline-flex bg-primary/10 p-4 rounded-xl mb-4">
                    <svg width="48" height="48" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 4h24v20c0 0-2-3-4-3s-2 3-4 3-2-3-4-3-2 3-4 3-2-3-4-3-2 3-4 3V4z" fill="#FFD700"/>
                        <circle cx="10" cy="12" r="2.5" fill="#000"/>
                        <circle cx="22" cy="12" r="2.5" fill="#000"/>
                        <circle cx="10" cy="11" r="1" fill="#fff"/>
                        <circle cx="22" cy="11" r="1" fill="#fff"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-slate-800" id="loginTitle">LeadFlow</h1>
                <p class="text-slate-500 text-sm mt-1">Please sign in</p>
            </div>
            <form onsubmit="app.handleLogin(event)">
                <div class="space-y-4">
                    <div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Username / ID</label><input type="text" name="username" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition" required></div>
                    <div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Password</label><input type="password" name="password" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition" required></div>
                </div>
                <p id="loginError" class="text-red-500 text-sm mt-3 text-center hidden">Invalid credentials</p>
                <button type="submit" class="w-full bg-primary text-white font-bold text-lg py-3.5 rounded-xl shadow-lg shadow-primary/30 active:scale-[0.98] transition mt-8">Sign In</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="appContent" class="hidden h-full flex-col">
                <!-- NOTIFICATION CENTER DROPDOWN -->
                <div id="notificationBox" class="fixed top-16 right-4 z-[101] w-96 max-w-[calc(100vw-2rem)] bg-white border border-slate-200 rounded-2xl shadow-2xl hidden flex flex-col max-h-[500px]">
                    <!-- Header -->
                    <div class="flex justify-between items-center px-6 py-4 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-slate-0 shrink-0">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i class="ph-bold ph-bell-ringing text-green-600"></i> 
                            Notification Center
                        </h3>
                        <button onclick="ui.toggleNotificationBox()" class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg p-1 transition">
                            <i class="ph-bold ph-x text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- Notifications List -->
                    <div id="notificationList" class="flex-1 overflow-y-auto p-3 space-y-2 no-scrollbar">
                        <div id="notificationEmpty" class="text-slate-400 text-sm text-center py-12 flex flex-col items-center gap-2">
                            <i class="ph-bold ph-bell-slash text-3xl opacity-30"></i>
                            <span>No notifications yet</span>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="px-6 py-3 border-t border-slate-100 bg-slate-50 flex items-center gap-2 shrink-0">
                        <button onclick="app.clearAllNotifications()" class="flex-1 text-sm font-semibold text-slate-600 hover:text-slate-800 hover:bg-slate-200 py-2 px-3 rounded-lg transition">
                            Clear All
                        </button>
                        <button onclick="app.loadNotifications(); ui.updateNotificationBadge()" class="flex-1 text-sm font-semibold text-primary hover:bg-primary/10 py-2 px-3 rounded-lg transition">
                            Refresh
                        </button>
                    </div>
                </div>
        <header class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm z-20 shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="ui.toggleMenu(true)" class="p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-lg active:bg-slate-200 transition"><i class="ph-bold ph-list text-2xl"></i></button>
                <div class="flex items-center gap-2">
                    <div class="bg-primary/10 p-1.5 rounded-lg">
                        <svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 4h24v20c0 0-2-3-4-3s-2 3-4 3-2-3-4-3-2 3-4 3-2-3-4-3-2 3-4 3V4z" fill="#FFD700"/>
                            <circle cx="10" cy="12" r="2.5" fill="#000"/>
                            <circle cx="22" cy="12" r="2.5" fill="#000"/>
                            <circle cx="10" cy="11" r="1" fill="#fff"/>
                            <circle cx="22" cy="11" r="1" fill="#fff"/>
                        </svg>
                    </div>
                    <h1 id="appTitleDisplay" class="text-lg font-bold tracking-tight text-slate-900">LeadFlow</h1>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="currentUserDisplay" class="text-xs font-semibold text-slate-500 bg-slate-100 px-2 py-1 rounded hidden md:block"></span>
                <button onclick="ui.toggleNotificationBox()" class="p-2 text-green-600 hover:bg-green-50 rounded-full transition relative" title="Notifications">
                    <i class="ph-bold ph-bell text-xl"></i>
                    <span id="notificationCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 font-bold" style="display:none;">0</span>
                </button>
                <button onclick="app.sync()" class="p-2 text-blue-600 hover:bg-blue-50 rounded-full transition" title="Force Sync"><i class="ph-bold ph-arrows-clockwise text-xl"></i></button>
            </div>
                <!-- NOTIFICATION BOX -->
                <div id="notificationBox" class="fixed top-16 left-1/2 -translate-x-1/2 z-[101] w-80 max-w-full bg-white border border-slate-200 rounded-xl shadow-xl p-4 hidden">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-slate-800 text-base flex items-center gap-2"><i class="ph-bold ph-bell text-green-600"></i> Notifications</h4>
                        <button onclick="ui.toggleNotificationBox()" class="text-slate-400 hover:text-slate-600"><i class="ph-bold ph-x"></i></button>
                    </div>
                    <div id="notificationList" class="space-y-3 max-h-64 overflow-y-auto"></div>
                    <div id="notificationEmpty" class="text-slate-400 text-sm text-center py-6">No notifications</div>
                </div>
        </header>

        <!-- Mobile Tabs -->
        <nav id="kanbanTabs" class="md:hidden bg-white border-b border-slate-200 py-2 overflow-x-auto no-scrollbar shrink-0 z-10"><div class="flex px-4 gap-3 min-w-max" id="mobileTabs"></div></nav>

        <!-- Main Content -->
        <main class="flex-1 overflow-hidden relative w-full">
            <div id="kanbanView" class="h-full w-full">
                <div class="kanban-board h-full w-full p-4 md:p-6 md:gap-6">
                    <div id="boardContainer" class="h-full w-full flex md:gap-6"></div>
                </div>
            </div>
            <div id="tableView" class="h-full w-full hidden overflow-auto bg-white">
                <div class="min-w-[800px] p-6">
                    <!-- Filter Bar -->
                    <div class="mb-4 p-4 bg-slate-50 border border-slate-200 rounded-lg">
                        <div class="flex items-center gap-3 mb-3">
                            <i class="ph-bold ph-funnel text-slate-600"></i>
                            <h4 class="font-semibold text-slate-700">Filters</h4>
                            <button onclick="app.clearFilters()" class="ml-auto text-sm text-slate-500 hover:text-slate-700 underline">Clear All</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <!-- Search -->
                            <div>
                                <label class="text-xs font-semibold text-slate-600 block mb-1">Search Name/Email/Phone</label>
                                <input type="text" id="filterSearch" placeholder="Type to search..." oninput="app.applyFilters()" class="w-full bg-white border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none">
                            </div>
                            <!-- Status Filter -->
                            <div>
                                <label class="text-xs font-semibold text-slate-600 block mb-1">Status</label>
                                <select id="filterStatus" onchange="app.applyFilters()" class="w-full bg-white border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none">
                                    <option value="">All Status</option>
                                    <option value="New">New</option>
                                    <option value="Contacted">Contacted</option>
                                    <option value="Proposal">Proposal</option>
                                    <option value="Won">Won</option>
                                    <option value="Lost">Lost</option>
                                </select>
                            </div>
                            <!-- Assigned To Filter -->
                            <div>
                                <label class="text-xs font-semibold text-slate-600 block mb-1">Assigned To</label>
                                <select id="filterAssignedTo" onchange="app.applyFilters()" class="w-full bg-white border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none">
                                    <option value="">All Agents</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- Bulk Actions Bar -->
                    <div id="bulkActionsBar" class="hidden mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <i class="ph-bold ph-check-circle text-blue-600"></i>
                            <span id="selectedCount" class="font-semibold text-blue-700">0 selected</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <select id="bulkAssignSelect" class="bg-white border border-blue-300 rounded px-3 py-2 text-sm">
                                <option value="">Select agent to assign...</option>
                            </select>
                            <button onclick="app.bulkAssignLeads()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-semibold">Assign Selected</button>
                            <button onclick="app.clearSelection()" class="bg-slate-300 hover:bg-slate-400 text-slate-700 px-4 py-2 rounded text-sm font-semibold">Clear</button>
                        </div>
                    </div>
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b border-slate-200 text-slate-500 text-xs uppercase tracking-wider">
                                <th class="pb-3 font-bold pl-4"><input type="checkbox" id="selectAllCheckbox" onchange="app.toggleSelectAll(this.checked)" class="w-4 h-4 rounded"></th>
                                <th class="pb-3 font-bold pl-4 cursor-pointer hover:text-slate-700" onclick="app.sortTable('name')">Name <span id="sort-name" class="ml-1"></span></th>
                                <th class="pb-3 font-bold cursor-pointer hover:text-slate-700" onclick="app.sortTable('phone')">Contact <span id="sort-phone" class="ml-1"></span></th>
                                <th class="pb-3 font-bold cursor-pointer hover:text-slate-700" onclick="app.sortTable('status')">Status <span id="sort-status" class="ml-1"></span></th>
                                <th class="pb-3 font-bold cursor-pointer hover:text-slate-700" onclick="app.sortTable('lostReason')">Lost Reason <span id="sort-lostReason" class="ml-1"></span></th>
                                <th class="pb-3 font-bold cursor-pointer hover:text-slate-700" onclick="app.sortTable('interest')">Interest <span id="sort-interest" class="ml-1"></span></th>
                                <th class="pb-3 font-bold cursor-pointer hover:text-slate-700" onclick="app.sortTable('source')">Source <span id="sort-source" class="ml-1"></span></th>
                                <th class="pb-3 font-bold cursor-pointer hover:text-slate-700" onclick="app.sortTable('assignedTo')">Assigned <span id="sort-assignedTo" class="ml-1"></span></th>
                                <th class="pb-3 font-bold text-right pr-4 cursor-pointer hover:text-slate-700" onclick="app.sortTable('value')">Value <span id="sort-value" class="ml-1"></span></th>
                                <th class="pb-3 font-bold w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="text-sm text-slate-700 divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
            <div id="agentTableView" class="h-full w-full hidden overflow-auto bg-white">
                <div class="min-w-[800px] p-6">
                    <h2 class="text-xl font-bold mb-4">Agent Table</h2>
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b border-slate-200 text-slate-500 text-xs uppercase tracking-wider">
                                <th class="pb-3 font-bold pl-4">Agent/User</th>
                                <th class="pb-3 font-bold">Role</th>
                                <th class="pb-3 font-bold">Assigned Leads</th>
                            </tr>
                        </thead>
                        <tbody id="agentTableBody" class="text-sm text-slate-700 divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- Reports / Analytics Dashboard -->
            <div id="reportsView" class="h-full w-full hidden overflow-auto bg-slate-50">
                <div class="p-6 space-y-6">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800 mb-2">üìä Analytics Dashboard</h1>
                        <p class="text-slate-500">Pipeline performance, conversion metrics, and agent leaderboard</p>
                    </div>

                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="kpiCardsContainer">
                        <!-- Populated by JavaScript -->
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Pipeline Funnel -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <h2 class="text-lg font-bold text-slate-800 mb-4">Pipeline Funnel</h2>
                            <canvas id="pipelineFunnelChart" height="250"></canvas>
                        </div>

                        <!-- Lost Reasons Analysis -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <h2 class="text-lg font-bold text-slate-800 mb-4">Why Leads Are Lost</h2>
                            <canvas id="lostReasonsChart" height="250"></canvas>
                        </div>
                    </div>

                    <!-- Lead Temperature Distribution -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h2 class="text-lg font-bold text-slate-800 mb-4">Lead Temperature Distribution</h2>
                        <canvas id="temperatureChart" height="100"></canvas>
                    </div>

                    <!-- Agent Leaderboard -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h2 class="text-lg font-bold text-slate-800 mb-4">üèÜ Agent Performance</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-slate-700">
                                <thead>
                                    <tr class="border-b border-slate-200 text-slate-500 text-xs uppercase tracking-wider">
                                        <th class="pb-3 font-bold text-left">Agent</th>
                                        <th class="pb-3 font-bold text-right">Assigned</th>
                                        <th class="pb-3 font-bold text-right">Won</th>
                                        <th class="pb-3 font-bold text-right">Lost</th>
                                        <th class="pb-3 font-bold text-right">Win Rate</th>
                                    </tr>
                                </thead>
                                <tbody id="agentLeaderboardBody" class="divide-y divide-slate-100">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- MOBILE BOTTOM NAVIGATION (hidden on desktop) -->
        <nav id="mobileBottomNav" class="fixed bottom-0 left-0 right-0 md:hidden bg-white border-t border-slate-200 px-2 py-2 flex justify-around items-center gap-1 z-40 h-20">
            <button onclick="app.switchViewMode('kanban'); ui.updateMobileNav()" id="navKanban" class="flex flex-col items-center justify-center gap-1 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-50 transition w-16">
                <i class="ph-bold ph-kanban text-2xl"></i>
                <span class="text-xs font-semibold">Board</span>
            </button>
            <button onclick="app.switchViewMode('table'); ui.updateMobileNav()" id="navTable" class="flex flex-col items-center justify-center gap-1 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-50 transition w-16">
                <i class="ph-bold ph-table text-2xl"></i>
                <span class="text-xs font-semibold">Leads</span>
            </button>
            <button onclick="app.switchViewMode('reports'); ui.updateMobileNav()" id="navReports" class="flex flex-col items-center justify-center gap-1 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-50 transition w-16">
                <i class="ph-bold ph-chart-bar text-2xl"></i>
                <span class="text-xs font-semibold">Reports</span>
            </button>
            <button onclick="ui.toggleMenu(true)" id="navMenu" class="flex flex-col items-center justify-center gap-1 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-50 transition w-16">
                <i class="ph-bold ph-gear text-2xl"></i>
                <span class="text-xs font-semibold">More</span>
            </button>
        </nav>

        <!-- FAB Button with menu (with padding to not overlap mobile nav) -->
        <div class="fixed bottom-6 right-6 md:bottom-8 md:right-8 mobile-fab-adjusted z-30">
            <!-- FAB Menu (hidden by default) -->
            <div id="fabMenu" class="absolute bottom-20 right-0 bg-white rounded-2xl shadow-2xl p-2 hidden flex-col gap-2 w-48">
                <button onclick="ui.toggleModal(true); document.getElementById('fabMenu').classList.add('hidden')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 flex items-center gap-3 transition text-slate-700">
                    <i class="ph-bold ph-plus text-lg text-primary"></i>
                    <span class="font-semibold text-sm">New Lead</span>
                </button>
                <button onclick="app.notify('Scan feature coming soon', 'info'); document.getElementById('fabMenu').classList.add('hidden')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 flex items-center gap-3 transition text-slate-700">
                    <i class="ph-bold ph-qr-code text-lg text-blue-600"></i>
                    <span class="font-semibold text-sm">Scan QR</span>
                </button>
                <button onclick="app.notify('Import feature coming soon', 'info'); document.getElementById('fabMenu').classList.add('hidden')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 flex items-center gap-3 transition text-slate-700">
                    <i class="ph-bold ph-upload-simple text-lg text-green-600"></i>
                    <span class="font-semibold text-sm">Import CSV</span>
                </button>
            </div>
            
            <!-- Primary FAB Button -->
            <button onclick="const menu = document.getElementById('fabMenu'); menu.classList.toggle('hidden')" class="bg-primary hover:bg-indigo-600 text-white w-14 h-14 rounded-full shadow-lg shadow-indigo-500/30 flex items-center justify-center transition transform active:scale-95 focus:outline-none" title="Quick actions">
                <i id="fabIcon" class="ph-bold ph-plus text-2xl"></i>
            </button>
        </div>
    </div>

    <!-- SIDE MENU -->
    <div id="sideMenu" class="fixed inset-0 z-[60] hidden" role="dialog">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="ui.toggleMenu(false)"></div>
        <div class="menu-panel absolute inset-y-0 left-0 w-[85%] max-w-sm bg-white shadow-2xl flex flex-col">
            <div class="p-6 border-b border-slate-100 bg-slate-50">
                <h2 class="text-2xl font-bold text-slate-800 mb-1">Menu</h2>
                <div class="flex items-center gap-2 text-sm text-slate-500"><i class="ph-fill ph-user"></i> <span id="menuUserName">User</span><span id="menuUserRole" class="text-xs bg-slate-200 px-1.5 py-0.5 rounded font-bold uppercase">Role</span></div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-6">
                <div>
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2"><i class="ph-bold ph-squares-four"></i> Views</h3>
                    <div class="space-y-1">
                        <button onclick="app.switchViewMode('kanban')" class="w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 hover:bg-slate-50 transition text-slate-700"><i class="ph-bold ph-kanban text-lg"></i> <span class="font-medium">Kanban Board</span></button>
                        <button onclick="app.switchViewMode('table')" class="w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 hover:bg-slate-50 transition text-slate-700"><i class="ph-bold ph-table text-lg"></i> <span class="font-medium">Leads Table</span></button>
                        <button id="agentTableBtn" style="display:none" onclick="app.switchViewMode('agentTable')" class="w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 hover:bg-slate-50 transition text-slate-700"><i class="ph-bold ph-users text-lg"></i> <span class="font-medium">Agent Table</span></button>
                        <button id="reportsBtn" style="display:none" onclick="app.switchViewMode('reports')" class="w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 hover:bg-slate-50 transition text-slate-700"><i class="ph-bold ph-chart-bar text-lg"></i> <span class="font-medium">Reports</span></button>
                    </div>
                </div>
                <div>
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2"><i class="ph-bold ph-calendar-check"></i> Follow Ups</h3>
                    <div class="space-y-4">
                        <div class="bg-red-50 rounded-xl border border-red-100 overflow-hidden"><div class="px-4 py-3 bg-red-100/50 flex justify-between items-center border-b border-red-100"><span class="text-red-800 font-bold text-sm">Overdue</span><span id="count-overdue" class="bg-white text-red-600 text-xs font-bold px-2 py-0.5 rounded-full shadow-sm">0</span></div><div id="list-overdue" class="divide-y divide-red-100"></div></div>
                        <div class="bg-amber-50 rounded-xl border border-amber-100 overflow-hidden"><div class="px-4 py-3 bg-amber-100/50 flex justify-between items-center border-b border-amber-100"><span class="text-amber-800 font-bold text-sm">Today</span><span id="count-today" class="bg-white text-amber-600 text-xs font-bold px-2 py-0.5 rounded-full shadow-sm">0</span></div><div id="list-today" class="divide-y divide-amber-100"></div></div>
                        <div class="bg-blue-50 rounded-xl border border-blue-100 overflow-hidden"><div class="px-4 py-3 bg-blue-100/50 flex justify-between items-center border-b border-blue-100"><span class="text-blue-800 font-bold text-sm">Upcoming</span><span id="count-upcoming" class="bg-white text-blue-600 text-xs font-bold px-2 py-0.5 rounded-full shadow-sm">0</span></div><div id="list-upcoming" class="divide-y divide-blue-100 max-h-60 overflow-y-auto"></div></div>
                    </div>
                </div>
                <div id="adminSysSection" style="display:none">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2"><i class="ph-bold ph-gear"></i> Admin SYS</h3>
                    <div class="space-y-1">
                        <button onclick="ui.toggleLogs(true); ui.toggleMenu(false)" class="w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 hover:bg-slate-50 transition text-slate-700"><i class="ph-bold ph-scroll text-lg"></i> <span class="font-medium">Session Logs</span></button>
                        <button onclick="ui.toggleConfig(true); ui.toggleMenu(false)" class="w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 hover:bg-slate-50 transition text-slate-700"><i class="ph-bold ph-user-gear text-lg"></i> <span class="font-medium">SYS Config</span></button>
                    </div>
                </div>
                <div>
                    <div id="settingsSection"></div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 text-center"><button onclick="app.logout()" class="text-red-500 font-bold text-sm hover:text-red-600 flex items-center justify-center gap-2 w-full py-2"><i class="ph-bold ph-sign-out"></i> Sign Out</button></div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div id="logsModal" class="fixed inset-0 z-[70] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="ui.toggleLogs(false)"></div>
        <div class="modal-content absolute inset-x-0 bottom-0 md:relative md:inset-auto md:m-auto w-full md:w-[480px] md:h-[85vh] md:max-h-[800px] md:rounded-2xl bg-white shadow-2xl flex flex-col">
            <!-- Mobile Back Button (only) -->
            <button type="button" onclick="ui.toggleLogs(false)" class="absolute top-4 left-4 md:hidden flex items-center justify-center w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 focus:outline-none z-10">
                <i class="ph-bold ph-arrow-left text-xl text-primary"></i>
            </button>
            <div class="md:hidden w-full flex justify-center pt-3 pb-1" onclick="ui.toggleLogs(false)"><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
            <div class="px-6 py-4 border-b border-slate-100 shrink-0 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="ph-bold ph-scroll text-primary"></i> Session Logs</h3>
                <!-- Desktop Back Button (only) -->
                <button onclick="ui.toggleLogs(false)" class="hidden md:block p-1 text-slate-400 hover:text-slate-600 bg-slate-100 rounded-full"><i class="ph-bold ph-arrow-left text-lg"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-0 bg-slate-50/50"><div id="logsContainer" class="divide-y divide-slate-100"></div></div>
        </div>
    </div>

    <!-- User Config / Management Modal -->
    <div id="configModal" class="fixed inset-0 z-[70] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="ui.toggleConfig(false)"></div>
        <div class="modal-content absolute inset-x-0 bottom-0 md:relative md:inset-auto md:m-auto w-full md:w-[480px] md:h-auto md:max-h-[90vh] md:rounded-2xl bg-white shadow-2xl flex flex-col">
            <!-- Mobile Exit Button (only) -->
            <button type="button" onclick="ui.toggleConfig(false)" class="absolute top-4 right-4 md:hidden flex items-center justify-center w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 focus:outline-none z-10">
                <i class="ph-bold ph-x text-xl text-primary"></i>
            </button>
            <div class="md:hidden w-full flex justify-center pt-3 pb-1" onclick="ui.toggleConfig(false)"><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
            <div class="px-6 py-4 border-b border-slate-100 shrink-0 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="ph-bold ph-user-gear text-primary"></i> SYS Config</h3>
                <!-- Desktop Exit Button (only) -->
                <button onclick="ui.toggleConfig(false)" class="hidden md:block p-1 text-slate-400 hover:text-slate-600 bg-slate-100 rounded-full"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="mb-8"><h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Database</h4><form onsubmit="app.handleSaveAppConfig(event)"><div class="space-y-3"><div><label class="block text-xs font-semibold text-slate-500 mb-1">Script URL</label><input type="text" name="dbUrl" id="configDbUrl" class="w-full bg-slate-50 border-slate-200 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none" readonly></div><div><label class="block text-xs font-semibold text-slate-500 mb-1">App Name</label><input type="text" name="appTitle" id="configAppTitle" class="w-full bg-slate-50 border-slate-200 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none"></div><button type="submit" class="w-full bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-700">Save & Sync</button></div></form></div>
                <div class="mb-8 p-4 bg-slate-50 rounded-xl border border-slate-200"><h4 class="text-sm font-bold text-slate-800 mb-3 flex justify-between">Add User <span id="userLimitMsg" class="text-xs font-normal text-slate-500"></span></h4><form onsubmit="app.handleAddUser(event)"><div class="grid grid-cols-2 gap-3 mb-3"><input type="text" name="newUsername" placeholder="ID (ABC123)" required class="w-full bg-white border-slate-200 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none"><input type="password" name="newPassword" placeholder="Pwd (4 digits)" required class="w-full bg-white border-slate-200 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none"></div><div class="grid grid-cols-2 gap-3 mb-3"><input type="text" name="newName" placeholder="Name (CAPS max 15)" required class="w-full bg-white border-slate-200 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none"><select name="newRole" class="w-full bg-white border-slate-200 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none"><option value="agent">Agent</option><option value="admin">Admin</option></select></div><button type="submit" class="w-full bg-primary text-white font-bold py-2 rounded-lg text-sm hover:bg-indigo-600 transition shadow-sm">Create User</button></form></div>
                <div><h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Users</h4><div id="userListContainer" class="space-y-3"></div></div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Lead Modal -->
    <div id="leadModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="ui.toggleModal(false)"></div>
        <div class="modal-content absolute inset-x-0 bottom-0 md:relative md:inset-auto md:m-auto w-full md:w-[480px] md:h-[85vh] md:max-h-[800px] md:rounded-2xl bg-white shadow-2xl flex flex-col">
            <!-- Mobile Exit Button (only) -->
            <button type="button" onclick="ui.toggleModal(false)" class="absolute top-4 right-4 md:hidden flex items-center justify-center w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 focus:outline-none z-10">
                <i class="ph-bold ph-x text-xl text-primary"></i>
            </button>
            <div class="md:hidden w-full flex justify-center pt-3 pb-1" onclick="ui.toggleModal(false)"><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
            <div class="px-6 pt-4 pb-0 border-b border-slate-100 shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-xl font-bold text-slate-800">New Lead</h3>
                    <!-- Desktop Exit Button (only) -->
                    <button onclick="ui.toggleModal(false)" class="hidden md:block p-1 text-slate-400 hover:text-slate-600 bg-slate-100 rounded-full"><i class="ph-bold ph-x text-lg"></i></button>
                </div>
                <div class="flex gap-6 overflow-x-auto no-scrollbar"><button onclick="app.switchModalTab('info')" id="tab-btn-info" class="tab-active pb-3 font-semibold text-sm transition-colors whitespace-nowrap">Info</button><button onclick="app.switchModalTab('activity')" id="tab-btn-activity" class="tab-inactive pb-3 font-semibold text-sm transition-colors disabled:opacity-30 disabled:cursor-not-allowed whitespace-nowrap">Activity</button><button onclick="app.switchModalTab('task')" id="tab-btn-task" class="tab-inactive pb-3 font-semibold text-sm transition-colors disabled:opacity-30 disabled:cursor-not-allowed whitespace-nowrap">Task</button><button onclick="app.switchModalTab('contact')" id="tab-btn-contact" class="tab-inactive pb-3 font-semibold text-sm transition-colors disabled:opacity-30 disabled:cursor-not-allowed whitespace-nowrap">Contact</button></div>
            </div>
            <div class="flex-1 overflow-y-auto relative bg-slate-50/50">
                <div id="view-info" class="p-6">
                    <form id="leadForm" onsubmit="app.handleFormSubmit(event)">
                        <input type="hidden" name="leadId" id="leadIdInput">
                        <div class="space-y-5">
                            <div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Lead Name</label><input type="text" name="name" required class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition" placeholder="e.g. Acme Corp"></div>
                            
                            <!-- INTEREST (Autocomplete + Tags) -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">Interest</label>
                                <div class="relative">
                                    <input type="text" id="interestInput" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition" placeholder="Search or add interest..." autocomplete="off">
                                    <div id="interestSuggestions" class="suggestions-box hidden"></div>
                                </div>
                                <div id="interestTags" class="flex flex-wrap gap-2 mt-2"></div>
                                <input type="hidden" name="interest" id="interestHidden">
                            </div>

                            <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Value</label><div class="relative"><span class="absolute left-4 top-3.5 text-slate-400">‚Çπ</span><input type="number" name="value" id="leadValue" min="0" step="0.01" class="w-full bg-white border-slate-200 border rounded-xl pl-8 pr-4 py-3 focus:ring-2 focus:ring-primary outline-none" placeholder="0"></div></div><div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Status</label><select name="status" id="formStatusSelect" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none appearance-none"></select></div></div>
                            
                            <!-- LOST REASON (Conditional Display) -->
                            <div id="lostReasonDisplay" class="hidden p-4 bg-red-50 border border-red-200 rounded-xl">
                                <label class="block text-sm font-semibold text-red-800 mb-2">‚ùå Reason for Loss</label>
                                <p id="lostReasonText" class="text-sm text-red-700 font-medium"></p>
                            </div>
                            
                            <!-- TEMPERATURE (Manual) -->
                            <div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Temperature</label><select name="temperature" id="temperatureSelect" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none appearance-none"><option value="">Not Set</option><option value="Hot">üî¥ Hot</option><option value="Warm">üü† Warm</option><option value="Cold">üîµ Cold</option></select></div>
                            
                            <!-- LOCATION (Autocomplete) -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">Location</label>
                                <div class="relative">
                                    <input type="text" name="location" id="locationInput" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition" placeholder="City, Area..." autocomplete="off">
                                    <div id="locationSuggestions" class="suggestions-box hidden"></div>
                                </div>
                            </div>
                            
                            <!-- SOURCE (Autocomplete) -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">Lead Source</label>
                                <div class="relative">
                                    <input type="text" name="source" id="sourceInput" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition" placeholder="e.g. LinkedIn, Referral..." autocomplete="off">
                                    <div id="sourceSuggestions" class="suggestions-box hidden"></div>
                                </div>
                            </div>
                            
                            <div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Assigned To</label>
                                <select name="assignedTo" id="assignedToSelect" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition">
                                    <option value="">Select User</option>
                                </select>
                            </div>
                            <div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Contact Details</label><input type="email" name="email" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 mb-3 focus:ring-2 focus:ring-primary outline-none" placeholder="Email"><div class="relative flex items-stretch"><input type="text" name="phonePrefix" class="w-16 bg-slate-100 border-y border-l border-slate-200 rounded-l-xl text-center text-slate-700 font-medium text-sm focus:ring-2 focus:ring-primary focus:z-10 outline-none transition" value="+91" placeholder="+91"><input type="tel" name="phone" class="flex-1 bg-white border border-slate-200 rounded-r-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition" placeholder="98765 43210" pattern="\d{10}" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10)"></div></div>
                            <div><label class="block text-sm font-semibold text-slate-700 mb-1.5">Notes</label><textarea name="notes" rows="3" class="w-full bg-white border-slate-200 border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none resize-none"></textarea></div>
                        </div>
                    </form>
                </div>
                <div id="view-activity" class="hidden p-6"><div id="activityTimeline" class="space-y-0"></div></div>
                <div id="view-task" class="hidden p-6"><div id="taskList" class="space-y-3"></div></div>
                <div id="view-contact" class="hidden p-6 h-full"><div id="contactActions" class="h-full flex flex-col justify-center items-center gap-6"></div></div>
            </div>
            <div id="modalFooter" class="p-4 border-t border-slate-100 shrink-0 md:rounded-b-2xl bg-white pb-8 md:pb-4">
                <div id="footer-info"><button id="submitBtn" type="button" onclick="document.getElementById('leadForm').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}))" class="w-full bg-primary text-white font-bold text-lg py-3.5 rounded-xl shadow-lg shadow-primary/30 active:scale-[0.98] transition">Save Lead</button></div>
                <div id="footer-activity" class="hidden"></div>
                <div id="footer-task" class="hidden">
                    <form onsubmit="app.handleAddTask(event)" class="flex flex-col gap-2 mb-4">
                        <div class="relative">
                            <input type="text" id="taskInput" placeholder="Task title..." required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary text-sm">
                            <div id="taskSuggestions" class="suggestions-box hidden"></div>
                        </div>
                        <div class="relative">
                            <textarea id="taskNote" placeholder="Task note (max 15 words)..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary text-sm resize-none h-12" onkeyup="app.validateTaskNoteLength(this)"></textarea>
                            <span id="taskNoteCount" class="absolute bottom-2 right-3 text-xs text-slate-400">0/15</span>
                        </div>
                        <div class="flex gap-2">
                            <input type="date" id="taskDueDate" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary text-sm">
                            <button type="submit" class="bg-slate-800 text-white rounded-xl px-4 py-3 hover:bg-slate-700 active:scale-95 transition shadow-sm font-medium text-sm"><i class="ph-bold ph-plus"></i> Add</button>
                        </div>
                    </form>
                    <div id="taskDetailForm" class="hidden flex flex-col gap-3 p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 id="taskDetailTitle" class="font-semibold text-slate-700"></h3>
                            <button type="button" onclick="app.closeTaskDetail()" class="text-slate-400 hover:text-slate-600"><i class="ph-bold ph-x text-lg"></i></button>
                        </div>
                        <div id="taskDetailInfo" class="text-sm text-slate-600 space-y-1"></div>
                        <textarea id="taskNoteBox" placeholder="Add a note..." class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-primary resize-none h-20"></textarea>
                        <div class="flex gap-2">
                            <button type="button" onclick="app.updateTaskStatus('completed')" class="flex-1 bg-green-500 text-white rounded-lg px-3 py-2 hover:bg-green-600 active:scale-95 transition font-medium text-sm"><i class="ph-bold ph-check mr-1"></i>Complete</button>
                            <button type="button" onclick="app.updateTaskStatus('dropped')" class="flex-1 bg-red-500 text-white rounded-lg px-3 py-2 hover:bg-red-600 active:scale-95 transition font-medium text-sm"><i class="ph-bold ph-x mr-1"></i>Drop</button>
                            <button type="button" onclick="app.saveTaskNote()" class="flex-1 bg-primary text-white rounded-lg px-3 py-2 hover:bg-primary/90 active:scale-95 transition font-medium text-sm"><i class="ph-bold ph-floppy-disk mr-1"></i>Save</button>
                        </div>
                    </div>
                </div>
                <div id="footer-contact" class="hidden"></div>
            </div>
        </div>
    </div>

    <!-- Lost Reason Modal -->
    <div id="lostReasonModal" class="fixed inset-0 z-50 hidden flex items-center justify-center" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-96 p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Why Was This Lead Lost?</h3>
            <p class="text-sm text-slate-600 mb-6">Select the reason for marking this lead as lost.</p>
            
            <div class="space-y-3 mb-6">
                <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition">
                    <input type="radio" name="lostReason" value="Price too high" class="w-4 h-4 text-primary" onchange="app.toggleOtherReasonInput(false)">
                    <span class="ml-3 text-sm text-slate-700 font-medium">Price too high</span>
                </label>
                <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition">
                    <input type="radio" name="lostReason" value="Not interested" class="w-4 h-4 text-primary" onchange="app.toggleOtherReasonInput(false)">
                    <span class="ml-3 text-sm text-slate-700 font-medium">Not interested</span>
                </label>
                <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition">
                    <input type="radio" name="lostReason" value="Competitor" class="w-4 h-4 text-primary" onchange="app.toggleOtherReasonInput(false)">
                    <span class="ml-3 text-sm text-slate-700 font-medium">Chose competitor</span>
                </label>
                <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition">
                    <input type="radio" name="lostReason" value="Invalid Number" class="w-4 h-4 text-primary" onchange="app.toggleOtherReasonInput(false)">
                    <span class="ml-3 text-sm text-slate-700 font-medium">Invalid number</span>
                </label>
                <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition">
                    <input type="radio" name="lostReason" value="Duplicate" class="w-4 h-4 text-primary" onchange="app.toggleOtherReasonInput(false)">
                    <span class="ml-3 text-sm text-slate-700 font-medium">Duplicate lead</span>
                </label>
                <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition">
                    <input type="radio" name="lostReason" value="Other" class="w-4 h-4 text-primary" onchange="app.toggleOtherReasonInput(true)">
                    <span class="ml-3 text-sm text-slate-700 font-medium">Other reason</span>
                </label>
            </div>

            <!-- Custom reason input (hidden by default) -->
            <div id="customReasonContainer" class="hidden mb-6">
                <label class="block text-sm font-semibold text-slate-700 mb-2">Please specify the reason:</label>
                <textarea id="customReasonInput" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-primary outline-none resize-none" rows="3" placeholder="Enter the reason for loss..."></textarea>
            </div>
            
            <div class="flex gap-3">
                <button type="button" onclick="app.closeLostReasonModal()" class="flex-1 bg-slate-200 text-slate-700 font-bold py-2.5 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                <button type="button" onclick="app.confirmLostReason()" class="flex-1 bg-primary text-white font-bold py-2.5 rounded-lg hover:bg-indigo-600 transition">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        class LeadStore {
            constructor() {
                this.subscribers = [];
                this.STORAGE_KEY = 'LEAD_FLOW_DB_V27'; 
                const data = this.loadLocal();
                this.state = data.leads || [];
                this.logs = data.logs || [];
                this.config = data.config || { appTitle: 'LeadFlow', dbUrl: '' };
                // Hardcode the Script URL
                this.config.dbUrl = 'https://script.google.com/macros/s/AKfycbxevXBoOPZkOq82wHla6WKrOiGhnrNM7FXKtHmeItMOnUp0vBOYF13lcBRAE3Gtfw/exec';
                this.users = data.users || [];
                this.interests = data.interests || []; 
                this.settings = data.settings || { locations: [], sources: [], taskTitles: [] };
                
                if (this.users.length === 0) {
                    this.users.push({ id: 'super-01', username: 'nox1', password: '1233', role: 'superuser', name: 'Super User' });
                    this.saveLocal();
                }
            }

            subscribe(callback) { this.subscribers.push(callback); }
            notify() { this.subscribers.forEach(cb => cb(this.state)); }
            generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
            loadLocal() { try { return JSON.parse(localStorage.getItem(this.STORAGE_KEY)) || {}; } catch(e) { return {}; } }
            
            saveLocal() {
                const data = { leads: this.state, logs: this.logs, config: this.config, users: this.users, interests: this.interests, settings: this.settings };
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
                this.notify();
            }

            async syncWithCloud() {
                if (!this.config.dbUrl) return;
                ui.showLoading(true);
                try {
                    const response = await fetch(this.config.dbUrl, { method: 'GET', redirect: 'follow', credentials: 'omit' });
                    if (!response.ok) throw new Error('Network response was not ok');
                    const cloudData = await response.json();
                    if (cloudData.leads) this.state = cloudData.leads;
                    if (cloudData.users && cloudData.users.length > 0) this.users = cloudData.users;
                    if (cloudData.logs) this.logs = cloudData.logs;
                    if (cloudData.interests) this.interests = cloudData.interests;
                    if (cloudData.settings) this.settings = cloudData.settings; 
                    // Debug: log what we get from backend
                    console.log('Backend config:', cloudData.config);
                    // Always sync appTitle from backend config if present
                    if (cloudData.config && cloudData.config.appTitle) this.config.appTitle = cloudData.config.appTitle;
                    this.saveLocal();
                    if(window.app && typeof window.app.applyConfig==='function'){window.app.applyConfig();}
                    if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
                } catch (e) { 
                    console.warn("Cloud sync unavailable, using local data:", e.message); 
                } finally { 
                    ui.showLoading(false); 
                }
            }
            async pushToCloud() {
                if (!this.config.dbUrl) return;
                ui.showLoading(true);
                try {
                    const payload = { action: 'save_all', leads: this.state, users: this.users, logs: this.logs, config: this.config };
                    await fetch(this.config.dbUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
                    console.log('Data pushed to cloud successfully');
                } catch (e) { 
                    console.warn("Cloud sync unavailable, data saved locally:", e.message); 
                } finally { 
                    ui.showLoading(false); 
                }
            }
            save() { this.saveLocal(); this.pushToCloud(); }
            getCounts() { return { admins: this.users.filter(u => u.role === 'admin').length, agents: this.users.filter(u => u.role === 'agent').length }; }
            addUser(user) { this.users.push({id: this.generateId(), ...user}); this.save(); }
            deleteUser(id) { const u = this.users.find(x => x.id === id); if (u && u.role === 'superuser') return false; this.users = this.users.filter(x => x.id !== id); this.save(); return true; }
            async saveConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
                this.saveLocal();
                // Push appTitle to backend via dedicated action
                if (this.config.dbUrl && this.config.appTitle) {
                    try {
                        await fetch(this.config.dbUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({ action: 'save_script_url', appTitle: this.config.appTitle })
                        });
                    } catch (e) { console.error('AppTitle sync failed', e); }
                }
                await this.pushToCloud();
                if (this.config.dbUrl) await this.syncWithCloud();
            }
            log(msg, user) { const prefix = user ? `${user.name} (${user.role}): ` : 'System: '; this.logs.unshift({ id: this.generateId(), timestamp: new Date().toISOString(), message: prefix + msg }); if (this.logs.length > 50) this.logs.pop(); this.save(); }
            add(data, user) {
                this.state.push({ id: this.generateId(), createdAt: new Date().toISOString(), activities: [], ...data });
                this.log(`Created lead ${data.name}`, user);
                this.save();
                if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
            }
            update(id, data, user) {
                const idx = this.state.findIndex(l => l.id === id);
                if (idx !== -1) {
                    this.state[idx] = { ...this.state[idx], ...data };
                    this.log(`Updated ${data.name}`, user);
                    this.save();
                    if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
                }
            }
            delete(id, user) {
                const l = this.state.find(x => x.id === id);
                this.state = this.state.filter(x => x.id !== id);
                this.log(`Deleted ${l ? l.name : 'Lead'}`, user);
                this.save();
                if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
            }
            updateStatus(id, status, user) {
                const l = this.state.find(x => x.id === id);
                if (l) {
                    l.status = status;
                    this.log(`Moved ${l.name} to ${status}`, user);
                    this.save();
                    if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
                }
            }
            addActivity(id, activity, user) {
                const l = this.state.find(x => x.id === id);
                if (l) {
                    if(!l.activities) l.activities = [];
                    l.activities.unshift({ id: this.generateId(), timestamp: new Date().toISOString(), createdBy: user ? user.name : 'System', role: user ? user.role : '', ...activity });
                    this.log(`Logged activity for ${l.name}`, user);
                    this.save();
                    if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
                }
            }
            reset() { this.state = []; this.logs = []; this.save(); }
        }

        class App {
                                                                                                                        addNotification(msg, type = 'info') {
                                                                                                                            if (!this._notifications) this._notifications = [];
                                                                                                                            const timestamp = new Date();
                                                                                                                            this._notifications.unshift({ 
                                                                                                                                msg, 
                                                                                                                                type,
                                                                                                                                ts: timestamp.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'}),
                                                                                                                                fullTs: timestamp.toLocaleString()
                                                                                                                            });
                                                                                                                            if (this._notifications.length > 20) this._notifications.pop();
                                                                                                                            this.renderNotificationBox();
                                                                                                                            this.saveNotifications();
                                                                                                                            if (ui && ui.updateNotificationBadge) ui.updateNotificationBadge();
                                                                                                                        }

                                                                                                                        renderNotificationBox() {
                                                                                                                            const list = document.getElementById('notificationList');
                                                                                                                            const empty = document.getElementById('notificationEmpty');
                                                                                                                            const count = document.getElementById('notificationCount');
                                                                                                                            if (!this._notifications || this._notifications.length === 0) {
                                                                                                                                list.innerHTML = '';
                                                                                                                                empty.style.display = '';
                                                                                                                                count.style.display = 'none';
                                                                                                                                return;
                                                                                                                            }
                                                                                                                            
                                                                                                                            const typeConfig = {
                                                                                                                                success: { bg: 'bg-green-50', border: 'border-green-100', icon: 'ph-check-circle', text: 'text-green-700', badge: 'bg-green-100' },
                                                                                                                                error: { bg: 'bg-red-50', border: 'border-red-100', icon: 'ph-warning-circle', text: 'text-red-700', badge: 'bg-red-100' },
                                                                                                                                warning: { bg: 'bg-amber-50', border: 'border-amber-100', icon: 'ph-warning', text: 'text-amber-700', badge: 'bg-amber-100' },
                                                                                                                                info: { bg: 'bg-blue-50', border: 'border-blue-100', icon: 'ph-info', text: 'text-blue-700', badge: 'bg-blue-100' }
                                                                                                                            };
                                                                                                                            
                                                                                                                            list.innerHTML = this._notifications.map((n, idx) => {
                                                                                                                                const cfg = typeConfig[n.type] || typeConfig.info;
                                                                                                                                return `<div class="${cfg.bg} border ${cfg.border} rounded-xl px-4 py-3 flex items-start gap-3 hover:shadow-md transition group cursor-pointer" title="${n.fullTs}">
                                                                                                                                    <i class="ph-bold ${cfg.icon} ${cfg.text} text-lg mt-0.5 flex-shrink-0"></i>
                                                                                                                                    <div class="flex-1 min-w-0">
                                                                                                                                        <div class="font-semibold text-slate-700 text-sm line-clamp-2">${n.msg}</div>
                                                                                                                                        <div class="text-xs ${cfg.text} opacity-70 mt-1">${n.ts}</div>
                                                                                                                                    </div>
                                                                                                                                    <button onclick="app._notifications.splice(${idx}, 1); app.renderNotificationBox(); app.saveNotifications()" class="text-slate-300 hover:text-slate-600 opacity-0 group-hover:opacity-100 transition flex-shrink-0">
                                                                                                                                        <i class="ph-bold ph-x text-lg"></i>
                                                                                                                                    </button>
                                                                                                                                </div>`;
                                                                                                                            }).join('');
                                                                                                                            empty.style.display = 'none';
                                                                                                                            count.textContent = this._notifications.length;
                                                                                                                            count.style.display = '';
                                                                                                                        }
                                                                                                                        
                                                                                                                        clearAllNotifications() {
                                                                                                                            this._notifications = [];
                                                                                                                            this.renderNotificationBox();
                                                                                                                            this.saveNotifications();
                                                                                                                            this.notify('All notifications cleared', 'success');
                                                                                                                        }
                                                                                                                        
                                                                                                                        saveNotifications() {
                                                                                                                            try {
                                                                                                                                localStorage.setItem('app_notifications', JSON.stringify(this._notifications || []));
                                                                                                                            } catch(e) {
                                                                                                                                console.warn('Failed to save notifications:', e);
                                                                                                                            }
                                                                                                                        }
                                                                                                                        
                                                                                                                        loadNotifications() {
                                                                                                                            try {
                                                                                                                                const saved = localStorage.getItem('app_notifications');
                                                                                                                                this._notifications = saved ? JSON.parse(saved) : [];
                                                                                                                                this.renderNotificationBox();
                                                                                                                            } catch(e) {
                                                                                                                                console.warn('Failed to load notifications:', e);
                                                                                                                                this._notifications = [];
                                                                                                                            }
                                                                                                                        }
                                                                                                            startAutoSync() {
                                                                                                                // Load persisted notifications from localStorage
                                                                                                                this.loadNotifications();
                                                                                                                ui.updateNotificationBadge();
                                                                                                                // Store last assigned lead IDs for notification
                                                                                                                this._lastAssignedLeadIds = new Set();
                                                                                                                // Initial population
                                                                                                                this.updateAssignedLeadIds();
                                                                                                                // Check for upcoming task reminders every minute
                                                                                                                this.checkUpcomingTasks();
                                                                                                                setInterval(() => {
                                                                                                                    this.autoSyncWithNotification();
                                                                                                                }, 2400000); // Sync every 40 minutes
                                                                                                                setInterval(() => {
                                                                                                                    this.checkUpcomingTasks();
                                                                                                                }, 60000); // Check tasks every minute
                                                                                                            }

                                                                                                            updateAssignedLeadIds() {
                                                                                                                if (!this.currentUser || !(this.currentUser.role === 'agent' || this.currentUser.role === 'user')) return;
                                                                                                                const assignedLeads = this.store.state.filter(lead => lead.assignedTo === this.currentUser.username || lead.assignedTo === this.currentUser.id);
                                                                                                                this._lastAssignedLeadIds = new Set(assignedLeads.map(l => l.id));
                                                                                                            }

                                                                                                            checkUpcomingTasks() {
                                                                                                                if (!this.currentUser || !(this.currentUser.role === 'agent' || this.currentUser.role === 'user')) return;
                                                                                                                const now = new Date();
                                                                                                                const fifteenMinutesFromNow = new Date(now.getTime() + 15 * 60000);
                                                                                                                const today = now.toISOString().split('T')[0];
                                                                                                                const reminderKey = `task_reminder_${today}`;
                                                                                                                const remindedTasks = JSON.parse(sessionStorage.getItem(reminderKey) || '[]');
                                                                                                                const assignedLeads = this.store.state.filter(lead => lead.assignedTo === this.currentUser.username || lead.assignedTo === this.currentUser.id);
                                                                                                                
                                                                                                                assignedLeads.forEach(lead => {
                                                                                                                    if (!lead.tasks || lead.tasks.length === 0) return;
                                                                                                                    lead.tasks.forEach((task, idx) => {
                                                                                                                        if (task.status !== 'pending' || !task.dueDate) return;
                                                                                                                        const taskId = `${lead.id}_${idx}`;
                                                                                                                        if (remindedTasks.includes(taskId)) return; // Already reminded today
                                                                                                                        
                                                                                                                        const dueDate = new Date(task.dueDate + 'T23:59:59');
                                                                                                                        if (dueDate <= fifteenMinutesFromNow && dueDate > now) {
                                                                                                                            const minutesLeft = Math.round((dueDate - now) / 60000);
                                                                                                                            this.notify(`Task reminder: "${task.title}" for ${lead.name} due in ${minutesLeft} min`, 'warning');
                                                                                                                            remindedTasks.push(taskId);
                                                                                                                        }
                                                                                                                    });
                                                                                                                });
                                                                                                                
                                                                                                                sessionStorage.setItem(reminderKey, JSON.stringify(remindedTasks));
                                                                                                            }

                                                                                                            async autoSyncWithNotification() {
                                                                                                                if (!this.currentUser || !(this.currentUser.role === 'agent' || this.currentUser.role === 'user')) return;
                                                                                                                const prevIds = new Set(this._lastAssignedLeadIds);
                                                                                                                await this.store.syncWithCloud();
                                                                                                                const assignedLeads = this.store.state.filter(lead => lead.assignedTo === this.currentUser.username || lead.assignedTo === this.currentUser.id);
                                                                                                                const newAssigned = assignedLeads.filter(l => !prevIds.has(l.id));
                                                                                                                if (newAssigned.length > 0) {
                                                                                                                    this.showNotification(`New lead assigned: ${newAssigned[0].name}`);
                                                                                                                }
                                                                                                                this._lastAssignedLeadIds = new Set(assignedLeads.map(l => l.id));
                                                                                                            }
                                                                                                showNotification(msg) {
                                                                                                    const tray = document.getElementById('notificationTray');
                                                                                                    document.getElementById('notificationMessage').textContent = msg || 'You have a new lead assigned!';
                                                                                                    tray.classList.remove('opacity-0', 'pointer-events-none');
                                                                                                    tray.classList.add('opacity-100');
                                                                                                    if (this._notifTimeout) clearTimeout(this._notifTimeout);
                                                                                                    this._notifTimeout = setTimeout(() => {
                                                                                                        tray.classList.add('opacity-0', 'pointer-events-none');
                                                                                                        tray.classList.remove('opacity-100');
                                                                                                    }, 5000);
                                                                                                    this.addNotification(msg);
                                                                                                }

                                                                                                notify(msg, type = 'info') {
                                                                                                    const tray = document.getElementById('notificationTray');
                                                                                                    if (!tray) return;
                                                                                                    
                                                                                                    // Color mapping
                                                                                                    const colors = {
                                                                                                        success: 'bg-green-500',
                                                                                                        error: 'bg-red-500',
                                                                                                        warning: 'bg-amber-500',
                                                                                                        info: 'bg-blue-500'
                                                                                                    };
                                                                                                    
                                                                                                    // Icon mapping
                                                                                                    const icons = {
                                                                                                        success: 'ph-check-circle',
                                                                                                        error: 'ph-warning-circle',
                                                                                                        warning: 'ph-warning',
                                                                                                        info: 'ph-info'
                                                                                                    };
                                                                                                    
                                                                                                    const bgColor = colors[type] || colors.info;
                                                                                                    const icon = icons[type] || icons.info;
                                                                                                    
                                                                                                    // Update tray appearance
                                                                                                    tray.className = `fixed top-3 left-1/2 -translate-x-1/2 z-[100] ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 text-sm font-semibold transition-all duration-300 opacity-100`;
                                                                                                    document.getElementById('notificationMessage').innerHTML = `<i class="ph-bold ${icon}"></i> ${msg}`;
                                                                                                    
                                                                                                    if (this._notifTimeout) clearTimeout(this._notifTimeout);
                                                                                                    this._notifTimeout = setTimeout(() => {
                                                                                                        tray.classList.add('opacity-0', 'pointer-events-none');
                                                                                                    }, 4000);
                                                                                                    
                                                                                                    this.addNotification(msg, type);
                                                                                                }

                                                                                                // Show notification if a new lead is assigned to the current user
                                                                                                handleLeadAssignment(lead, prevAssignedTo) {
                                                                                                    if (!this.currentUser) return;
                                                                                                    // Only notify if the current user is agent/user and the lead is now assigned to them
                                                                                                    if ((this.currentUser.role === 'agent' || this.currentUser.role === 'user') &&
                                                                                                        (lead.assignedTo === this.currentUser.username || lead.assignedTo === this.currentUser.id) &&
                                                                                                        prevAssignedTo !== lead.assignedTo) {
                                                                                                        this.showNotification(`New lead assigned: ${lead.name}`);
                                                                                                    }
                                                                                                }
                                                                                    switchTab(tabId) {
                                                                                        this.activeMobileTab = tabId;
                                                                                        this.render(this.store.state);
                                                                                        ui.updateKanbanTabs();
                                                                                    }
                                                                        // --- LEADERBOARD RENDERING ---
                                                                        renderLeaderboard() {
                                                                            const container = document.getElementById('leaderboardContainer');
                                                                            if (!container) return;
                                                                            // Aggregate scores by user
                                                                            const userScores = {};
                                                                            (this.store.state || []).forEach(lead => {
                                                                                if (lead.assignedTo) {
                                                                                    if (!userScores[lead.assignedTo]) userScores[lead.assignedTo] = 0;
                                                                                    // Score: 1 per lead, +1 per 100k value, +1 per activity
                                                                                    let score = 1;
                                                                                    if (lead.value && lead.value > 0) score += Math.floor(lead.value / 100000);
                                                                                    if (Array.isArray(lead.activities)) score += lead.activities.length;
                                                                                    userScores[lead.assignedTo] += score;
                                                                                }
                                                                            });
                                                                            // Convert to array and sort
                                                                            const sorted = Object.entries(userScores).sort((a, b) => b[1] - a[1]);
                                                                            if (sorted.length === 0) {
                                                                                container.innerHTML = '<div class="text-slate-400 text-sm">No leaderboard data yet.</div>';
                                                                                return;
                                                                            }
                                                                            container.innerHTML = sorted.map(([user, score], i) => `
                                                                                <div class="flex items-center gap-3 p-2 rounded-lg ${i === 0 ? 'bg-yellow-100 border border-yellow-300' : 'bg-slate-50'}">
                                                                                    <span class="font-bold text-lg w-6 text-center">${i + 1}</span>
                                                                                    <span class="flex-1 font-medium text-slate-700">${this.escapeHtml(user)}</span>
                                                                                    <span class="font-bold text-primary">${score}</span>
                                                                                    ${i === 0 ? '<i class="ph-bold ph-crown text-yellow-500"></i>' : ''}
                                                                                </div>
                                                                            `).join('');
                                                                        }
                                                            // --- LEAD SCORING & TEMPERATURE ---
                                                            getLeadScores(lead) {
                                                                // Temperature: Manual assignment (Hot, Warm, Cold)
                                                                let temp = lead.temperature || '';
                                                                let tempColor = 'bg-slate-200 text-slate-700';
                                                                let tempIcon = 'ph-thermometer';
                                                                
                                                                if (temp === 'Hot') {
                                                                    tempColor = 'bg-red-200 text-red-700';
                                                                    tempIcon = 'ph-thermometer-hot';
                                                                } else if (temp === 'Warm') {
                                                                    tempColor = 'bg-amber-200 text-amber-700';
                                                                    tempIcon = 'ph-thermometer-simple';
                                                                } else if (temp === 'Cold') {
                                                                    tempColor = 'bg-blue-200 text-blue-700';
                                                                    tempIcon = 'ph-thermometer-cold';
                                                                }
                                                                
                                                                return { temp, tempColor, tempIcon };
                                                            }
                                                // Render the leads table view
                                                renderTable(leads) {
                                                    const tbody = document.getElementById('tableBody');
                                                    if (!tbody) return;
                                                    
                                                    // Debug: log available users and sample leads
                                                    console.log('Available users in store:', this.store.users);
                                                    if (leads.length > 0) {
                                                        console.log('Sample lead assignedTo values:', leads.slice(0, 3).map(l => ({ name: l.name, assignedTo: l.assignedTo })));
                                                    }
                                                    
                                                    // Filter for agent/user: only show assigned leads
                                                    let filteredLeads = leads;
                                                    if (this.currentUser && (this.currentUser.role === 'agent' || this.currentUser.role === 'user')) {
                                                        filteredLeads = leads.filter(lead => lead.assignedTo === this.currentUser.username || lead.assignedTo === this.currentUser.id);
                                                    }
                                                    // Apply custom filters (search, status, assigned-to)
                                                    filteredLeads = this.filterLeads(filteredLeads);
                                                    // Apply sorting
                                                    filteredLeads = this.getSortedLeads(filteredLeads);
                                                    // Populate bulk assign dropdown if admin/superuser
                                                    if (this.currentUser && (this.currentUser.role === 'admin' || this.currentUser.role === 'superuser')) {
                                                        const assignSelect = document.getElementById('bulkAssignSelect');
                                                        if (assignSelect) {
                                                            const currentVal = assignSelect.value;
                                                            assignSelect.innerHTML = '<option value="">Select agent to assign...</option>';
                                                            this.store.users.filter(u => u.role === 'admin' || u.role === 'agent').forEach(u => {
                                                                const opt = document.createElement('option');
                                                                opt.value = u.username || u.id;
                                                                opt.textContent = u.name;
                                                                assignSelect.appendChild(opt);
                                                            });
                                                            assignSelect.value = currentVal;
                                                        }
                                                        // Also populate filter dropdown
                                                        const filterAssignedTo = document.getElementById('filterAssignedTo');
                                                        if (filterAssignedTo) {
                                                            const currentVal = filterAssignedTo.value;
                                                            filterAssignedTo.innerHTML = '<option value="">All Agents</option>';
                                                            this.store.users.filter(u => u.role === 'admin' || u.role === 'agent').forEach(u => {
                                                                const opt = document.createElement('option');
                                                                opt.value = u.username || u.id;
                                                                opt.textContent = u.name;
                                                                filterAssignedTo.appendChild(opt);
                                                            });
                                                            filterAssignedTo.value = currentVal;
                                                        }
                                                    }
                                                    tbody.innerHTML = filteredLeads.map(lead => {
                                                        // Check for missing pending task on active leads
                                                        const isActiveStage = !['Won', 'Lost'].includes(lead.status);
                                                        const hasPendingTask = lead.tasks && lead.tasks.some(t => t.status === 'pending');
                                                        const showTaskWarning = isActiveStage && !hasPendingTask;
                                                        return `
                                                        <tr class="table-row-hover ${showTaskWarning ? 'bg-red-50' : ''}">
                                                            <td class="pl-4 py-2"><input type="checkbox" class="leadCheckbox w-4 h-4 rounded" data-leadId="${lead.id}" onchange="app.updateBulkActionsBar()"></td>
                                                            <td class="pl-4 py-2 font-bold"><span class="inline-flex items-center gap-2">${this.escapeHtml(lead.name)}${showTaskWarning ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700" title="Active lead with no pending task"><i class="ph-bold ph-warning"></i> No Action</span>` : ''}</span></td>
                                                            <td class="py-2">${this.escapeHtml(lead.phone || '')}<br><span class="text-xs text-slate-400">${this.escapeHtml(lead.email || '')}</span></td>
                                                            <td class="py-2">${this.escapeHtml(lead.status)}</td>
                                                            <td class="py-2">${lead.status === 'Lost' && lead.lostReason ? `<span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded font-medium">${this.escapeHtml(lead.lostReason)}</span>` : '-'}</td>
                                                            <td class="py-2">${this.escapeHtml(lead.interest)}</td>
                                                            <td class="py-2">${this.escapeHtml(lead.source)}</td>
                                                            <td class="py-2">${this.escapeHtml(this.getUserName(lead.assignedTo))}</td>
                                                            <td class="py-2 text-right pr-4">${this.formatCurrency(lead.value)}</td>
                                                            <td class="py-2 text-right">
                                                                <button onclick="app.editLead('${lead.id}')" class="text-primary hover:underline text-xs font-bold">Edit</button>
                                                            </td>
                                                        </tr>
                                                    `;
                                                    }).join('');
                                                    // Reset bulk actions bar
                                                    this.updateBulkActionsBar();
                                                }

                                                // Sort table by column
                                                sortTable(column) {
                                                    // Toggle sort direction if same column clicked
                                                    if (this.sortColumn === column) {
                                                        this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                                                    } else {
                                                        this.sortColumn = column;
                                                        this.sortDirection = 'asc';
                                                    }
                                                    
                                                    // Clear all sort indicators
                                                    document.querySelectorAll('[id^="sort-"]').forEach(el => el.textContent = '');
                                                    
                                                    // Add sort indicator to current column
                                                    const indicator = document.getElementById(`sort-${column}`);
                                                    if (indicator) {
                                                        indicator.textContent = this.sortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
                                                    }
                                                    
                                                    // Re-render with sorted data
                                                    this.render(this.store.state);
                                                }

                                                // Get sorted leads
                                                getSortedLeads(leads) {
                                                    if (!this.sortColumn) return leads;
                                                    
                                                    const sorted = [...leads].sort((a, b) => {
                                                        let aVal = a[this.sortColumn];
                                                        let bVal = b[this.sortColumn];
                                                        
                                                        // Handle null/undefined
                                                        if (aVal == null && bVal == null) return 0;
                                                        if (aVal == null) return this.sortDirection === 'asc' ? 1 : -1;
                                                        if (bVal == null) return this.sortDirection === 'asc' ? -1 : 1;
                                                        
                                                        // For numbers (like value)
                                                        if (typeof aVal === 'number' && typeof bVal === 'number') {
                                                            return this.sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                                                        }
                                                        
                                                        // For strings
                                                        aVal = String(aVal).toLowerCase();
                                                        bVal = String(bVal).toLowerCase();
                                                        
                                                        if (this.sortDirection === 'asc') {
                                                            return aVal.localeCompare(bVal);
                                                        } else {
                                                            return bVal.localeCompare(aVal);
                                                        }
                                                    });
                                                    
                                                    return sorted;
                                                }

                                                // Apply filters to leads
                                                applyFilters() {
                                                    // Get filter values from UI
                                                    const searchInput = document.getElementById('filterSearch');
                                                    const statusSelect = document.getElementById('filterStatus');
                                                    const assignedSelect = document.getElementById('filterAssignedTo');
                                                    
                                                    if (searchInput) this.filters.search = searchInput.value.toLowerCase().trim();
                                                    if (statusSelect) this.filters.status = statusSelect.value;
                                                    if (assignedSelect) this.filters.assignedTo = assignedSelect.value;
                                                    
                                                    // Re-render with filtered and sorted data
                                                    this.render(this.store.state);
                                                }

                                                // Clear all filters
                                                clearFilters() {
                                                    this.filters = {
                                                        search: '',
                                                        status: '',
                                                        assignedTo: ''
                                                    };
                                                    
                                                    // Reset UI
                                                    const searchInput = document.getElementById('filterSearch');
                                                    const statusSelect = document.getElementById('filterStatus');
                                                    const assignedSelect = document.getElementById('filterAssignedTo');
                                                    
                                                    if (searchInput) searchInput.value = '';
                                                    if (statusSelect) statusSelect.value = '';
                                                    if (assignedSelect) assignedSelect.value = '';
                                                    
                                                    // Re-render
                                                    this.render(this.store.state);
                                                }

                                                // Apply filters to leads array
                                                filterLeads(leads) {
                                                    let filtered = leads;
                                                    
                                                    // Apply search filter (name, email, phone)
                                                    if (this.filters.search) {
                                                        filtered = filtered.filter(lead => {
                                                            const search = this.filters.search;
                                                            return (lead.name && lead.name.toLowerCase().includes(search)) ||
                                                                   (lead.email && lead.email.toLowerCase().includes(search)) ||
                                                                   (lead.phone && lead.phone.toLowerCase().includes(search));
                                                        });
                                                    }
                                                    
                                                    // Apply status filter
                                                    if (this.filters.status) {
                                                        filtered = filtered.filter(lead => lead.status === this.filters.status);
                                                    }
                                                    
                                                    // Apply assigned-to filter
                                                    if (this.filters.assignedTo) {
                                                        filtered = filtered.filter(lead => lead.assignedTo === this.filters.assignedTo);
                                                    }
                                                    
                                                    return filtered;
                                                }

                                                // Get user name from username/id
                                                getUserName(username) {
                                                    if (!username) return '';
                                                    // Try to find user by username or id
                                                    const user = this.store.users.find(u => {
                                                        return String(u.username).toLowerCase() === String(username).toLowerCase() || 
                                                               String(u.id).toLowerCase() === String(username).toLowerCase();
                                                    });
                                                    return user && user.name ? user.name : username;
                                                }

                                    // Switch between Kanban and Table views
                                    switchViewMode(mode) {
                                        this.activeView = mode;
                                        this.currentView = mode; // Store for mobile nav update
                                        const kanban = document.getElementById('kanbanView');
                                        const table = document.getElementById('tableView');
                                        const agentTable = document.getElementById('agentTableView');
                                        const reports = document.getElementById('reportsView');
                                        const kanbanTabs = document.getElementById('kanbanTabs');
                                        
                                        if (mode === 'kanban') {
                                            kanban.classList.remove('hidden');
                                            table.classList.add('hidden');
                                            agentTable.classList.add('hidden');
                                            reports.classList.add('hidden');
                                            if (kanbanTabs) kanbanTabs.classList.remove('hidden'); // Show tabs for Kanban
                                            this.render(this.store.state);
                                            ui.updateKanbanTabs(); // Update Kanban mobile tabs
                                        } else if (mode === 'table') {
                                            kanban.classList.add('hidden');
                                            table.classList.remove('hidden');
                                            agentTable.classList.add('hidden');
                                            reports.classList.add('hidden');
                                            if (kanbanTabs) kanbanTabs.classList.add('hidden'); // Hide tabs for Table
                                            this.render(this.store.state);
                                        } else if (mode === 'agentTable') {
                                            kanban.classList.add('hidden');
                                            table.classList.add('hidden');
                                            agentTable.classList.remove('hidden');
                                            reports.classList.add('hidden');
                                            if (kanbanTabs) kanbanTabs.classList.add('hidden'); // Hide tabs for Agent Table
                                            this.renderAgentTable();
                                        } else if (mode === 'reports') {
                                            kanban.classList.add('hidden');
                                            table.classList.add('hidden');
                                            agentTable.classList.add('hidden');
                                            reports.classList.remove('hidden');
                                            if (kanbanTabs) kanbanTabs.classList.add('hidden'); // Hide tabs for Reports
                                            this.renderReports();
                                        }
                                        this.renderLeaderboard();
                                        ui.updateMobileNav(); // Update mobile nav indicator
                                    }

                                    renderAgentTable() {
                                        const tbody = document.getElementById('agentTableBody');
                                        if (!tbody) return;
                                        // Only show for admin/superuser
                                        if (!this.currentUser || (this.currentUser.role !== 'admin' && this.currentUser.role !== 'superuser')) {
                                            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-6 text-slate-400">Access denied</td></tr>';
                                            return;
                                        }
                                        // Get all users (admin, agent, user)
                                        const users = this.store.users.filter(u => u.role === 'admin' || u.role === 'agent' || u.role === 'user');
                                        const leads = this.store.state || [];
                                        
                                        if (users.length === 0) {
                                            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-6 text-slate-400">No users found</td></tr>';
                                            return;
                                        }
                                        
                                        tbody.innerHTML = users.map(user => {
                                            const assignedLeads = leads.filter(lead => {
                                                const leadAssigned = lead.assignedTo ? String(lead.assignedTo).toLowerCase() : '';
                                                const userName = user.username ? String(user.username).toLowerCase() : '';
                                                const userId = user.id ? String(user.id).toLowerCase() : '';
                                                return leadAssigned === userName || leadAssigned === userId;
                                            });
                                            return `<tr class="table-row-hover">
                                                <td class="pl-4 py-2 font-bold">${this.escapeHtml(user.name || user.username || user.id)}</td>
                                                <td class="py-2">${this.escapeHtml(user.role)}</td>
                                                <td class="py-2">${assignedLeads.length > 0 ? assignedLeads.map(l => `<span class="inline-block bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs mr-1">${this.escapeHtml(l.name)}</span>`).join('') : '<span class="text-slate-400 italic">None</span>'}</td>
                                            </tr>`;
                                        }).join('');
                                    }

                                    // Bulk selection methods
                                    updateBulkActionsBar() {
                                        const checkboxes = document.querySelectorAll('.leadCheckbox:checked');
                                        const selectedCount = checkboxes.length;
                                        const bulkActionsBar = document.getElementById('bulkActionsBar');
                                        const selectedCountEl = document.getElementById('selectedCount');
                                        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                                        
                                        if (selectedCount > 0) {
                                            bulkActionsBar.classList.remove('hidden');
                                            selectedCountEl.textContent = `${selectedCount} selected`;
                                        } else {
                                            bulkActionsBar.classList.add('hidden');
                                            if (selectAllCheckbox) selectAllCheckbox.checked = false;
                                        }
                                    }

                                    toggleSelectAll(checked) {
                                        const checkboxes = document.querySelectorAll('.leadCheckbox');
                                        checkboxes.forEach(cb => cb.checked = checked);
                                        this.updateBulkActionsBar();
                                    }

                                    clearSelection() {
                                        const checkboxes = document.querySelectorAll('.leadCheckbox');
                                        checkboxes.forEach(cb => cb.checked = false);
                                        document.getElementById('selectAllCheckbox').checked = false;
                                        this.updateBulkActionsBar();
                                    }

                                    bulkAssignLeads() {
                                        const assignSelect = document.getElementById('bulkAssignSelect');
                                        const assignTo = assignSelect.value;
                                        if (!assignTo) {
                                            this.notify('Please select an agent to assign leads to', 'error');
                                            return;
                                        }
                                        
                                        const checkboxes = document.querySelectorAll('.leadCheckbox:checked');
                                        const leadIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-leadid'));
                                        
                                        console.log('Bulk Assign - Selected Lead IDs:', leadIds);
                                        console.log('Bulk Assign - Assigning to:', assignTo);
                                        console.log('Bulk Assign - Current store state:', this.store.state);
                                        
                                        if (leadIds.length === 0) {
                                            this.notify('Please select at least one lead', 'error');
                                            return;
                                        }
                                        
                                        if (!confirm(`Assign ${leadIds.length} lead(s) to the selected agent?`)) {
                                            return;
                                        }
                                        
                                        // Update all selected leads
                                        let updateCount = 0;
                                        leadIds.forEach(leadId => {
                                            const lead = this.store.state.find(l => l.id === leadId);
                                            console.log(`Looking for lead with id "${leadId}":`, lead);
                                            if (lead) {
                                                console.log(`Updating lead "${lead.name}" from "${lead.assignedTo}" to "${assignTo}"`);
                                                lead.assignedTo = assignTo;
                                                updateCount++;
                                                // Add activity log
                                                if (!lead.activities) lead.activities = [];
                                                lead.activities.push({
                                                    type: 'Assigned',
                                                    note: `Bulk assigned to ${assignTo}`,
                                                    createdBy: this.currentUser.name,
                                                    role: this.currentUser.role,
                                                    timestamp: new Date().toISOString()
                                                });
                                            }
                                        });
                                        
                                        console.log(`Updated ${updateCount} leads out of ${leadIds.length}`);
                                        
                                        // Save locally and push to cloud
                                        this.store.saveLocal();
                                        this.store.pushToCloud();
                                        
                                        console.log('After push, store state:', this.store.state);
                                        
                                        // Clear selection and show success
                                        this.clearSelection();
                                        this.showNotification(`Successfully assigned ${leadIds.length} lead(s)`);
                                        this.render(this.store.state);
                                    }
                        // Render the activity timeline for a lead in the modal
                        renderTimeline(lead) {
                            const container = document.getElementById('activityTimeline');
                            if (!container || !lead || !Array.isArray(lead.activities)) {
                                container.innerHTML = '<div class="text-slate-400 text-sm">No activity yet.</div>';
                                return;
                            }
                            if (lead.activities.length === 0) {
                                container.innerHTML = '<div class="text-slate-400 text-sm">No activity yet.</div>';
                                return;
                            }
                            container.innerHTML = lead.activities.map(a => `
                                <div class="timeline-item relative pl-8 py-4">
                                    <div class="timeline-line absolute left-0 top-0 h-full w-4 flex items-center justify-center">
                                        <div class="w-2 h-2 rounded-full bg-primary"></div>
                                    </div>
                                    <div class="flex flex-col gap-1">
                                        <div class="text-xs text-slate-500">${a.timestamp ? new Date(a.timestamp).toLocaleString() : ''}</div>
                                        <div class="text-sm font-medium text-slate-800">${this.escapeHtml(a.type || '')}${a.note ? ': ' + this.escapeHtml(a.note) : ''}</div>
                                        <div class="text-xs text-slate-400">${a.createdBy ? this.escapeHtml(a.createdBy) : ''}${a.role ? ' (' + this.escapeHtml(a.role) + ')' : ''}</div>
                                    </div>
                                </div>
                            `).join('');
                        }
            // Populate Assigned To dropdown with Admins and Agents
            populateAssignedToDropdown() {
                const select = document.getElementById('assignedToSelect');
                if (!select) return;
                const current = select.value;
                select.innerHTML = '<option value="">Select User</option>';
                this.store.users.filter(u => u.role === 'admin' || u.role === 'agent').forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.username || u.id;
                    opt.textContent = u.name;
                    select.appendChild(opt);
                });
                if (current) select.value = current;
            }

            // --- EDIT LEAD LOGIC ---
            editLead(id, tab) {
                const lead = this.store.state.find(l => l.id === id);
                if (!lead) return;
                // Fill modal form fields
                document.getElementById('leadIdInput').value = lead.id;
                document.getElementById('modalTitle').textContent = 'Edit Lead';
                document.getElementById('submitBtn').textContent = 'Update';
                document.getElementById('tab-btn-activity').disabled = false;
                document.getElementById('tab-btn-contact').disabled = false;
                document.getElementById('leadForm').name.value = lead.name || '';
                document.getElementById('leadForm').interest.value = lead.interest || '';
                document.getElementById('leadForm').value.value = lead.value || '';
                document.getElementById('leadForm').status.value = lead.status || '';
                document.getElementById('leadForm').email.value = lead.email || '';
                document.getElementById('leadForm').location.value = lead.location || '';
                document.getElementById('leadForm').source.value = lead.source || '';
                // Assigned To select
                this.populateAssignedToDropdown();
                const assignedToSelect = document.getElementById('assignedToSelect');
                if (assignedToSelect) assignedToSelect.value = lead.assignedTo || '';
                // Phone split
                let phone = lead.phone || '';
                let prefix = '+91', number = '';
                if (phone.startsWith('+')) {
                    const parts = phone.split(' ');
                    prefix = parts[0];
                    number = parts.slice(1).join(' ');
                } else if (phone) {
                    number = phone;
                }
                document.getElementById('leadForm').phonePrefix.value = prefix;
                document.getElementById('leadForm').phone.value = number;
                document.getElementById('leadForm').notes.value = lead.notes || '';
                // Interests tags
                this.selectedInterests = (lead.interest || '').split(',').filter(x=>x.trim()).map(i=>({name:i.trim(),value:0}));
                this.renderInterestTags();
                // Show modal
                ui.toggleModal(true);
                // Switch tab if specified
                if (tab) this.switchModalTab(tab);
            }
            constructor() {
                this.store = new LeadStore();
                this.currentUser = null;
                this.statusConfig = [
                    { id: 'New', color: 'bg-blue-500', text: 'text-blue-700', bg: 'bg-blue-50' },
                    { id: 'Contacted', color: 'bg-yellow-500', text: 'text-yellow-700', bg: 'bg-yellow-50' },
                    { id: 'Proposal', color: 'bg-purple-500', text: 'text-purple-700', bg: 'bg-purple-50' },
                    { id: 'Won', color: 'bg-green-500', text: 'text-green-700', bg: 'bg-green-50' },
                    { id: 'Lost', color: 'bg-red-500', text: 'text-red-700', bg: 'bg-red-50' }
                ];
                this.activeMobileTab = this.statusConfig[0].id;
                this.currentModalTab = 'info';
                this.activeView = 'kanban'; 
                this.selectedInterests = [];
                this.sortColumn = null;
                this.sortDirection = 'asc';
                this.filters = {
                    search: '',
                    status: '',
                    assignedTo: ''
                };
                // Always update login card/app title on construction
                if (typeof this.applyConfig === 'function') this.applyConfig();
                this.store.subscribe((data) => {
                    if (this.currentUser) {
                        this.render(data);
                        if(document.getElementById('sideMenu').classList.contains('open')) this.renderFollowUps();
                    }
                });
            }

            // --- AUTOCOMPLETE LOGIC (Generic) ---
            setupAutocomplete(inputId, suggestionsId, dataList, onSelect) {
                const input = document.getElementById(inputId);
                const suggestions = document.getElementById(suggestionsId);
                if (!input || !suggestions) return;
                
                input.addEventListener('input', (e) => {
                    const val = e.target.value.toLowerCase();
                    if (!val) { suggestions.classList.add('hidden'); return; }
                    
                    const matches = dataList.filter(i => {
                        const text = typeof i === 'string' ? i : i.name;
                        return text.toLowerCase().includes(val);
                    });

                    if (matches.length > 0) {
                        suggestions.innerHTML = matches.map(m => {
                            const text = typeof m === 'string' ? m : m.name;
                            const isState = text.startsWith('State - ') || text.startsWith('Union Territory - ');
                            const isCity = text.startsWith('Cities - ');
                            const displayText = text.replace(/^(State - |Union Territory - |Cities - )/, '');
                            const subtext = typeof m === 'string' ? '' : `‚Çπ${m.value.toLocaleString('en-IN')}`;
                            const indent = isCity ? 'pl-6' : '';
                            const badge = isState ? '<span class="text-xs bg-primary text-white px-2 py-0.5 rounded ml-2">State</span>' : isCity ? '<span class="text-xs bg-slate-200 text-slate-700 px-2 py-0.5 rounded ml-2">City</span>' : '';
                            return `<div class="suggestion-item ${indent} py-2 cursor-pointer hover:bg-slate-100" data-val="${text}">${displayText} ${badge} <span class="text-xs text-slate-400 float-right">${subtext}</span></div>`;
                        }).join('');
                        suggestions.classList.remove('hidden');
                        
                        const items = suggestions.querySelectorAll('.suggestion-item');
                        items.forEach((item, index) => {
                            item.addEventListener('click', () => {
                                const selected = matches[index];
                                const text = typeof selected === 'string' ? selected : selected.name;
                                const cleanText = text.replace(/^(State - |Union Territory - |Cities - )/, '');
                                onSelect(cleanText);
                                suggestions.classList.add('hidden');
                            });
                        });
                    } else {
                        suggestions.classList.add('hidden');
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                        suggestions.classList.add('hidden');
                    }
                });
            }

            // --- INTEREST LOGIC ---
            initInterestLogic() {
                const getMasterList = () => {
                    if (this.store.interests && this.store.interests.length > 0) {
                        return this.store.interests.map(i => ({ 
                            name: i.Name || i.name, 
                            value: parseFloat(i.Value || i.value) || 0 
                        }));
                    }
                    return [];
                };
                
                const input = document.getElementById('interestInput');
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); if (input.value.trim()) this.addInterest(input.value.trim(), 0); }
                });

                this.setupAutocomplete('interestInput', 'interestSuggestions', getMasterList(), (selected) => {
                    this.addInterest(selected.name, selected.value);
                    document.getElementById('interestInput').value = ''; 
                });
            }

            addInterest(name, value) {
                if (this.selectedInterests.some(i => i.name === name)) return;
                this.selectedInterests.push({ name, value });
                this.renderInterestTags();
                this.updateTotalValue();
            }
            removeInterest(name) {
                this.selectedInterests = this.selectedInterests.filter(i => i.name !== name);
                this.renderInterestTags();
                this.updateTotalValue();
            }
            renderInterestTags() {
                const container = document.getElementById('interestTags');
                const hiddenInput = document.getElementById('interestHidden');
                container.innerHTML = this.selectedInterests.map(i => `
                    <span class="interest-tag inline-flex items-center px-2.5 py-1 rounded-md text-sm font-medium bg-indigo-50 text-indigo-700 border border-indigo-100">
                        ${i.name}
                        <button type="button" onclick="app.removeInterest('${i.name}')" class="ml-1.5 text-indigo-400 hover:text-indigo-600 focus:outline-none"><i class="ph-bold ph-x"></i></button>
                    </span>`).join('');
                hiddenInput.value = this.selectedInterests.map(i => i.name).join(', ');
            }
            updateTotalValue() {
                const total = this.selectedInterests.reduce((sum, item) => sum + item.value, 0);
                if (total > 0) document.getElementById('leadValue').value = total;
            }

            // --- LOCATION & SOURCE LOGIC ---
            initSettingsAutocomplete() {
                const locations = this.store.settings.locations || [];
                const sources = this.store.settings.sources || [];
                const taskTitles = this.store.settings.taskTitles || [];

                this.setupAutocomplete('locationInput', 'locationSuggestions', locations, (selected) => {
                    document.getElementById('locationInput').value = selected;
                });

                this.setupAutocomplete('sourceInput', 'sourceSuggestions', sources, (selected) => {
                    document.getElementById('sourceInput').value = selected;
                });

                this.setupAutocomplete('taskInput', 'taskSuggestions', taskTitles, (selected) => {
                    document.getElementById('taskInput').value = selected;
                });
            }

            // --- STANDARD LOGIC ---

            async handleLogin(e) {
                e.preventDefault();
                document.getElementById('loginError').classList.add('hidden');
                ui.showLoading(true, 'Syncing users...');
                await this.store.syncWithCloud();
                // Ensure UI/app name updates instantly after sync
                if (typeof this.applyConfig === 'function') this.applyConfig();
                ui.showLoading(false);
                const u = e.target.username.value;
                const p = e.target.password.value;
                const user = this.store.users.find(x => String(x.username) === String(u) && String(x.password) === String(p));
                if (user) {
                    this.currentUser = user;
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('appContent').classList.remove('hidden');
                    document.getElementById('appContent').classList.add('flex');
                    // Show Agent Table button only for admin/superuser
                    const agentTableBtn = document.getElementById('agentTableBtn');
                    if (agentTableBtn) {
                        if (this.currentUser.role === 'admin' || this.currentUser.role === 'superuser') {
                            agentTableBtn.style.display = '';
                        } else {
                            agentTableBtn.style.display = 'none';
                        }
                    }
                    // Show Reports button only for admin/superuser
                    const reportsBtn = document.getElementById('reportsBtn');
                    if (reportsBtn) {
                        if (this.currentUser.role === 'admin' || this.currentUser.role === 'superuser') {
                            reportsBtn.style.display = '';
                        } else {
                            reportsBtn.style.display = 'none';
                        }
                    }
                    this.init();
                } else {
                    document.getElementById('loginError').classList.remove('hidden');
                }
            }

            logout() { location.reload(); }

            async init() {
                this.applyConfig();
                this.updateUserUI();
                // Update Kanban tabs with safe check
                if (ui && typeof ui.updateKanbanTabs === 'function') {
                    ui.updateKanbanTabs();
                }
                this.render(this.store.state);

                this.initInterestLogic();
                this.initSettingsAutocomplete();
                this.populateAssignedToDropdown();

                // Show admin settings for superuser/admin
                if (this.currentUser.role === 'superuser' || this.currentUser.role === 'admin') {
                    // Show Admin SYS section in hamburger menu
                    const adminSysSection = document.getElementById('adminSysSection');
                    if (adminSysSection) {
                        adminSysSection.style.display = '';
                    }
                }

                if (this.store.config.dbUrl) {
                    await this.store.syncWithCloud();
                    this.initInterestLogic(); 
                    this.initSettingsAutocomplete();
                    this.populateAssignedToDropdown();
                }

                const s = document.getElementById('formStatusSelect');
                s.innerHTML = '';
                this.statusConfig.forEach(x => {
                    const opt = document.createElement('option');
                    opt.value = x.id; opt.textContent = x.id; s.appendChild(opt);
                });
            }

            sync() { this.store.syncWithCloud(); }
            updateUserUI() {
                document.getElementById('currentUserDisplay').textContent = this.currentUser.username;
                document.getElementById('menuUserName').textContent = this.currentUser.name;
                document.getElementById('menuUserRole').textContent = this.currentUser.role;
            }
            applyConfig() {
                const title = this.store.config.appTitle || 'LeadFlow';
                document.getElementById('appTitleDisplay').textContent = title;
                document.getElementById('loginTitle').textContent = title;
                document.getElementById('configAppTitle').value = title;
                document.getElementById('configDbUrl').value = 'https://script.google.com/macros/s/AKfycbxevXBoOPZkOq82wHla6WKrOiGhnrNM7FXKtHmeItMOnUp0vBOYF13lcBRAE3Gtfw/exec';
                document.title = title;
            }

            handleAddUser(e) {
                e.preventDefault();
                const username = e.target.newUsername.value.trim();
                const password = e.target.newPassword.value.trim();
                const name = e.target.newName.value.trim();
                const role = e.target.newRole.value;
                
                // Validation rules
                // ID: 3 CAPS letters + 3 digits, max 6 characters
                const idRegex = /^[A-Z]{3}\d{3}$/;
                if (!idRegex.test(username)) {
                    return this.notify('ID must be exactly 3 UPPERCASE letters followed by 3 digits (e.g., ABC123)', 'error');
                }
                
                // Password: 4 digits only
                if (!/^\d{4}$/.test(password)) {
                    return this.notify('Password must be exactly 4 digits', 'error');
                }
                
                // Name: UPPERCASE only, max 15 characters
                if (name !== name.toUpperCase()) {
                    return this.notify('Name must be in UPPERCASE letters only', 'error');
                }
                if (name.length > 15) {
                    return this.notify('Name must be maximum 15 characters', 'error');
                }
                
                // Check role limits
                const counts = this.store.getCounts();
                if (role === 'admin' && counts.admins >= 5) return this.notify('Max 5 Admins', 'warning');
                if (role === 'agent' && counts.agents >= 10) return this.notify('Max 10 Agents', 'warning');
                this.store.addUser({ username: username, password: password, name: name, role: role });
                e.target.reset(); 
                this.renderUserList();
                this.populateAssignedToDropdown();
                if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
            }
            deleteUser(id) { if(confirm('Remove user?')) { if(!this.store.deleteUser(id)) this.notify('Cannot delete Superuser', 'error'); this.renderUserList(); } }
            renderUserList() {
                const c = document.getElementById('userListContainer');
                const counts = this.store.getCounts();
                document.getElementById('userLimitMsg').textContent = `Admins: ${counts.admins}/5 | Agents: ${counts.agents}/10`;
                c.innerHTML = this.store.users.map(u => `<div class="flex justify-between items-center p-3 bg-white border border-slate-100 rounded-lg"><div><div class="font-bold text-sm text-slate-800">${u.name} <span class="text-xs text-slate-400">(${u.username})</span></div><div class="text-xs uppercase font-bold text-primary bg-primary/5 w-fit px-1.5 rounded mt-0.5">${u.role}</div></div>${u.role !== 'superuser' ? `<button onclick="app.deleteUser('${u.id}')" class="text-red-400 p-2"><i class="ph-bold ph-trash"></i></button>` : ''}</div>`).join('');
            }
            async handleSaveAppConfig(e) {
                e.preventDefault();
                await this.store.saveConfig({ appTitle: e.target.appTitle.value, dbUrl: e.target.dbUrl.value });
                this.applyConfig();
                if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
                this.notify('Saved & Synced', 'success');
            }

            checkDuplicatePhone(phoneNumber) {
                const duplicateLead = this.store.state.find(l => l.phone === phoneNumber);
                return duplicateLead || null;
            }

            handleFormSubmit(e) {
                e.preventDefault();
                const f = e.target;
                const prefix = f.phonePrefix.value || '';
                const num = f.phone.value || '';
                const fullPhone = num ? (prefix + ' ' + num) : '';

                // Phone number validation: must not be empty
                if (!num || num.length < 10) {
                    // Show error message (simple alert or custom UI)
                    if (!document.getElementById('phoneErrorMsg')) {
                        const phoneInput = f.phone;
                        const err = document.createElement('div');
                        err.id = 'phoneErrorMsg';
                        err.className = 'text-red-500 text-xs mt-1';
                        err.textContent = 'Phone number is required (10 digits)';
                        phoneInput.parentNode.appendChild(err);
                    }
                    f.phone.focus();
                    return;
                } else {
                    // Remove error if present
                    const err = document.getElementById('phoneErrorMsg');
                    if (err) err.remove();
                }

                // Check if status is being changed to "Lost" and intercept
                const newStatus = f.status.value;
                const leadId = f.leadId.value;
                if (leadId && newStatus === 'Lost') {
                    const currentLead = this.store.state.find(l => l.id === leadId);
                    if (currentLead && currentLead.status !== 'Lost') {
                        // Status is changing TO Lost - show the reason modal
                        this._pendingFormData = {
                            leadId: leadId,
                            name: f.name.value,
                            interest: f.interest.value,
                            value: parseFloat(f.value.value) || 0,
                            temperature: f.temperature.value,
                            email: f.email.value,
                            location: f.location.value,
                            source: f.source.value,
                            assignedTo: f.assignedTo.value,
                            phone: fullPhone,
                            notes: f.notes.value
                        };
                        this.showLostReasonModal(leadId);
                        return;
                    }
                }

                const d = {
                    name: f.name.value,
                    interest: f.interest.value,
                    value: parseFloat(f.value.value) || 0,
                    status: f.status.value,
                    temperature: f.temperature.value,
                    email: f.email.value,
                    location: f.location.value,
                    source: f.source.value,
                    assignedTo: f.assignedTo.value,
                    phone: fullPhone,
                    notes: f.notes.value,
                    // Clear lostReason if status is not "Lost"
                    lostReason: f.status.value === 'Lost' ? undefined : ''
                };
                let prevAssignedTo = null;
                if (f.leadId.value) {
                    const oldLead = this.store.state.find(l => l.id === f.leadId.value);
                    prevAssignedTo = oldLead ? oldLead.assignedTo : null;
                    this.store.update(f.leadId.value, d, this.currentUser);
                } else {
                    // Check for duplicate phone number before adding new lead
                    const duplicateLead = this.checkDuplicatePhone(fullPhone);
                    if (duplicateLead) {
                        this.notify(`Duplicate Lead: ${duplicateLead.name} (${duplicateLead.phone})`, 'warning');
                        return;
                    }
                    this.store.add(d, this.currentUser);
                    // For new leads, prevAssignedTo is null
                }
                // Show notification if assigned to current user
                this.handleLeadAssignment(d, prevAssignedTo);
                if (typeof this.switchTab === 'function') {
                    this.switchTab(d.status);
                }
                if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
                ui.toggleModal(false);
            }

            showLostReasonModal(leadId) {
                this._pendingLostLeadId = leadId;
                document.getElementById('lostReasonModal').classList.remove('hidden');
            }

            closeLostReasonModal() {
                document.getElementById('lostReasonModal').classList.add('hidden');
                this._pendingLostLeadId = null;
                // Clear radio selection
                document.querySelectorAll('input[name="lostReason"]').forEach(r => r.checked = false);
                // Clear custom input
                document.getElementById('customReasonInput').value = '';
                document.getElementById('customReasonContainer').classList.add('hidden');
            }

            toggleOtherReasonInput(show) {
                const container = document.getElementById('customReasonContainer');
                if (show) {
                    container.classList.remove('hidden');
                    document.getElementById('customReasonInput').focus();
                } else {
                    container.classList.add('hidden');
                    document.getElementById('customReasonInput').value = '';
                }
            }

            confirmLostReason() {
                const selectedReason = document.querySelector('input[name="lostReason"]:checked')?.value;
                if (!selectedReason) {
                    this.notify('Please select a reason for the loss', 'error');
                    return;
                }

                // If "Other" is selected, require custom input
                let finalReason = selectedReason;
                if (selectedReason === 'Other') {
                    const customReason = document.getElementById('customReasonInput').value.trim();
                    if (!customReason) {
                        this.notify('Please specify the reason for the loss', 'error');
                        document.getElementById('customReasonInput').focus();
                        return;
                    }
                    finalReason = `Other: ${customReason}`;
                }

                if (this._pendingLostLeadId) {
                    // If we have pending form data, use it (came from form edit)
                    if (this._pendingFormData) {
                        const formData = { ...this._pendingFormData, status: 'Lost', lostReason: finalReason };
                        this.store.update(this._pendingLostLeadId, formData, this.currentUser);
                        this._pendingFormData = null;
                    } else {
                        // Came from drag-drop
                        this.store.update(this._pendingLostLeadId, { status: 'Lost', lostReason: finalReason }, this.currentUser);
                    }
                    this.closeLostReasonModal();
                    if (typeof this.renderCards === 'function') this.renderCards();
                    if (typeof this.renderTable === 'function') this.renderTable(this.store.state);
                    if(window.app && typeof window.app.renderLeaderboard==='function'){window.app.renderLeaderboard();}
                }
            }

            handleAddActivity(e) {
                e.preventDefault();
                const f = e.target;
                const id = document.getElementById('leadIdInput').value;
                const type = f.type.value;
                let note = f.noteText.value;
                if(type==='follow_up') note = f.noteDate.value;
                else if(type==='file') note = f.noteFile.files[0]?.name || 'File';
                
                if(id && note) {
                    this.store.addActivity(id, { type, note }, this.currentUser);
                    f.noteText.value = ''; f.noteDate.value = ''; f.noteFile.value = '';
                    this.renderTimeline(this.store.state.find(l => l.id === id));
                }
            }

            handleAddTask(e) {
                e.preventDefault();
                const id = document.getElementById('leadIdInput').value;
                const title = document.getElementById('taskInput').value;
                const taskNote = document.getElementById('taskNote').value;
                const dueDate = document.getElementById('taskDueDate').value;
                
                if(id && title) {
                    const lead = this.store.state.find(l => l.id === id);
                    if(lead) {
                        if(!lead.tasks) lead.tasks = [];
                        lead.tasks.push({ id: this.store.generateId(), title, note: taskNote, dueDate, status: 'pending', createdAt: new Date().toISOString() });
                        // Add activity log for task creation
                        const activityNote = `Task created: Pending: ${title}${taskNote ? ' - ' + taskNote : ''}${dueDate ? ' (Due: ' + new Date(dueDate).toLocaleDateString('en-IN') + ')' : ''}`;
                        this.store.addActivity(id, { type: 'task', note: activityNote }, this.currentUser);
                        // Add follow-up activity if due date exists
                        if(dueDate) {
                            this.store.addActivity(id, { type: 'follow_up', note: dueDate }, this.currentUser);
                        }
                        this.store.save();
                        document.getElementById('taskInput').value = '';
                        document.getElementById('taskNote').value = '';
                        document.getElementById('taskNoteCount').textContent = '0/15';
                        document.getElementById('taskDueDate').value = '';
                        this.renderTaskView(lead);
                    }
                }
            }

            validateTaskNoteLength(textarea) {
                const words = textarea.value.trim().split(/\s+/).filter(w => w.length > 0);
                const wordCount = textarea.value.trim() === '' ? 0 : words.length;
                const countDisplay = document.getElementById('taskNoteCount');
                
                if (wordCount > 15) {
                    textarea.value = words.slice(0, 15).join(' ');
                    countDisplay.textContent = '15/15';
                } else {
                    countDisplay.textContent = wordCount + '/15';
                }
                
                if (wordCount > 12) {
                    countDisplay.classList.add('text-amber-600');
                } else {
                    countDisplay.classList.remove('text-amber-600');
                }
            }
            moveLead(id, s) { 
                // If moving to "Lost", show the reason modal
                if (s === 'Lost') {
                    const lead = this.store.state.find(l => l.id === id);
                    if (lead && lead.status !== 'Lost') {
                        this.showLostReasonModal(id);
                        return;
                    }
                } else {
                    // If moving away from "Lost", clear the lostReason
                    const lead = this.store.state.find(l => l.id === id);
                    if (lead && lead.status === 'Lost') {
                        this.store.update(id, { status: s, lostReason: '' }, this.currentUser);
                        return;
                    }
                }
                this.store.updateStatus(id, s, this.currentUser); 
            }
            deleteLead(id) { 
                if(this.currentUser.role==='agent') return this.notify('Access Denied', 'error');
                if(confirm('Delete?')) this.store.delete(id, this.currentUser); 
            }
            editLead(id, tab) {
                const lead = this.store.state.find(l => l.id === id);
                if (!lead) return;
                // Fill modal form fields
                document.getElementById('leadIdInput').value = lead.id;
                document.getElementById('modalTitle').textContent = 'Edit Lead';
                document.getElementById('submitBtn').textContent = 'Update';
                document.getElementById('tab-btn-activity').disabled = false;
                document.getElementById('tab-btn-contact').disabled = false;
                document.getElementById('leadForm').name.value = lead.name || '';
                document.getElementById('leadForm').interest.value = lead.interest || '';
                document.getElementById('leadForm').value.value = lead.value || '';
                document.getElementById('leadForm').status.value = lead.status || '';
                document.getElementById('leadForm').temperature.value = lead.temperature || '';
                document.getElementById('leadForm').email.value = lead.email || '';
                document.getElementById('leadForm').location.value = lead.location || '';
                document.getElementById('leadForm').source.value = lead.source || '';
                // Assigned To select
                this.populateAssignedToDropdown();
                const assignedToSelect = document.getElementById('assignedToSelect');
                if (assignedToSelect) assignedToSelect.value = lead.assignedTo || '';
                // Phone split
                let phone = lead.phone || '';
                let prefix = '+91', number = '';
                if (phone.startsWith('+')) {
                    const parts = phone.split(' ');
                    prefix = parts[0];
                    number = parts.slice(1).join(' ');
                } else if (phone) {
                    number = phone;
                }
                document.getElementById('leadForm').phonePrefix.value = prefix;
                document.getElementById('leadForm').phone.value = number;
                document.getElementById('leadForm').notes.value = lead.notes || '';
                // Interests tags
                this.selectedInterests = (lead.interest || '').split(',').filter(x=>x.trim()).map(i=>({name:i.trim(),value:0}));
                this.renderInterestTags();
                // Show lost reason if status is "Lost"
                const lostReasonDisplay = document.getElementById('lostReasonDisplay');
                const lostReasonText = document.getElementById('lostReasonText');
                if (lead.status === 'Lost' && lead.lostReason) {
                    lostReasonDisplay.classList.remove('hidden');
                    lostReasonText.textContent = lead.lostReason;
                } else {
                    lostReasonDisplay.classList.add('hidden');
                }
                // Show modal
                ui.toggleModal(true);
                // Switch tab if specified
                if (tab) this.switchModalTab(tab);
            }
            
            render(leads) {
                // Filter for agent/user: only show assigned leads
                let filteredLeads = leads;
                if (this.currentUser && (this.currentUser.role === 'agent' || this.currentUser.role === 'user')) {
                    filteredLeads = leads.filter(lead => lead.assignedTo === this.currentUser.username || lead.assignedTo === this.currentUser.id);
                }
                if (this.activeView === 'table') { this.renderTable(filteredLeads); this.renderLeaderboard(); return; }
                const b = document.getElementById('boardContainer'); b.innerHTML = '';
                this.statusConfig.forEach(s => {
                    const sl = filteredLeads.filter(l => l.status === s.id);
                    const sum = sl.reduce((a,c) => a + (c.value||0), 0);
                    const hide = this.activeMobileTab !== s.id ? 'hidden md:flex' : 'flex';
                    b.innerHTML += `
                        <div class="kanban-column ${hide} flex-col h-full w-full md:w-80 md:bg-slate-100 md:rounded-xl md:border md:border-slate-200 overflow-hidden shrink-0">
                            <div class="px-4 py-3 md:bg-white md:border-b md:border-slate-200 flex justify-between items-center shrink-0">
                                <div class="flex items-center gap-2"><div class="w-2.5 h-2.5 rounded-full ${s.color}"></div><h2 class="font-bold text-slate-700">${s.id}</h2></div>
                                <span class="bg-slate-200 text-slate-600 text-xs font-bold px-2 py-0.5 rounded-full">${sl.length}</span>
                            </div>
                            <div class="flex-1 overflow-y-auto p-3 space-y-3 overscroll-contain">
                                ${sl.length===0 ? '<div class="flex flex-col items-center justify-center h-48 text-slate-400 opacity-60"><i class="ph-duotone ph-ghost text-4xl mb-2"></i><p class="text-sm">Empty</p></div>' : sl.map(l => this.createCardHTML(l)).join('')}
                                <div class="h-20 md:hidden"></div>
                            </div>
                            <div class="bg-white/50 border-t border-slate-200 p-2 text-center text-xs text-slate-500 font-medium">Total: ${this.formatCurrency(sum)}</div>
                        </div>`;
                });
                this.renderLeaderboard();
                // Initialize swipe gestures on mobile
                if (window.innerWidth < 768) {
                    this.initMobileSwipeGestures();
                }
            }

            initMobileSwipeGestures() {
                const boardContainer = document.getElementById('boardContainer');
                if (!boardContainer) return;
                
                let touchStartX = 0;
                let touchEndX = 0;
                
                const handleSwipe = () => {
                    const diff = touchStartX - touchEndX;
                    const threshold = 50;
                    
                    if (Math.abs(diff) < threshold) return;
                    
                    const currentIdx = this.statusConfig.findIndex(s => s.id === this.activeMobileTab);
                    let nextIdx = currentIdx;
                    
                    if (diff > 0) { // Swiped left - go to next column
                        nextIdx = (currentIdx + 1) % this.statusConfig.length;
                    } else { // Swiped right - go to previous column
                        nextIdx = (currentIdx - 1 + this.statusConfig.length) % this.statusConfig.length;
                    }
                    
                    this.activeMobileTab = this.statusConfig[nextIdx].id;
                    this.render(this.store.state);
                    ui.updateKanbanTabs();
                };
                
                boardContainer.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, false);
                boardContainer.addEventListener('touchend', (e) => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); }, false);
                
                // Initialize card swipe gestures
                this.initCardSwipeGestures();
            }
            
            initCardSwipeGestures() {
                const cards = document.querySelectorAll('.card-swipe-container');
                cards.forEach(card => {
                    let touchStartX = 0;
                    let touchStartY = 0;
                    
                    card.addEventListener('touchstart', (e) => {
                        touchStartX = e.changedTouches[0].screenX;
                        touchStartY = e.changedTouches[0].screenY;
                    }, false);
                    
                    card.addEventListener('touchend', (e) => {
                        const touchEndX = e.changedTouches[0].screenX;
                        const touchEndY = e.changedTouches[0].screenY;
                        const diffX = touchStartX - touchEndX;
                        const diffY = Math.abs(touchStartY - touchEndY);
                        const threshold = 50;
                        
                        // Only process horizontal swipes (vertical movement < horizontal)
                        if (Math.abs(diffX) < threshold || diffY > diffX) return;
                        
                        const leadId = card.dataset.leadId;
                        const lead = this.store.state.find(l => l.id === leadId);
                        if (!lead) return;
                        
                        const cardDiv = card.querySelector('div');
                        if (diffX > 0) { // Swiped left - DELETE
                            cardDiv.classList.add('card-swipe-left');
                            setTimeout(() => {
                                this.deleteLead(leadId);
                            }, 300);
                        } else { // Swiped right - EDIT
                            cardDiv.classList.add('card-swipe-right');
                            setTimeout(() => {
                                this.editLead(leadId);
                            }, 300);
                        }
                    }, false);
                });
            }

            generateReportData() {
                const leads = this.store.state;
                const totalLeads = leads.length;
                const totalValue = leads.reduce((sum, l) => sum + (l.value || 0), 0);
                const wonLeads = leads.filter(l => l.status === 'Won').length;
                const conversionRate = totalLeads > 0 ? ((wonLeads / totalLeads) * 100).toFixed(1) : 0;
                
                // Pipeline breakdown
                const pipelineData = {};
                this.statusConfig.forEach(s => {
                    pipelineData[s.id] = leads.filter(l => l.status === s.id).length;
                });
                
                // Lost reasons breakdown
                const lostLeads = leads.filter(l => l.status === 'Lost');
                const lostReasonsData = {};
                lostLeads.forEach(l => {
                    const reason = l.lostReason || 'Unknown';
                    lostReasonsData[reason] = (lostReasonsData[reason] || 0) + 1;
                });
                
                // Temperature distribution
                const temperatureData = { Hot: 0, Warm: 0, Cold: 0, 'Not Set': 0 };
                leads.forEach(l => {
                    const temp = l.temperature || 'Not Set';
                    if (temperatureData.hasOwnProperty(temp)) temperatureData[temp]++;
                    else temperatureData['Not Set']++;
                });
                
                // Agent performance
                const agentData = {};
                this.store.users.filter(u => u.role === 'agent' || u.role === 'admin').forEach(user => {
                    const userKey = user.username || user.id;
                    const assigned = leads.filter(l => l.assignedTo === userKey).length;
                    const won = leads.filter(l => l.assignedTo === userKey && l.status === 'Won').length;
                    const lost = leads.filter(l => l.assignedTo === userKey && l.status === 'Lost').length;
                    const winRate = assigned > 0 ? ((won / assigned) * 100).toFixed(1) : 0;
                    agentData[userKey] = { name: user.name, assigned, won, lost, winRate };
                });
                
                return { totalLeads, totalValue, conversionRate, wonLeads, pipelineData, lostReasonsData, temperatureData, agentData };
            }

            renderReports() {
                const data = this.generateReportData();
                this.renderReportKPIs(data);
                this.renderPipelineFunnelChart(data);
                this.renderLostReasonsChart(data);
                this.renderTemperatureChart(data);
                this.renderAgentLeaderboard(data);
            }

            renderReportKPIs(data) {
                const kpiContainer = document.getElementById('kpiCardsContainer');
                kpiContainer.innerHTML = `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 text-sm font-medium">Total Leads</p>
                                <p class="text-3xl font-bold text-slate-800 mt-1">${data.totalLeads}</p>
                            </div>
                            <i class="ph-bold ph-users text-4xl text-blue-500 opacity-20"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 text-sm font-medium">Pipeline Value</p>
                                <p class="text-3xl font-bold text-slate-800 mt-1">${this.formatCurrency(data.totalValue)}</p>
                            </div>
                            <i class="ph-bold ph-currency-inr text-4xl text-green-500 opacity-20"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 text-sm font-medium">Conversion Rate</p>
                                <p class="text-3xl font-bold text-slate-800 mt-1">${data.conversionRate}%</p>
                            </div>
                            <i class="ph-bold ph-trend-up text-4xl text-purple-500 opacity-20"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 text-sm font-medium">Won Deals</p>
                                <p class="text-3xl font-bold text-slate-800 mt-1">${data.wonLeads}</p>
                            </div>
                            <i class="ph-bold ph-trophy text-4xl text-amber-500 opacity-20"></i>
                        </div>
                    </div>
                `;
            }

            renderPipelineFunnelChart(data) {
                const ctx = document.getElementById('pipelineFunnelChart');
                if (!ctx) return;
                
                const labels = this.statusConfig.map(s => s.id);
                const values = labels.map(label => data.pipelineData[label] || 0);
                const colors = this.statusConfig.map(s => s.color.replace('bg-', '').split('-')[0]);
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Leads by Status',
                            data: values,
                            backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#ef4444'],
                            borderRadius: 6,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }

            renderLostReasonsChart(data) {
                const ctx = document.getElementById('lostReasonsChart');
                if (!ctx) return;
                
                const reasons = Object.keys(data.lostReasonsData);
                const values = Object.values(data.lostReasonsData);
                const colors = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#06b6d4'];
                
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: reasons,
                        datasets: [{
                            data: values,
                            backgroundColor: colors.slice(0, reasons.length),
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 } } }
                        }
                    }
                });
            }

            renderTemperatureChart(data) {
                const ctx = document.getElementById('temperatureChart');
                if (!ctx) return;
                
                const labels = ['Hot', 'Warm', 'Cold', 'Not Set'];
                const values = labels.map(label => data.temperatureData[label] || 0);
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Lead Count',
                            data: values,
                            backgroundColor: ['#ef4444', '#f97316', '#3b82f6', '#9ca3af'],
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        indexAxis: 'x',
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }

            renderAgentLeaderboard(data) {
                const tbody = document.getElementById('agentLeaderboardBody');
                tbody.innerHTML = Object.entries(data.agentData).map(([key, agent]) => `
                    <tr>
                        <td class="py-3 px-4 font-semibold text-slate-800">${agent.name}</td>
                        <td class="py-3 px-4 text-right">${agent.assigned}</td>
                        <td class="py-3 px-4 text-right"><span class="bg-green-100 text-green-700 text-sm font-bold px-2 py-1 rounded">${agent.won}</span></td>
                        <td class="py-3 px-4 text-right"><span class="bg-red-100 text-red-700 text-sm font-bold px-2 py-1 rounded">${agent.lost}</span></td>
                        <td class="py-3 px-4 text-right"><span class="bg-blue-100 text-blue-700 text-sm font-bold px-2 py-1 rounded">${agent.winRate}%</span></td>
                    </tr>
                `).join('');
            }            createCardHTML(lead) {
                                const scores = this.getLeadScores(lead);
                const idx = this.statusConfig.findIndex(s => s.id === lead.status);
                const prev = idx > 0 ? this.statusConfig[idx-1].id : null;
                const next = idx < this.statusConfig.length-1 ? this.statusConfig[idx+1].id : null;
                const delBtn = (this.currentUser.role==='admin' || this.currentUser.role==='superuser') ? `<button onclick="event.stopPropagation(); app.deleteLead('${lead.id}')" class="text-slate-300 hover:text-red-500 p-2 rounded-full active:bg-red-50"><i class="ph-bold ph-trash"></i></button>` : '';
                
                // Check for missing pending task on active leads
                const isActiveStage = !['Won', 'Lost'].includes(lead.status);
                const hasPendingTask = lead.tasks && lead.tasks.some(t => t.status === 'pending');
                const showTaskWarning = isActiveStage && !hasPendingTask;
                
                const rawPhone = lead.phone || '';
                let displayPhone = rawPhone;
                if (rawPhone && !rawPhone.includes('+')) displayPhone = '+91 ' + rawPhone; 
                
                const interests = lead.interest ? lead.interest.split(',').map(i => i.trim()) : [];
                const interestHTML = interests.length > 0 ? 
                    `<div class="flex flex-wrap gap-1 mb-2">${interests.slice(0, 2).map(i => `<span class="text-[10px] font-bold text-primary bg-primary/10 px-1.5 py-0.5 rounded border border-primary/20">${this.escapeHtml(i)}</span>`).join('')}${interests.length > 2 ? `<span class="text-[10px] text-slate-400">+${interests.length - 2}</span>` : ''}</div>` : '';

                return `
                    <div class="card-swipe-container" data-lead-id="${lead.id}">
                        <div onclick="app.editLead('${lead.id}')" class="bg-white p-4 rounded-xl shadow-sm border ${showTaskWarning ? 'border-red-300 bg-red-50/30' : 'border-slate-100'} active:scale-[0.99] transition-transform cursor-pointer ${lead.status === 'Lost' ? 'grayscale opacity-60' : ''}">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-slate-800 line-clamp-1 text-lg">${this.escapeHtml(lead.name)}</h3>
                                <div class="flex gap-1 -mr-2 -mt-2">${showTaskWarning ? `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700 whitespace-nowrap"><i class="ph-bold ph-warning"></i> No Action</span>` : ''}${delBtn}</div>
                            </div>
                            ${lead.assignedTo ? `<div class="text-xs font-semibold text-primary bg-primary/10 px-2 py-1 rounded mb-2 w-fit">${this.escapeHtml(this.getUserName(lead.assignedTo))}</div>` : ''}
                            <div class="flex items-center gap-2 mb-2">
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-bold ${scores.tempColor}"><i class="ph-bold ${scores.tempIcon}"></i> ${scores.temp || 'Not Set'}</span>
                            </div>
                            ${interestHTML}
                            <div class="text-slate-500 font-medium text-sm mb-3">${this.formatCurrency(lead.value)}</div>
                            <div class="flex flex-wrap gap-2 mb-3">
                                <button onclick="event.stopPropagation(); app.editLead('${lead.id}', 'activity')" class="inline-flex items-center gap-1.5 px-2.5 py-1.5 bg-indigo-50 text-indigo-600 text-xs rounded-lg border border-indigo-100 active:bg-indigo-100 font-medium transition-colors"><i class="ph-bold ph-chat"></i> Activity</button>
                                <button onclick="event.stopPropagation(); app.editLead('${lead.id}', 'task')" class="inline-flex items-center gap-1.5 px-2.5 py-1.5 ${showTaskWarning ? 'bg-red-100 text-red-600 border-red-200' : 'bg-amber-50 text-amber-600 border-amber-100'} text-xs rounded-lg border active:bg-opacity-75 font-medium transition-colors"><i class="ph-bold ph-plus"></i> Task</button>
                                ${lead.phone ? `<a href="tel:${lead.phone.replace(/\s+/g,'')}" onclick="event.stopPropagation()" class="inline-flex items-center gap-1.5 px-2.5 py-1.5 bg-slate-50 text-slate-600 text-xs rounded-lg border border-slate-200 active:bg-slate-200"><i class="ph-fill ph-phone"></i> Call</a><a href="https://wa.me/${lead.phone.replace(/\D/g,'')}" target="_blank" onclick="event.stopPropagation()" class="inline-flex items-center gap-1.5 px-2.5 py-1.5 bg-slate-50 text-slate-600 text-xs rounded-lg border border-slate-200 active:bg-slate-200 hover:text-green-600 hover:bg-green-50 hover:border-green-200 transition-colors"><i class="ph-fill ph-whatsapp-logo text-green-600"></i> WhatsApp</a>` : ''}
                            </div>
                            ${lead.notes ? `<div class="text-xs text-slate-500 bg-slate-50 p-2 rounded-lg mb-3 line-clamp-2">${this.escapeHtml(lead.notes)}</div>` : ''}
                            <div class="flex gap-2 mt-2 pt-2 border-t border-slate-50">
                                ${prev ? `<button onclick="event.stopPropagation(); app.moveLead('${lead.id}', '${prev}')" class="flex-1 py-2 bg-slate-100 text-slate-600 rounded-lg text-sm font-semibold hover:bg-slate-200 transition"><i class="ph-bold ph-arrow-left"></i></button>` : '<div class="flex-1"></div>'}
                                ${next ? `<button onclick="event.stopPropagation(); app.moveLead('${lead.id}', '${next}')" class="flex-1 py-2 bg-primary/10 text-primary rounded-lg text-sm font-semibold hover:bg-primary/20 transition"><i class="ph-bold ph-arrow-right"></i></button>` : '<div class="flex-1"></div>'}
                            </div>
                        </div>
                    </div>`;
            }

            renderFollowUps() {
                const today = new Date().toISOString().split('T')[0];
                let od=[], td=[], uc=[];
                // Filter for agent/user: only show follow-ups for assigned leads
                let leads = this.store.state;
                if (this.currentUser && (this.currentUser.role === 'agent' || this.currentUser.role === 'user')) {
                    leads = leads.filter(lead => lead.assignedTo === this.currentUser.username || lead.assignedTo === this.currentUser.id);
                }
                leads.forEach(l => {
                    const f = l.activities?.find(a => a.type==='follow_up');
                    if(f && f.note) {
                        const d = { ...l, followUpDate: f.note };
                        if(f.note < today) od.push(d); else if(f.note === today) td.push(d); else uc.push(d);
                    }
                });
                const ri = (l) => `<button onclick="app.openLeadFromMenu('${l.id}')" class="w-full text-left px-4 py-3 hover:bg-slate-50 flex justify-between items-center group"><div><div class="font-bold text-slate-700 text-sm group-hover:text-primary">${this.escapeHtml(l.name)}</div><div class="text-xs text-slate-400 mt-0.5">${l.followUpDate}</div></div><i class="ph-bold ph-caret-right text-slate-300"></i></button>`;
                document.getElementById('count-overdue').textContent = od.length; document.getElementById('list-overdue').innerHTML = od.map(ri).join('');
                document.getElementById('count-today').textContent = td.length; document.getElementById('list-today').innerHTML = td.map(ri).join('');
                document.getElementById('count-upcoming').textContent = uc.length; document.getElementById('list-upcoming').innerHTML = uc.map(ri).join('');
            }

            renderLogs() {
                const c = document.getElementById('logsContainer');
                if(this.store.logs.length === 0) return c.innerHTML = '<div class="p-8 text-center text-slate-400"><p class="text-sm">No logs</p></div>';
                c.innerHTML = this.store.logs.map(l => `<div class="px-6 py-4 flex gap-3 hover:bg-white"><div class="flex-col pt-1"><div class="w-2 h-2 rounded-full bg-slate-300"></div></div><div><div class="text-xs text-slate-400 mb-0.5">${new Date(l.timestamp).toLocaleString()}</div><div class="text-sm text-slate-700 font-medium">${this.escapeHtml(l.message)}</div></div></div>`).join('');
            }

            switchModalTab(t) {
                this.currentModalTab = t;
                ['info','activity','task','contact'].forEach(x => {
                    document.getElementById(`tab-btn-${x}`).className = x===t ? 'tab-active pb-3 font-semibold text-sm transition-colors whitespace-nowrap' : 'tab-inactive pb-3 font-semibold text-sm transition-colors whitespace-nowrap';
                    document.getElementById(`view-${x}`).classList.toggle('hidden', x!==t);
                    if(document.getElementById(`footer-${x}`)) document.getElementById(`footer-${x}`).classList.toggle('hidden', x!==t);
                });
                // Render content for activity/contact tabs
                const leadId = document.getElementById('leadIdInput').value;
                const lead = this.store.state.find(l => l.id === leadId);
                if (t === 'activity' && lead) this.renderTimeline(lead);
                if (t === 'task' && lead) this.renderTaskView(lead);
                if (t === 'contact' && lead) this.renderContactView(lead);
            }

            renderContactView(lead) {
                const c = document.getElementById('contactActions');
                if(!lead.phone) return c.innerHTML = '<div class="text-center text-slate-400"><p>No Phone</p></div>';
                const phoneStr = String(lead.phone || '');
                const cp = phoneStr.replace(/\D/g, '');
                c.innerHTML = `
                    <a href="tel:+91${cp}" class="w-full bg-green-500 text-white rounded-2xl py-6 flex flex-col items-center justify-center gap-2 shadow-lg active:scale-95 transition"><i class="ph-fill ph-phone text-4xl"></i><span class="text-xl font-bold">Call</span><span class="text-sm opacity-90">${phoneStr}</span></a>
                    <a href="https://wa.me/91${cp}" target="_blank" class="w-full bg-[#25D366] text-white rounded-2xl py-6 flex flex-col items-center justify-center gap-2 shadow-lg active:scale-95 transition"><i class="ph-fill ph-whatsapp-logo text-4xl"></i><span class="text-xl font-bold">WhatsApp</span><span class="text-sm opacity-90">Open Chat</span></a>`;
            }

            renderTaskView(lead) {
                const t = document.getElementById('taskList');
                if(!lead.tasks || lead.tasks.length === 0) {
                    return t.innerHTML = '<div class="text-center text-slate-400 py-8"><p>No tasks yet</p></div>';
                }
                t.innerHTML = lead.tasks.map((task, i) => `
                    <div onclick="app.openTaskDetail('${lead.id}', ${i})" class="bg-slate-50 border border-slate-200 rounded-xl p-3 flex items-center justify-between gap-3 cursor-pointer hover:bg-slate-100 transition">
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-slate-700 break-words">${this.escapeHtml(task.title)}</p>
                            ${task.note ? `<p class="text-xs text-slate-600 mt-1 break-words">${this.escapeHtml(task.note)}</p>` : ''}
                            <div class="flex gap-3 items-center mt-2 text-xs text-slate-500">
                                <span class="px-2 py-1 rounded-full ${task.status === 'completed' ? 'bg-green-100 text-green-700' : task.status === 'dropped' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'} font-medium">${task.status || 'pending'}</span>
                                <span>${task.dueDate ? new Date(task.dueDate).toLocaleDateString('en-IN') : ''}</span>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); app.deleteTask('${lead.id}', ${i})" class="text-slate-400 hover:text-red-500 transition p-1 shrink-0" title="Delete task"><i class="ph ph-trash text-lg"></i></button>
                    </div>
                `).join('');
            }

            openTaskDetail(leadId, taskIndex) {
                this.currentEditingTask = { leadId, taskIndex };
                const lead = this.store.state.find(l => l.id === leadId);
                if(!lead || !lead.tasks || !lead.tasks[taskIndex]) return;
                const task = lead.tasks[taskIndex];
                document.getElementById('taskDetailTitle').textContent = this.escapeHtml(task.title);
                document.getElementById('taskDetailInfo').innerHTML = `
                    <div><strong>Status:</strong> ${task.status || 'pending'}</div>
                    <div><strong>Due Date:</strong> ${task.dueDate ? new Date(task.dueDate).toLocaleDateString('en-IN') : 'No due date'}</div>
                `;
                document.getElementById('taskNoteBox').value = task.note || '';
                document.getElementById('taskDetailForm').classList.remove('hidden');
            }

            closeTaskDetail() {
                document.getElementById('taskDetailForm').classList.add('hidden');
                this.currentEditingTask = null;
            }

            updateTaskStatus(status) {
                if(!this.currentEditingTask) return;
                const noteBox = document.getElementById('taskNoteBox');
                const note = noteBox.value.trim();
                
                // Make note mandatory for completed/dropped tasks
                if(!note) {
                    this.notify('Please add a note before completing or dropping the task', 'error');
                    return;
                }
                
                const { leadId, taskIndex } = this.currentEditingTask;
                const lead = this.store.state.find(l => l.id === leadId);
                if(lead && lead.tasks && lead.tasks[taskIndex]) {
                    const taskTitle = lead.tasks[taskIndex].title;
                    lead.tasks[taskIndex].status = status;
                    lead.tasks[taskIndex].note = note;
                    lead.tasks[taskIndex].completedAt = new Date().toISOString();
                    
                    // Add activity log
                    this.store.addActivity(leadId, { type: 'task', note: `Task ${status}: ${taskTitle} - ${note}` }, this.currentUser);
                    
                    // Remove associated follow-up activity
                    if(lead.activities) {
                        lead.activities = lead.activities.filter(a => !(a.type === 'follow_up' && a.note === lead.tasks[taskIndex].dueDate));
                    }
                    
                    this.store.save();
                    this.renderTaskView(lead);
                    this.renderTimeline(lead);
                    this.closeTaskDetail();
                }
            }

            saveTaskNote() {
                if(!this.currentEditingTask) return;
                const { leadId, taskIndex } = this.currentEditingTask;
                const lead = this.store.state.find(l => l.id === leadId);
                if(lead && lead.tasks && lead.tasks[taskIndex]) {
                    lead.tasks[taskIndex].note = document.getElementById('taskNoteBox').value;
                    this.store.save();
                    this.renderTaskView(lead);
                    this.closeTaskDetail();
                }
            }

            deleteTask(leadId, taskIndex) {
                const lead = this.store.state.find(l => l.id === leadId);
                if(lead && lead.tasks) {
                    lead.tasks.splice(taskIndex, 1);
                    this.store.save();
                    this.renderTaskView(lead);
                }
            }

            handleTypeChange(s) {
                const t = document.getElementById('activityInputText'), d = document.getElementById('activityInputDate'), f = document.getElementById('activityInputFile');
                t.classList.add('hidden'); d.classList.add('hidden'); f.classList.add('hidden');
                t.required = false; d.required = false;
                if(s.value==='follow_up') { d.classList.remove('hidden'); d.required = true; }
                else if(s.value==='file') { f.classList.remove('hidden'); }
                else { t.classList.remove('hidden'); t.required = true; }
            }

            openLeadFromMenu(id) { ui.toggleMenu(false); setTimeout(() => this.editLead(id, 'activity'), 150); }
            formatCurrency(v) { return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(v||0); }
            escapeHtml(s) { if(!s) return ''; return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        }

        const ui = {
                                    toggleNotificationBox: () => {
                                        const box = document.getElementById('notificationBox');
                                        if (box) {
                                            box.classList.toggle('hidden');
                                            if (!box.classList.contains('hidden')) {
                                                app.loadNotifications();
                                            }
                                        }
                                    },
                                    updateNotificationBadge: () => {
                                        const count = document.getElementById('notificationCount');
                                        if (app._notifications && app._notifications.length > 0) {
                                            count.textContent = app._notifications.length;
                                            count.style.display = '';
                                        } else {
                                            count.style.display = 'none';
                                        }
                                    },
                                    updateMobileNav: () => {
                                        const currentView = app.currentView || 'kanban';
                                        ['kanban', 'table', 'reports'].forEach(view => {
                                            const btn = document.getElementById(`nav${view.charAt(0).toUpperCase() + view.slice(1)}`);
                                            if (btn) btn.classList.toggle('active', view === currentView);
                                        });
                                    },
                                    updateKanbanTabs: () => {
                                        const container = document.getElementById('mobileTabs');
                                        if (!container) return;
                                        const tabs = app.statusConfig.map(s => {
                                            const isActive = s.id === app.activeMobileTab ? 'active' : '';
                                            return `<button onclick="app.activeMobileTab='${s.id}'; app.render(app.store.state)" class="mobile-tab-btn ${isActive}">${s.id}</button>`;
                                        }).join('');
                                        container.innerHTML = tabs;
                                    },
                        hideNotification: () => {
                            const tray = document.getElementById('notificationTray');
                            tray.classList.add('opacity-0', 'pointer-events-none');
                            tray.classList.remove('opacity-100');
                        },
            toggleModal: (s) => { 
                const m = document.getElementById('leadModal'); 
                if(s) { 
                    if(!document.getElementById('leadIdInput').value) { 
                        document.getElementById('modalTitle').textContent='New Lead'; 
                        document.getElementById('submitBtn').textContent='Save'; 
                        // Call App method safely
                        if (window.app && typeof window.app.switchModalTab === 'function') {
                             window.app.switchModalTab('info');
                             window.app.selectedInterests = []; 
                             window.app.renderInterestTags();
                        }
                        document.getElementById('tab-btn-activity').disabled=true; 
                        document.getElementById('tab-btn-contact').disabled=true; 
                    } 
                    m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('open')); 
                    // Add swipe-down handler for mobile
                    if (window.innerWidth < 768) {
                        ui.initModalSwipeClose(m);
                    }
                } else { 
                    m.classList.remove('open'); 
                    setTimeout(()=>{m.classList.add('hidden'); document.getElementById('leadForm').reset(); document.getElementById('leadIdInput').value='';},300); 
                } 
            },
            initModalSwipeClose: (modal) => {
                if (!modal) return;
                const content = modal.querySelector('.modal-content');
                if (!content) return;
                
                let touchStartY = 0;
                let touchEndY = 0;
                
                const handleSwipeDown = () => {
                    const diff = touchEndY - touchStartY;
                    if (diff > 80) { // Swiped down more than 80px
                        ui.toggleModal(false);
                    }
                };
                
                // Remove previous listeners to avoid duplicates
                content.replaceWith(content.cloneNode(true));
                const newContent = modal.querySelector('.modal-content');
                
                newContent.addEventListener('touchstart', (e) => { touchStartY = e.changedTouches[0].screenY; }, false);
                newContent.addEventListener('touchend', (e) => { touchEndY = e.changedTouches[0].screenY; handleSwipeDown(); }, false);
            },
            toggleMenu: (s) => { const m = document.getElementById('sideMenu'); if(s) { try { window.app.renderFollowUps(); } catch(e){} m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('open')); } else { m.classList.remove('open'); setTimeout(()=>m.classList.add('hidden'),300); } },
            toggleLogs: (s) => { const m = document.getElementById('logsModal'); if(s) { try { window.app.renderLogs(); } catch(e){} m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('open')); } else { m.classList.remove('open'); setTimeout(()=>m.classList.add('hidden'),300); } },
            toggleConfig: (s) => { const m = document.getElementById('configModal'); if(s) { try { window.app.renderUserList(); } catch(e){} m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('open')); } else { m.classList.remove('open'); setTimeout(()=>m.classList.add('hidden'),300); } },
            showLoading: (s) => { const l = document.getElementById('loadingOverlay'); if(s) l.classList.remove('hidden'); else l.classList.add('hidden'); }
        };

        // Explictly attach to window
        window.app = new App();
        
        // Always update login card/app title on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.app && typeof window.app.applyConfig === 'function') {
                window.app.applyConfig();
            }
            if (window.app && typeof window.app.startAutoSync === 'function') {
                window.app.startAutoSync();
            }
            if (window.app && typeof window.app.renderLeaderboard === 'function') {
                window.app.renderLeaderboard();
            }
        });
    </script>
</body>
</html>